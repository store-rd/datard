<!DOCTYPE html>
<html lang="ar" class="no-js" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙØ§Ø¦Ù‚Ø© Ø§Ù„Ø³Ø±Ø¹Ø©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Changa:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- CSS Styles remain largely the same as the previous optimized version --- */
        /* (Ø¶Ø¹ Ù‡Ù†Ø§ ÙƒÙ„ ÙƒÙˆØ¯ CSS Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©) */
         :root {
            --primary: #e74c3c; /* Stronger Red */
            --secondary: #f1c40f; /* Yellow */
            --accent: #3498db; /* Blue */
            --info: #2ecc71; /* Green for Edit/Save */
            --info-hover: #27ae60;
            --danger: #e74c3c; /* Consistent Red */
            --danger-hover: #c0392b;
            --dark: #34495e; /* Dark Blue/Grey */
            --light: #ecf0f1; /* Light Grey */
            --grey-light: #f8f9fa;
            --grey-dark: #bdc3c7; /* Lighter Grey */
            --offline-indicator: #f39c12; /* Orange */
            --syncing-indicator: var(--offline-indicator); /* Use same color for syncing dot */
            --connecting-indicator: #adb5bd; /* Grey for connecting dot */
            --timestamp-color: #7f8c8d; /* Grey for timestamps */
            --shadow-color: rgba(0, 0, 0, 0.08); /* Softer shadow */
            --shadow-color-darker: rgba(0, 0, 0, 0.12);
            --font-primary: 'Tajawal', 'Changa', sans-serif;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-primary); background: linear-gradient(135deg, var(--light), #ffffff);
            color: var(--dark); display: flex; height: 100vh; overflow: hidden;
            transition: background-color 0.5s, color 0.5s; font-size: 16px;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }
        body.dark-mode {
            background: linear-gradient(135deg, #34495e, #2c3e50); color: var(--light);
            --shadow-color: rgba(255, 255, 255, 0.06); --shadow-color-darker: rgba(255, 255, 255, 0.1);
            --grey-light: #4a4a4a; --grey-dark: #5a5a5a; --light: #343a40; --dark: #ecf0f1;
            --timestamp-color: #95a5a6;
        }
        .offline-banner {
            position: fixed; top: 0; left: 0; right: 0; background-color: var(--offline-indicator);
            color: white; text-align: center; padding: 6px 10px; font-size: 0.9em; z-index: 2001;
            display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-weight: 700;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .offline-banner.show { display: block; }
        .sidebar {
            width: 340px; min-width: 300px; background: white; height: 100%; display: flex; flex-direction: column;
            border-left: 1px solid #dee2e6; box-shadow: -3px 0 12px var(--shadow-color); z-index: 10;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .dark-mode .sidebar { background: #2c3e50; border-left-color: #495057; box-shadow: -3px 0 12px var(--shadow-color-darker); }
        .sidebar-header {
            padding: 18px 22px; border-bottom: 1px solid #dee2e6; font-size: 1.4em; font-weight: 700;
            color: var(--dark); flex-shrink: 0; position: relative; display: flex; align-items: center; justify-content: space-between;
        }
        .dark-mode .sidebar-header { border-bottom-color: #495057; color: var(--light); }
        .connection-status-dot {
            width: 12px; height: 12px; border-radius: 50%; background-color: var(--connecting-indicator);
            display: inline-block; transition: background-color 0.5s, box-shadow 0.3s; flex-shrink: 0;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .connection-status-dot.connecting { background-color: var(--connecting-indicator); animation: pulse 1.5s infinite ease-in-out; }
        .connection-status-dot.connected { background-color: #2ecc71; border-color: #27ae60; box-shadow: 0 0 5px rgba(46, 204, 113, 0.7); animation: none; }
        .connection-status-dot.syncing { background-color: var(--syncing-indicator); border-color: #d35400; box-shadow: 0 0 5px rgba(243, 156, 18, 0.7); animation: pulse 1s infinite ease-in-out; }
        .connection-status-dot.disconnected { background-color: #e74c3c; border-color: #c0392b; box-shadow: 0 0 5px rgba(231, 76, 60, 0.7); animation: none; }
        .dark-mode .connection-status-dot { border-color: rgba(255,255,255,0.2); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        #items-list { flex-grow: 1; overflow-y: auto; padding: 10px 15px; }
         /* Style for placeholder when list is empty */
         #items-list .empty-list-placeholder { text-align: center; padding: 20px; opacity: 0.7; color: var(--dark); }
         .dark-mode #items-list .empty-list-placeholder { color: var(--light); }

        .item-card {
            padding: 12px; margin-bottom: 12px; background: #ffffff; border: 1px solid #e9ecef;
            border-radius: 8px; cursor: pointer; transition: all 0.2s ease-out; display: flex; align-items: center; gap: 12px;
            position: relative; border-left: 5px solid transparent; will-change: transform, box-shadow, background-color;
        }
        .item-card.has-pending-writes { border-left-color: var(--syncing-indicator); opacity: 0.9; }
        .dark-mode .item-card { background: #34495e; border-color: #495057; }
        .item-card:hover { transform: scale(1.02); box-shadow: 0 5px 15px var(--shadow-color); border-color: #ced4da; z-index: 1; }
        .dark-mode .item-card:hover { background: #495057; border-color: #6c757d; }
        .item-card.selected { background-color: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 3px 10px rgba(52, 152, 219, 0.4); transform: scale(1.01); }
        .item-card.selected.has-pending-writes { border-left-color: var(--syncing-indicator); }
        .dark-mode .item-card.selected { background-color: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 3px 10px rgba(231, 76, 60, 0.4); }
        .dark-mode .item-card.selected.has-pending-writes { border-left-color: var(--syncing-indicator); }
        .item-icon { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid var(--light); box-shadow: 0 1px 3px rgba(0,0,0,0.1); background-color: #eee; }
        .dark-mode .item-icon { border-color: #495057; background-color: #555; }
        .item-card.selected .item-icon { border-color: rgba(255, 255, 255, 0.6); }
        .item-details { flex-grow: 1; overflow: hidden; }
        .item-details h4 { margin: 0 0 4px 0; font-size: 1.1em; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-details p { margin: 0; font-size: 0.9em; opacity: 0.9; white-space: nowrap; color: #555; font-weight: 400; }
        .dark-mode .item-details p { color: #adb5bd; }
        .item-card.selected h4, .item-card.selected p { color: white; opacity: 1; }
        .item-actions { display: flex; gap: 6px; flex-shrink: 0; }
        .item-actions button { background: rgba(0,0,0,0.05); border: none; color: var(--dark); cursor: pointer; padding: 6px; font-size: 1.1em; border-radius: 50%; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .dark-mode .item-actions button { background: rgba(255,255,255,0.1); color: var(--light); }
        .item-card.selected .item-actions button { background: rgba(255,255,255,0.2); color: white; }
        .item-actions button:hover { transform: scale(1.15); }
        .item-actions .edit-btn:hover { background-color: var(--info); color: white; }
        .item-actions .delete-btn:hover { background-color: var(--danger); color: white; }
        .sidebar-footer { padding: 15px 20px; border-top: 1px solid #dee2e6; flex-shrink: 0; background-color: #f8f9fa; }
        .dark-mode .sidebar-footer { border-top-color: #495057; background-color: #212529; }
        #total-price-container { text-align: center; font-weight: 700; margin-bottom: 12px; font-size: 1.15em; }
        .report-btn { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 12px 15px; background-color: var(--dark); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: var(--font-primary); font-size: 1.05em; transition: background-color 0.3s, transform 0.1s; font-weight: 700; }
        .report-btn:hover { background-color: #555; transform: translateY(-1px); }
        .dark-mode .report-btn { background-color: var(--grey-light); color: var(--dark); }
        .dark-mode .report-btn:hover { background-color: var(--grey-dark); }
        .report-btn .icon { font-size: 1.3em; }
        #detail-view-container {
            flex-grow: 1; height: 100%; padding: 35px 40px; overflow-y: auto; position: relative;
            display: flex; align-items: center; justify-content: center; background-color: #ffffff;
        }
        .dark-mode #detail-view-container { background-color: #343a40; }
        .detail-placeholder, .detail-error { text-align: center; padding: 20px; font-size: 1.2em; font-weight: 700; opacity: 0.8; }
        .detail-placeholder { color: #6c757d; }
        .dark-mode .detail-placeholder { color: #adb5bd; }
        .detail-error { color: var(--danger); background-color: rgba(231, 76, 60, 0.1); border: 1px solid var(--danger); border-radius: 8px; }
        .dark-mode .detail-error { background-color: rgba(231, 76, 60, 0.2); }
        .detail-error strong { display: block; margin-bottom: 5px; }
        .detail-content, .edit-form-container {
            background: var(--light); padding: 30px 35px; border-radius: 12px; border: 1px solid #dee2e6;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08); width: 100%; max-width: 550px; animation: fadeIn 0.3s ease-out;
        }
        .dark-mode .detail-content, .dark-mode .edit-form-container { background: #2c3e50; border-color: #495057; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .detail-content h2, .edit-form-container h3 { margin-top: 0; margin-bottom: 25px; color: var(--primary); text-align: center; font-weight: 700; }
        .dark-mode .detail-content h2, .dark-mode .edit-form-container h3 { color: var(--secondary); }
        .detail-content p { margin-bottom: 15px; font-size: 1.1em; line-height: 1.7; }
        .detail-content p strong { color: var(--dark); font-weight: 700; margin-left: 5px; }
        .dark-mode .detail-content p strong { color: var(--light); }
        .detail-content .timestamp { font-size: 0.9em; color: var(--timestamp-color); text-align: center; margin-top: 25px; border-top: 1px dashed var(--grey-dark); padding-top: 15px; line-height: 1.6; }
        .dark-mode .detail-content .timestamp { border-top-color: #495057; }
        .detail-content .history-section {
            font-size: 0.9em; color: var(--timestamp-color); text-align: right;
            margin-top: 25px; border-top: 1px dashed var(--grey-dark); padding-top: 15px;
            line-height: 1.6; max-height: 200px; overflow-y: auto;
            background: rgba(0,0,0,0.02); padding: 10px; border-radius: 6px;
        }
        .dark-mode .detail-content .history-section { border-top-color: #495057; background: rgba(255,255,255,0.04);}
        .history-section h4 { margin-bottom: 10px; color: var(--dark); font-size: 1em; text-align: center; font-weight: 700; }
        .dark-mode .history-section h4 { color: var(--light); }
        .history-section ul { list-style: none; padding: 0; margin: 0; }
        .history-section li { margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.08); }
        .dark-mode .history-section li { border-bottom-color: rgba(255,255,255,0.1); }
        .history-section li:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0;}
        .history-section .history-timestamp { font-weight: 700; color: var(--accent); display: block; margin-bottom: 5px; }
        .dark-mode .history-section .history-timestamp { color: var(--secondary); }
        .history-section .change-detail { display: block; font-size: 0.95em; color: var(--dark); }
        .dark-mode .history-section .change-detail { color: var(--light); }
        .history-section del { opacity: 0.7; text-decoration: line-through; color: var(--danger); }
        .dark-mode .history-section del { color: #ff8a80; }
        .history-section .no-history { text-align: center; opacity: 0.8; padding: 10px 0; }
        .detail-content img.detail-icon { display: block; width: 90px; height: 90px; border-radius: 50%; margin: 0 auto 25px auto; border: 4px solid var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.1); background-color: #eee;}
        .dark-mode .detail-content img.detail-icon { border-color: var(--secondary); background-color: #555;}
        .edit-form-container label { display: block; margin-bottom: 6px; font-weight: 700; font-size: 0.95em; color: #555; }
        .dark-mode .edit-form-container label { color: #ccc; }
        .edit-form-container input, .edit-form-container .image-upload-area { width: 100%; margin-bottom: 18px; }
        .edit-form-container input[type="text"], .edit-form-container input[type="number"] { padding: 14px; border: 1px solid #ced4da; border-radius: 8px; font-family: var(--font-primary); font-size: 1em; transition: border-color 0.2s, box-shadow 0.2s; }
        .edit-form-container input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); outline: none; }
        .dark-mode .edit-form-container input[type="text"], .dark-mode .edit-form-container input[type="number"] { background-color: #495057; border-color: #6c757d; color: var(--light); }
        .dark-mode .edit-form-container input:focus { border-color: var(--secondary); box-shadow: 0 0 0 3px rgba(241, 196, 15, 0.2); }
        .image-upload-area { display: flex; align-items: center; gap: 15px; border: 1px dashed var(--grey-dark); padding: 10px; border-radius: 8px; }
        .image-upload-area input[type="file"] { display: none; }
        .image-upload-area .btn-capture { background-color: var(--accent); color: white; padding: 10px 15px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; font-size: 0.9em; font-weight: 700; text-align: center;}
        .image-upload-area .upload-progress { font-size: 0.85em; margin-right: 10px; color: var(--accent); font-weight: bold; }
        .dark-mode .image-upload-area .upload-progress { color: var(--secondary); }
        .dark-mode .image-upload-area .btn-capture { background-color: var(--secondary); color: var(--dark); }
        .image-upload-area .btn-capture:hover { opacity: 0.9; }
        .image-upload-area img.icon-preview { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--grey-dark); background-color: #eee; flex-shrink: 0; }
        .dark-mode .image-upload-area img.icon-preview { border-color: #555; background-color: #444; }
        .form-buttons { display: flex; gap: 12px; margin-top: 25px; }
        .form-buttons button { flex-grow: 1; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-family: var(--font-primary); font-weight: 700; font-size: 1.05em; transition: all 0.2s ease-out; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .form-buttons button:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; background-color: #adb5bd !important; box-shadow: none !important; }
        .form-buttons .btn-save { background-color: var(--info); color: white; }
        .form-buttons .btn-save:hover:not(:disabled) { background-color: var(--info-hover); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .form-buttons .btn-cancel { background-color: #adb5bd; color: #fff; }
        .form-buttons .btn-cancel:hover { background-color: #6c757d; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1);}
        .dark-mode .form-buttons .btn-save { background-color: var(--accent); color: white; }
        .dark-mode .form-buttons .btn-save:hover:not(:disabled) { background-color: #2980b9; }
        .dark-mode .form-buttons .btn-cancel { background-color: #6c757d; color: white; }
        .dark-mode .form-buttons .btn-cancel:hover { background-color: #5a6268; }
        .modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.65); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; backdrop-filter: blur(5px); }
        .modal.show { opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0s linear 0s; }
        .modal-content { background: white; padding: 35px; border-radius: 15px; width: 90%; max-width: 480px; box-shadow: 0 10px 35px rgba(0,0,0,0.15); position: relative; transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal.show .modal-content { transform: scale(1); }
        .dark-mode .modal-content { background: #34495e; color: var(--light); box-shadow: 0 10px 35px rgba(0,0,0,0.3); }
        .modal-content h3 { margin-top: 0; margin-bottom: 25px; text-align: center; color: var(--primary); font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .dark-mode .modal-content h3 { color: var(--secondary); }
        .modal-content label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 0.95em; color: #555; }
        .dark-mode .modal-content label { color: #ccc; }
        .modal-content input[type="text"], .modal-content input[type="number"] { width: 100%; padding: 14px; margin-bottom: 18px; border: 1px solid #ced4da; border-radius: 8px; font-family: var(--font-primary); font-size: 1em; }
        .dark-mode .modal-content input[type="text"], .dark-mode .modal-content input[type="number"] { background-color: #495057; border-color: #6c757d; color: var(--light); }
        #addFormModal .image-upload-area { margin-bottom: 18px; }
        .close-btn { position: absolute; top: 12px; left: 15px; background: none; border: none; font-size: 2.2em; color: #aaa; cursor: pointer; line-height: 1; padding: 5px; transition: color 0.2s, transform 0.2s; }
        .close-btn:hover { color: var(--danger); transform: rotate(90deg) scale(1.1); }
        .dark-mode .close-btn { color: #777; }
        .dark-mode .close-btn:hover { color: var(--primary); }
        #confirmMessage { font-size: 1.1em; line-height: 1.6; }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #34495e; color: white; padding: 12px 22px; border-radius: 8px; z-index: 2000; font-size: 0.95em; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0s linear 0.4s, bottom 0.4s ease; font-weight: 700; }
        #toast.show { opacity: 1; visibility: visible; bottom: 30px; transition: opacity 0.4s ease, visibility 0s linear 0s, bottom 0.4s ease; }
        #toast.error { background-color: var(--danger); }
        #toast.warning { background-color: var(--offline-indicator); color: #333; }
        #toast.success { background-color: var(--info); }
        .dark-mode #toast { background: #495057; }
        .dark-mode #toast.error { background-color: var(--danger-hover); }
        .dark-mode #toast.warning { background-color: var(--secondary); color: var(--dark); }
        .dark-mode #toast.success { background-color: var(--info-hover); }
        .control-panel { position: fixed; bottom: 25px; left: 25px; display: flex; flex-direction: column; gap: 15px; z-index: 100; }
        .btn-magic { background: var(--accent); border: none; width: 55px; height: 55px; border-radius: 50%; color: white; font-size: 1.8em; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4); display: flex; justify-content: center; align-items: center; }
        .btn-magic:hover { background-color: #2980b9; transform: translateY(-3px) scale(1.05); box-shadow: 0 8px 20px rgba(52, 152, 219, 0.5); }
        .dark-mode .btn-magic { background: var(--secondary); color: var(--dark); box-shadow: 0 5px 15px rgba(241, 196, 15, 0.3); }
        .dark-mode .btn-magic:hover { background: #f39c12; }
        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; height: auto; font-size: 15px; }
            #detail-view-container { order: 1; height: auto; min-height: 40vh; padding: 20px 15px; }
            .detail-content, .edit-form-container { padding: 20px 25px; max-width: none; }
            .sidebar { order: 2; width: 100%; height: auto; min-height: 55vh; border-left: none; border-top: 1px solid #dee2e6; box-shadow: none; }
            .dark-mode .sidebar { border-top-color: #495057; }
            #items-list { max-height: none; padding: 10px; }
            .sidebar-header { padding: 15px; font-size: 1.3em; }
            .sidebar-footer { padding: 15px; }
            .control-panel { bottom: 20px; left: 20px; right: auto; transform: none; flex-direction: column; gap: 12px; background: transparent; box-shadow: none; }
            .btn-magic { width: 50px; height: 50px; font-size: 1.6em; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
            .dark-mode .btn-magic { box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
            #toast { bottom: 90px; width: calc(100% - 30px); left: 15px; transform: none; text-align: center; }
            .modal-content { width: 95%; padding: 25px; }
            .form-buttons { flex-direction: column; }
            .offline-banner { font-size: 0.8em; padding: 4px 8px; }
            .image-upload-area { flex-direction: column; align-items: stretch; text-align: center; }
            .image-upload-area .btn-capture { width: 100%; }
            .image-upload-area img.icon-preview { margin: 10px auto 0; }
            .image-upload-area .upload-progress { text-align: center; width: 100%; margin-top: 5px;} /* Center progress on mobile */
            .detail-content .history-section { max-height: 150px; }
        }
    </style>
</head>
<body>

    <div id="offlineBanner" class="offline-banner">
        âš ï¸ Ø£Ù†Øª ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø³ØªÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆØªÙØ²Ø§Ù…Ù† Ù„Ø§Ø­Ù‚Ø§Ù‹.
    </div>

    <div id="detail-view-container">
        <div class="detail-placeholder" id="main-placeholder">
             ğŸ”„ Ø¬Ø§Ø±Ù ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
             Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
             <span id="connectionStatus" class="connection-status-dot connecting" title="Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„: Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„..."></span>
        </div>
        <div id="items-list">
            <div class="empty-list-placeholder" id="list-placeholder" style="display: none;">
                 Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...
             </div>
        </div>
        <div class="sidebar-footer">
            <div id="total-price-container">
                Ø¥Ø¬Ù…Ø§Ù„ÙŠ : <span id="total-price">0</span> Ø¯.Ø¹
            </div>
            <button class="report-btn" onclick="window.generateReport()" title="ØªÙ†Ø²ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª">
                <span class="icon">ğŸ“„</span> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            </button>
        </div>
    </div>

    <div id="addFormModal" class="modal">
         <div class="modal-content">
             <button class="close-btn" onclick="window.hideAddForm()" title="Ø¥ØºÙ„Ø§Ù‚">&times;</button>
             <h3><span class="icon">ğŸ“¦</span>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
             <label for="itemName">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</label>
             <input type="text" id="itemName" placeholder="Ù…Ø«Ø§Ù„: Ù‚Ù…ÙŠØµ..." required>
             <label for="itemStock">Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
             <input type="number" id="itemStock" placeholder="0" required min="0">
             <label for="itemPrice">Ø§Ù„Ø³Ø¹Ø± (Ø¯.Ø¹):</label>
             <input type="number" id="itemPrice" placeholder="0" required min="0" step="500">
             <label for="itemImageInput">Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
             <div class="image-upload-area">
                 <input type="file" id="itemImageInput" accept="image/*" capture="environment" onchange="window.handleImagePreview(event, 'addIconPreview')">
                 <label for="itemImageInput" class="btn-capture">ğŸ“· Ø§Ø®ØªØ±/Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø©</label>
                 <img id="addIconPreview" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø©" class="icon-preview" style="display: none;">
                  <span id="addUploadProgress" class="upload-progress"></span>
             </div>
             <div class="form-buttons" style="margin-top: 15px;">
                 <button id="addItemBtn" class="btn-save" onclick="window.addItem()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</button>
                 <button class="btn-cancel" onclick="window.hideAddForm()">Ø¥Ù„ØºØ§Ø¡</button>
             </div>
         </div>
    </div>
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="window.hideConfirmModal()" title="Ø¥ØºÙ„Ø§Ù‚">&times;</button>
            <h3><span class="icon">ğŸ—‘ï¸</span>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
            <p id="confirmMessage" style="text-align: center; margin-bottom: 25px; font-size: 1.1em;">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ</p>
            <div class="form-buttons">
                <button id="confirmDeleteBtn" class="btn-save" style="background-color: var(--danger);">âœ”ï¸ Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù</button>
                <button class="btn-cancel" onclick="window.hideConfirmModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
    <div id="toast"></div>
    <div class="control-panel">
        <button class="btn-magic" onclick="window.toggleDarkMode()" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹">ğŸ’¡</button>
        <button class="btn-magic" onclick="window.showAddForm()" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯">â•</button>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import {
            getFirestore, enableIndexedDbPersistence, terminate,
            collection, query, orderBy, onSnapshot, getDocs, limit,
            addDoc, updateDoc, deleteDoc, doc, serverTimestamp,
            getDoc, writeBatch, Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
        // **** Import Firebase Storage SDK ****
        import {
            getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-storage.js";

        // --- Firebase Configuration ---
        // ========================================================================
        // ==== ğŸ”¥ğŸ”¥ğŸ”¥ Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹: Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù…Ø´Ø±ÙˆØ¹Ùƒ ğŸ”¥ğŸ”¥ğŸ”¥ ====
        // ========================================================================
        const firebaseConfig = {
             apiKey: "AIzaSyABUQJfis7wbSn508w1RuGCd6ZsoxMoEEA", // <--- Ø§Ø³ØªØ¨Ø¯Ù„
             authDomain: "storedatabase-642e0.firebaseapp.com", // <--- Ø§Ø³ØªØ¨Ø¯Ù„
             projectId: "storedatabase-642e0", // <--- Ø§Ø³ØªØ¨Ø¯Ù„
             storageBucket: "storedatabase-642e0.firebasestorage.app", // <--- Ø§Ø³ØªØ¨Ø¯Ù„
             messagingSenderId: "806751758744", // <--- Ø§Ø³ØªØ¨Ø¯Ù„
             appId: "1:806751758744:web:079104a8fe4e73cdc023ed", // <--- Ø§Ø³ØªØ¨Ø¯Ù„
             measurementId: "G-778H49MMJK" // <--- Ø§Ø®ØªÙŠØ§Ø±ÙŠ
        };

        // --- Global Variables & State ---
        let app; let db; let storage;
        let unsubscribeSnapshot = null;
        let itemsMap = new Map();
        let currentEditItemId = null; let currentViewItemId = null;
        let isDefinitelyOffline = !navigator.onLine;
        let latestSnapshotMetadata = { fromCache: true, hasPendingWrites: false };
        let firstLoadComplete = false;
        const defaultIcon = 'https://img.icons8.com/fluency/48/000000/hanger.png';
        let capturedImageFile = null; // Store File object
        const HISTORY_LIMIT = 15;

        // --- Keyword to Icon Mapping ---
        const keywordIconMap = { /* ... mapping ... */
             'Ù‚Ù…ÙŠØµ': 'https://img.icons8.com/fluency/48/000000/shirt.png','ØªÙŠØ´ÙŠØ±Øª': 'https://img.icons8.com/fluency/48/000000/t-shirt.png','ØªÙŠ Ø´ÙŠØ±Øª': 'https://img.icons8.com/fluency/48/000000/t-shirt.png','Ø¨ÙˆÙ„Ùˆ': 'https://img.icons8.com/fluency/48/000000/polo-shirt.png','Ø¨Ù†Ø·Ù„ÙˆÙ†': 'https://img.icons8.com/fluency/48/000000/pantaloon.png','Ø¬ÙŠÙ†Ø²': 'https://img.icons8.com/fluency/48/000000/jeans.png','Ø³Ø±ÙˆØ§Ù„': 'https://img.icons8.com/fluency/48/000000/pantaloon.png','Ø´ÙˆØ±Øª': 'https://img.icons8.com/fluency/48/000000/shorts.png','Ø¨Ø±Ù…ÙˆØ¯Ø§': 'https://img.icons8.com/fluency/48/000000/bermuda-shorts.png','ÙØ³ØªØ§Ù†': 'https://img.icons8.com/fluency/48/000000/dress.png','ØªÙ†ÙˆØ±Ø©': 'https://img.icons8.com/fluency/48/000000/skirt.png','Ø¬ÙŠØ¨Ø©': 'https://img.icons8.com/fluency/48/000000/skirt.png','Ø¬Ø§ÙƒÙŠØª': 'https://img.icons8.com/fluency/48/000000/jacket.png','Ø³ØªØ±Ø©': 'https://img.icons8.com/fluency/48/000000/vest.png','Ù…Ø¹Ø·Ù': 'https://img.icons8.com/fluency/48/000000/coat.png','Ø¨Ù„ÙŠØ²Ø±': 'https://img.icons8.com/fluency/48/000000/blazer.png','Ù‡ÙˆØ¯ÙŠ': 'https://img.icons8.com/fluency/48/000000/hoodie.png','ÙƒÙ†Ø²Ø©': 'https://img.icons8.com/fluency/48/000000/sweater.png','Ø¨Ù„ÙˆÙØ±': 'https://img.icons8.com/fluency/48/000000/sweater.png','Ø­Ø°Ø§Ø¡': 'https://img.icons8.com/fluency/48/000000/trainers.png','Ø§Ø­Ø°ÙŠØ©': 'https://img.icons8.com/fluency/48/000000/trainers.png','Ø±ÙŠØ§Ø¶ÙŠ': 'https://img.icons8.com/fluency/48/000000/sneakers.png','Ø¬Ø²Ù…Ø©': 'https://img.icons8.com/fluency/48/000000/boot.png','ÙƒØ¹Ø¨': 'https://img.icons8.com/fluency/48/000000/high-heels.png','ØµÙ†Ø¯Ù„': 'https://img.icons8.com/fluency/48/000000/sandal.png','Ø´Ø¨Ø´Ø¨': 'https://img.icons8.com/fluency/48/000000/slippers.png','Ù…Ù„Ø§Ø¨Ø³ Ø¯Ø§Ø®Ù„ÙŠØ©': 'https://img.icons8.com/fluency/48/000000/underwear.png','Ø¯Ø§Ø®Ù„ÙŠ': 'https://img.icons8.com/fluency/48/000000/underwear.png','Ø¨Ø¯ÙŠ': 'https://img.icons8.com/fluency/48/000000/bodysuit.png','Ø¨ÙŠØ¬Ø§Ù…Ø©': 'https://img.icons8.com/fluency/48/000000/pajamas.png','Ù‚Ø¨Ø¹Ø©': 'https://img.icons8.com/fluency/48/000000/baseball-cap.png','Ø·Ø§Ù‚ÙŠØ©': 'https://img.icons8.com/fluency/48/000000/winter-hat.png','ÙƒØ§Ø¨': 'https://img.icons8.com/fluency/48/000000/baseball-cap.png','ÙˆØ´Ø§Ø­': 'https://img.icons8.com/fluency/48/000000/scarf.png','Ø´Ø§Ù„': 'https://img.icons8.com/fluency/48/000000/scarf.png','Ù‚ÙØ§Ø²': 'https://img.icons8.com/fluency/48/000000/gloves.png','ÙƒÙÙˆÙ': 'https://img.icons8.com/fluency/48/000000/gloves.png','Ø­Ø²Ø§Ù…': 'https://img.icons8.com/fluency/48/000000/belt.png','Ø±Ø¨Ø·Ø©': 'https://img.icons8.com/fluency/48/000000/tie.png','Ø­Ù‚ÙŠØ¨Ø©': 'https://img.icons8.com/fluency/48/000000/handbag.png','Ø´Ù†Ø·Ø©': 'https://img.icons8.com/fluency/48/000000/school-bag.png'
        };

        // --- DOM Elements ---
        const itemsListEl = document.getElementById('items-list');
        const listPlaceholderEl = document.getElementById('list-placeholder');
        const detailViewContainerEl = document.getElementById('detail-view-container');
        const mainPlaceholderEl = document.getElementById('main-placeholder');
        const totalPriceEl = document.getElementById('total-price');
        const addFormModalEl = document.getElementById('addFormModal');
        const confirmModalEl = document.getElementById('confirmModal');
        const confirmMessageEl = document.getElementById('confirmMessage');
        const toastEl = document.getElementById('toast');
        const offlineBannerEl = document.getElementById('offlineBanner');
        const connectionStatusDotEl = document.getElementById('connectionStatus');
        const addFormButton = addFormModalEl?.querySelector('#addItemBtn');
        const addIconPreviewEl = document.getElementById('addIconPreview');
        const addUploadProgressEl = document.getElementById('addUploadProgress');

        // --- Helper Functions ---
        function formatFirestoreTimestamp(timestamp) { /* ... */
             if (!timestamp) return '-'; try { if (timestamp.toDate && typeof timestamp.toDate === 'function') { return timestamp.toDate().toLocaleString('ar-IQ', { day: '2-digit', month: 'short', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }); } if (timestamp instanceof Date) { return timestamp.toLocaleString('ar-IQ', { day: '2-digit', month: 'short', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }); } return new Date(timestamp).toLocaleString('ar-IQ', { day: '2-digit', month: 'short', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }); } catch(e) { console.warn("Timestamp formatting error:", e, "Input:", timestamp); return 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­'; }
        }
        function getIconForName(name) { /* ... */
            if (!name) return defaultIcon; const lowerCaseName = name.toLowerCase(); const keywords = Object.keys(keywordIconMap).sort((a, b) => b.length - a.length); for (const keyword of keywords) { if (lowerCaseName.includes(keyword.toLowerCase())) { return keywordIconMap[keyword]; } } return defaultIcon;
        }
        function updateConnectionStatusUI(online) { /* ... */
             isDefinitelyOffline = !online; offlineBannerEl.classList.toggle('show', !online); connectionStatusDotEl.className = 'connection-status-dot'; if (!online) { connectionStatusDotEl.classList.add('disconnected'); connectionStatusDotEl.title = 'ØºÙŠØ± Ù…ØªØµÙ„'; } else { if (latestSnapshotMetadata.hasPendingWrites) { connectionStatusDotEl.classList.add('syncing'); connectionStatusDotEl.title = 'Ù…ØªØµÙ„ (Ù…Ø²Ø§Ù…Ù†Ø©...)'; } else { connectionStatusDotEl.classList.add('connected'); connectionStatusDotEl.title = 'Ù…ØªØµÙ„'; } }
        }
        function handleImagePreview(event, previewElementId) { /* Stores File */
             const file = event.target.files[0];
             const previewElement = document.getElementById(previewElementId);
             const progressElement = document.getElementById(previewElementId.replace('Preview', 'UploadProgress'));
             if (progressElement) progressElement.textContent = '';

             if (file && previewElement) {
                 if (!file.type.startsWith('image/')) { showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØ±Ø© ØµØ§Ù„Ø­.', true); previewElement.src = ''; previewElement.style.display = 'none'; capturedImageFile = null; event.target.value = null; return; }
                 const reader = new FileReader();
                 reader.onload = (e) => { previewElement.src = e.target.result; previewElement.style.display = 'block'; }
                 reader.readAsDataURL(file);
                 capturedImageFile = file; // Store File object
                 console.log("Image file selected:", capturedImageFile.name);
             } else {
                 previewElement.src = ''; previewElement.style.display = 'none'; capturedImageFile = null;
             }
         }
        function updateMainViewStatus(message, isError = false) { /* ... */
            if (!detailViewContainerEl) return; if (isError) { detailViewContainerEl.innerHTML = `<div class="detail-error"><strong>âŒ Ø®Ø·Ø£:</strong> ${message}</div>`; } else { if (!currentViewItemId && !currentEditItemId) { detailViewContainerEl.innerHTML = `<div class="detail-placeholder">${message}</div>`; } }
        }
        function generateUniqueId() { return Date.now().toString(36) + Math.random().toString(36).substring(2); }

        // --- Core Functions ---
        function renderItemCard(itemData) { /* ... */
             const existingCard = itemsListEl.querySelector(`.item-card[data-id="${itemData.id}"]`);
             const displayIcon = itemData.icon || getIconForName(itemData.name) || defaultIcon;
             const cardHTML = ` <img class="item-icon" src="${displayIcon}" alt="${itemData.name}" loading="lazy" onerror="this.onerror=null; this.src='${defaultIcon}'"> <div class="item-details"> <h4>${itemData.name}</h4> <p>Ø§Ù„ÙƒÙ…ÙŠØ©: ${itemData.stock} | Ø§Ù„Ø³Ø¹Ø±: ${itemData.price.toLocaleString('ar-IQ')} Ø¯.Ø¹</p> </div> <div class="item-actions"> <button class="edit-btn" onclick="event.stopPropagation(); window.showEditForm('${itemData.id}')" title="ØªØ¹Ø¯ÙŠÙ„">ğŸ“</button> <button class="delete-btn" onclick="event.stopPropagation(); window.showConfirmModal('${itemData.id}')" title="Ø­Ø°Ù">ğŸ—‘ï¸</button> </div> `;
             if (existingCard) {
                 existingCard.innerHTML = cardHTML; existingCard.classList.toggle('selected', itemData.id === currentViewItemId || itemData.id === currentEditItemId); existingCard.classList.toggle('has-pending-writes', latestSnapshotMetadata.hasPendingWrites && !latestSnapshotMetadata.fromCache); console.debug(`Updated card: ${itemData.id}`);
             } else {
                 const card = document.createElement('div'); card.className = 'item-card'; card.setAttribute('data-id', itemData.id); card.innerHTML = cardHTML; card.classList.toggle('selected', itemData.id === currentViewItemId || itemData.id === currentEditItemId); card.classList.toggle('has-pending-writes', latestSnapshotMetadata.hasPendingWrites && !latestSnapshotMetadata.fromCache); card.addEventListener('click', () => showItemDetails(itemData.id));
                 let inserted = false; const cards = itemsListEl.querySelectorAll('.item-card');
                 for (let i = 0; i < cards.length; i++) { const currentCardId = cards[i].getAttribute('data-id'); const currentCardData = itemsMap.get(currentCardId); if (currentCardData && itemData.name.localeCompare(currentCardData.name) < 0) { itemsListEl.insertBefore(card, cards[i]); inserted = true; break; } } if (!inserted) { itemsListEl.appendChild(card); } console.debug(`Added card: ${itemData.id}`);
             }
             listPlaceholderEl.style.display = itemsMap.size > 0 ? 'none' : 'block';
        }
        function removeItemCard(itemId) { /* ... */
             const cardToRemove = itemsListEl.querySelector(`.item-card[data-id="${itemId}"]`); if (cardToRemove) { cardToRemove.remove(); console.debug(`Removed card: ${itemId}`); } listPlaceholderEl.style.display = itemsMap.size > 0 ? 'none' : 'block';
        }
        async function showItemDetails(itemId) { /* Uses Map, limited history */
             console.debug(`Showing details for ${itemId}`); const item = itemsMap.get(itemId); if (!item) { updateMainViewStatus(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬ (ID: ${itemId}).`, true); currentViewItemId = null; return; } if (currentViewItemId === itemId && !currentEditItemId) { console.debug(`Already viewing ${itemId}.`); return; }
             currentEditItemId = null; currentViewItemId = itemId; itemsListEl.querySelectorAll('.item-card').forEach(card => { card.classList.toggle('selected', card.getAttribute('data-id') === itemId); });
             const createdAtFormatted = formatFirestoreTimestamp(item.createdAt); const updatedAtFormatted = formatFirestoreTimestamp(item.updatedAt); const displayIcon = item.icon || getIconForName(item.name) || defaultIcon;
             const historyCollectionRef = collection(db, 'clothes', itemId, 'history'); const qHistory = query(historyCollectionRef, orderBy('timestamp', 'desc'), limit(HISTORY_LIMIT)); let historyHtml = '';
             try {
                 console.debug(`Workspaceing history (max ${HISTORY_LIMIT}) for ${itemId}...`); const historySnapshot = await getDocs(qHistory); console.debug(`History received for ${itemId}. Empty: ${historySnapshot.empty}`);
                 if (historySnapshot.empty) { historyHtml = '<li class="no-history"><em>Ù„Ø§ Ø³Ø¬Ù„.</em></li>'; }
                 else { historySnapshot.docs.forEach(doc => { const d = doc.data(); const ts = formatFirestoreTimestamp(d.timestamp); let c = []; if (d.changes.name) { c.push(`<span class="change-detail">Ø§Ù„Ø§Ø³Ù…: <del>${d.changes.name.old}</del> â† ${d.changes.name.new}</span>`); } if (d.changes.stock) { c.push(`<span class="change-detail">Ø§Ù„ÙƒÙ…ÙŠØ©: <del>${d.changes.stock.old}</del> â† ${d.changes.stock.new}</span>`); } if (d.changes.price) { c.push(`<span class="change-detail">Ø§Ù„Ø³Ø¹Ø±: <del>${d.changes.price.old.toLocaleString('ar-IQ')}</del> â† ${d.changes.price.new.toLocaleString('ar-IQ')} Ø¯.Ø¹</span>`); } if (d.changes.icon) { c.push(`<span class="change-detail">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©.</span>`); } if (c.length > 0) { historyHtml += `<li><span class="history-timestamp">${ts}</span>${c.join('')}</li>`; } else { historyHtml += `<li><span class="history-timestamp">${ts}</span><span class="change-detail"><em>ØªØ­Ø¯ÙŠØ«.</em></span></li>`; } }); if (historySnapshot.docs.length >= HISTORY_LIMIT) { historyHtml += `<li class="no-history"><em>(Ø£Ø­Ø¯Ø« ${HISTORY_LIMIT})</em></li>`; } }
             } catch (error) { console.error("History fetch error:", error); historyHtml = '<li class="no-history" style="color: var(--danger);"><em>Ø®Ø·Ø£ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„.</em></li>'; }
             detailViewContainerEl.innerHTML = ` <div class="detail-content"> <img src="${displayIcon}" alt="${item.name}" class="detail-icon" onerror="this.onerror=null; this.src='${defaultIcon}'"> <h2>${item.name}</h2> <p><strong>Ø§Ù„ÙƒÙ…ÙŠØ©:</strong> <span style="font-weight:700;">${item.stock}</span></p> <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> <span style="font-weight:700;">${item.price.toLocaleString('ar-IQ', { style: 'currency', currency: 'IQD' })}</span></p> <p><strong>Ø§Ù„Ù‚ÙŠÙ…Ø©:</strong> <span style="font-weight:700;">${(item.price * item.stock).toLocaleString('ar-IQ', { style: 'currency', currency: 'IQD' })}</span></p> <div class="history-section"><h4>Ø§Ù„Ø³Ø¬Ù„</h4><ul>${historyHtml}</ul></div> <div class="timestamp">Ø£Ù†Ø´Ø¦: ${createdAtFormatted} | ØªØ¹Ø¯Ù„: ${updatedAtFormatted || '-'}</div> <div class="form-buttons"><button class="btn-save" onclick="window.showEditForm('${item.id}')">ğŸ“ ØªØ¹Ø¯ÙŠÙ„</button></div> <p style="font-size:0.8em;opacity:0.6;text-align:center;margin-top:15px;">ID: ${item.id}</p> </div>`; console.debug(`Details displayed for ${itemId}`);
        }
        function showEditForm(itemId) { /* Uses Map */
             console.debug(`Showing edit form for ${itemId}`); const item = itemsMap.get(itemId); if (!item) { showNotification("Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„.", true); return; } currentViewItemId = null; currentEditItemId = itemId; capturedImageFile = null;
             itemsListEl.querySelectorAll('.item-card').forEach(card => card.classList.toggle('selected', card.getAttribute('data-id') === itemId));
             const currentIcon = item.icon || defaultIcon; const editUploadProgressId = `editUploadProgress_${itemId}`;
             detailViewContainerEl.innerHTML = ` <div class="edit-form-container"> <h3><span class="icon">âœï¸</span>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h3> <input type="hidden" id="editItemId" value="${item.id}"> <label for="editItemName">Ø§Ù„Ø§Ø³Ù…:</label> <input type="text" id="editItemName" value="${item.name}" required> <label for="editItemStock">Ø§Ù„ÙƒÙ…ÙŠØ©:</label> <input type="number" id="editItemStock" value="${item.stock}" required min="0"> <label for="editItemPrice">Ø§Ù„Ø³Ø¹Ø±:</label> <input type="number" id="editItemPrice" value="${item.price}" required min="0" step="500"> <label for="editItemImageInput">ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©:</label> <div class="image-upload-area"> <input type="file" id="editItemImageInput" accept="image/*" capture="environment" onchange="window.handleImagePreview(event, 'editIconPreview')"> <label for="editItemImageInput" class="btn-capture">ğŸ“· Ø§Ø®ØªØ±/Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø©</label> <img id="editIconPreview" src="${currentIcon}" alt="Ù…Ø¹Ø§ÙŠÙ†Ø©" class="icon-preview" style="display: ${currentIcon !== defaultIcon ? 'block' : 'none'};" onerror="this.onerror=null; this.src='${defaultIcon}'"> <span id="${editUploadProgressId}" class="upload-progress"></span> </div> <input type="hidden" id="editItemIconCurrentUrl" value="${item.icon || ''}"> <div class="form-buttons"> <button id="updateItemBtn" class="btn-save" onclick="window.updateItem()">ğŸ’¾ Ø­ÙØ¸</button> <button class="btn-cancel" onclick="window.cancelEdit()">Ø¥Ù„ØºØ§Ø¡</button> </div> </div>`;
        }
        function cancelEdit() { /* Uses Map */
             console.debug("Cancelling edit..."); const previousEditId = currentEditItemId; currentEditItemId = null; capturedImageFile = null; const card = itemsListEl.querySelector(`.item-card[data-id="${previousEditId}"]`); if (card) card.classList.remove('selected'); const itemExists = itemsMap.has(previousEditId); if (previousEditId && itemExists) { showItemDetails(previousEditId); } else { updateMainViewStatus("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„."); currentViewItemId = null; }
        }

        // --- Firestore Operations (Add, Update, Delete) ---
        async function addItem() { /* Uses Storage */
             if (!db || !storage || !addFormButton) { showNotification('Ø§Ù„Ø®Ø¯Ù…Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©.', true); return; }
             const nameInput = document.getElementById('itemName'), stockInput = document.getElementById('itemStock'), priceInput = document.getElementById('itemPrice');
             const name = nameInput.value.trim(), stock = parseInt(stockInput.value), price = parseFloat(priceInput.value);
             if (!name || isNaN(stock) || stock < 0 || isNaN(price) || price < 0) { showNotification('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„!', true); return; }
             addFormButton.disabled = true; addFormButton.innerHTML = '<span class="icon">â³</span> Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø¶Ø§ÙØ©...'; addUploadProgressEl.textContent = '';
             let iconUrl = null;
             try {
                 if (capturedImageFile) {
                     addUploadProgressEl.textContent = 'â³ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...'; const imageName = `product_icons/${generateUniqueId()}_${capturedImageFile.name}`; const storageRef = ref(storage, imageName); console.log(`Uploading ${capturedImageFile.name} to ${imageName}...`); const uploadTask = uploadBytesResumable(storageRef, capturedImageFile);
                     await new Promise((resolve, reject) => { uploadTask.on('state_changed', (s) => { const p = Math.round((s.bytesTransferred / s.totalBytes) * 100); addUploadProgressEl.textContent = `â³ (${p}%)`; }, (e) => { console.error("Upload failed:", e); reject(e); }, async () => { console.log("Upload ok. Getting URL..."); try { iconUrl = await getDownloadURL(uploadTask.snapshot.ref); console.log('URL:', iconUrl); addUploadProgressEl.textContent = 'âœ… ØªÙ…'; resolve(); } catch (e) { console.error("Get URL failed:", e); reject(e); } } ); });
                 } else { iconUrl = getIconForName(name); }
                 const newItemData = { name, stock, price, icon: iconUrl, createdAt: serverTimestamp(), updatedAt: null }; console.log("Adding doc:", newItemData); const docRef = await addDoc(collection(db, 'clothes'), newItemData); console.log("Doc written:", docRef.id);
                 if (isDefinitelyOffline) { showNotification('âœ… Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ (Ø¨Ø¯ÙˆÙ† ØµÙˆØ±Ø©). Ù…Ø²Ø§Ù…Ù†Ø© Ù„Ø§Ø­Ù‚Ø©.', false, 'warning'); } else { showNotification('âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­!', false, 'success'); }
                 hideAddForm(); // Reset form
             } catch (error) { showNotification(`Ø®Ø·Ø£ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: ${error.message}`, true); console.error("Add item error: ", error); addUploadProgressEl.textContent = 'âŒ ÙØ´Ù„';
             } finally { addFormButton.disabled = false; addFormButton.innerHTML = 'â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬'; }
         }
        async function updateItem() { /* Uses Storage */
             if (!db || !storage) { showNotification('Ø§Ù„Ø®Ø¯Ù…Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©.', true); return; }
             const updateButton = document.getElementById('updateItemBtn'); if(updateButton) updateButton.disabled = true; updateButton.innerHTML = '<span class="icon">â³</span> Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...';
            const itemId = document.getElementById('editItemId').value; const name = document.getElementById('editItemName').value.trim(); const stock = parseInt(document.getElementById('editItemStock').value); const price = parseFloat(document.getElementById('editItemPrice').value); const currentIconUrl = document.getElementById('editItemIconCurrentUrl').value; const progressElement = document.getElementById(`editUploadProgress_${itemId}`); if (progressElement) progressElement.textContent = '';
            if (!itemId || !name || isNaN(stock) || stock < 0 || isNaN(price) || price < 0) { showNotification('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„!', true); if(updateButton) { updateButton.disabled = false; updateButton.innerHTML = 'ğŸ’¾ Ø­ÙØ¸';} return; }
            const itemRef = doc(db, 'clothes', itemId); const historyRef = collection(db, 'clothes', itemId, 'history'); let newIconUrl = currentIconUrl; let iconChanged = false;
            try {
                if (capturedImageFile) {
                     if (progressElement) progressElement.textContent = 'â³ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...'; const imageName = `product_icons/${itemId}/${generateUniqueId()}_${capturedImageFile.name}`; const storageRef = ref(storage, imageName); console.log(`Uploading new image ${capturedImageFile.name} to ${imageName}...`); const uploadTask = uploadBytesResumable(storageRef, capturedImageFile);
                     await new Promise((resolve, reject) => { uploadTask.on('state_changed', (s) => { const p = Math.round((s.bytesTransferred / s.totalBytes) * 100); if (progressElement) progressElement.textContent = `â³ (${p}%)`; }, (e) => { console.error("Upload failed:", e); reject(e); }, async () => { console.log("Upload ok. Getting URL..."); try { newIconUrl = await getDownloadURL(uploadTask.snapshot.ref); iconChanged = true; if (progressElement) progressElement.textContent = 'âœ… ØªÙ…'; console.log('New URL:', newIconUrl); if (currentIconUrl && currentIconUrl.includes('firebasestorage.googleapis.com')) { try { await deleteObject(ref(storage, currentIconUrl)); console.log("Old image deleted:", currentIconUrl); } catch (e) { console.warn("Could not delete old image:", e); } } resolve(); } catch (e) { console.error("Get URL failed:", e); reject(e); } } ); });
                }
                const currentDocSnap = await getDoc(itemRef); if (!currentDocSnap.exists()) { throw new Error("Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"); } const currentData = currentDocSnap.data();
                if (!capturedImageFile && currentData.name !== name) { const autoIcon = getIconForName(name); if (autoIcon !== currentData.icon) { newIconUrl = autoIcon; iconChanged = true; } }
                const updatedData = { name, stock, price, icon: newIconUrl, updatedAt: serverTimestamp() }; const logEntry = { timestamp: serverTimestamp(), changes: {} }; let hasChanges = false;
                if (currentData.name !== name) { logEntry.changes.name = { old: currentData.name, new: name }; hasChanges = true; } if (currentData.stock !== stock) { logEntry.changes.stock = { old: currentData.stock, new: stock }; hasChanges = true; } if (currentData.price !== price) { logEntry.changes.price = { old: currentData.price, new: price }; hasChanges = true; } if (iconChanged) { logEntry.changes.icon = { old: currentData.icon, new: newIconUrl }; hasChanges = true; }
                const batch = writeBatch(db); batch.update(itemRef, updatedData); if (hasChanges) { batch.set(doc(historyRef), logEntry); } console.log("Committing updates..."); await batch.commit(); console.log("Commit ok.");
                if (isDefinitelyOffline) { showNotification('âœ… Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ. Ù…Ø²Ø§Ù…Ù†Ø© Ù„Ø§Ø­Ù‚Ø©.', false, 'warning'); } else { showNotification('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­!', false, 'success'); }
                capturedImageFile = null; currentEditItemId = null; await showItemDetails(itemId);
            } catch (error) { showNotification(`Ø®Ø·Ø£ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${error.message}`, true); console.error("Update item error: ", error); if (progressElement) progressElement.textContent = 'âŒ ÙØ´Ù„';
            } finally { if(updateButton) { updateButton.disabled = false; updateButton.innerHTML = 'ğŸ’¾ Ø­ÙØ¸'; } }
        }
        function showConfirmModal(itemId) { /* Uses Map */
             if (!itemId) return; const item = itemsMap.get(itemId); if (!item) { showNotification('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ù„Ù„Ø­Ø°Ù!', true); return; } const safeItemName = item.name.replace(/</g, "&lt;").replace(/>/g, "&gt;"); confirmMessageEl.innerHTML = `Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù: <strong style="color: var(--danger);">${safeItemName}</strong>ØŸ<br><small>(Ø³ÙŠØªÙ… Ø­Ø°Ù ØµÙˆØ±ØªÙ‡ ÙˆØ³Ø¬Ù„Ù‡)</small>`; const currentBtn = document.getElementById('confirmDeleteBtn'); const newConfirmBtn = currentBtn.cloneNode(true); currentBtn.parentNode.replaceChild(newConfirmBtn, currentBtn); newConfirmBtn.onclick = () => deleteItem(itemId, item.icon); newConfirmBtn.style.backgroundColor = 'var(--danger)'; newConfirmBtn.innerHTML = 'âœ”ï¸ Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù'; confirmModalEl.classList.add('show');
        }
        function hideConfirmModal() { confirmModalEl.classList.remove('show'); }
        async function deleteItem(itemId, iconUrl) { /* Uses Storage */
             if (!db || !storage) { showNotification('Ø§Ù„Ø®Ø¯Ù…Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©.', true); return; } hideConfirmModal(); if (!itemId) return; console.log(`Deleting item: ${itemId}`);
             try {
                 await deleteDoc(doc(db, 'clothes', itemId)); console.log(`Doc ${itemId} deleted.`);
                 if (iconUrl && iconUrl.includes('firebasestorage.googleapis.com')) { try { await deleteObject(ref(storage, iconUrl)); console.log("Image deleted:", iconUrl); } catch (e) { console.warn(`Could not delete image ${iconUrl}:`, e.code || e.message); if (e.code !== 'storage/object-not-found') { showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©.', false, 'warning'); } } }
                 if (isDefinitelyOffline) { showNotification('âœ… Ø­Ø°Ù Ù…Ø­Ù„ÙŠ. Ù…Ø²Ø§Ù…Ù†Ø© Ù„Ø§Ø­Ù‚Ø©.', false, 'warning'); } else { showNotification('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­.', false, 'success'); }
             } catch (error) { showNotification(`Ø®Ø·Ø£ Ø§Ù„Ø­Ø°Ù: ${error.message}`, true); console.error("Delete error: ", error); updateMainViewStatus(`ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ${error.message}`, true); }
        }

        function updateTotalPrice() { /* Uses Map */
             let totalValue = 0; itemsMap.forEach(item => { totalValue += (item.price * item.stock); }); if (totalPriceEl) { totalPriceEl.textContent = totalValue.toLocaleString('ar-IQ', { style: 'currency', currency: 'IQD', minimumFractionDigits: 0 }); }
        }
        function generateReport() { /* Uses Map */
             if (itemsMap.size === 0) { showNotification("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„ØªÙ‚Ø±ÙŠØ±.", true); return; } let reportContent = `ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†\nØªØ§Ø±ÙŠØ®: ${new Date().toLocaleString('ar-IQ')}\n================\n\n`; let index = 0; itemsMap.forEach((item) => { index++; reportContent += `${index}. ${item.name} (ID: ${item.id})\n   Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.stock} | Ø§Ù„Ø³Ø¹Ø±: ${item.price.toLocaleString('ar-IQ')} Ø¯.Ø¹ | Ø§Ù„Ù‚ÙŠÙ…Ø©: ${(item.price * item.stock).toLocaleString('ar-IQ')} Ø¯.Ø¹\n   Ø£Ù†Ø´Ø¦: ${formatFirestoreTimestamp(item.createdAt)} | ØªØ¹Ø¯Ù„: ${formatFirestoreTimestamp(item.updatedAt)}\n----------------\n`; }); let totalValue = 0; itemsMap.forEach(item => { totalValue += (item.price * item.stock); }); reportContent += `\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©: ${totalValue.toLocaleString('ar-IQ', { style: 'currency', currency: 'IQD' })}\nØ¹Ø¯Ø¯ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹: ${itemsMap.size}\n`; try { const blob = new Blob([`\uFEFF${reportContent}`], { type: 'text/plain;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `Product_Report_${new Date().toISOString().slice(0,10)}.txt`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showNotification("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.", false, 'success'); } catch (e) { showNotification("ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.", true); console.error("Report error:", e); alert("ÙØ´Ù„ Ø§Ù„ØªÙ†Ø²ÙŠÙ„. Ø§Ù„Ù…Ø­ØªÙˆÙ‰:\n\n" + reportContent); }
        }
        function toggleDarkMode() { /* ... */
             const isDarkMode = document.body.classList.toggle('dark-mode'); localStorage.setItem('darkMode', isDarkMode ? 'true' : 'false'); const themeButton = document.querySelector('.control-panel button[onclick*="toggleDarkMode"]'); if(themeButton) themeButton.innerHTML = isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™'; if(themeButton) themeButton.title = isDarkMode ? 'ÙØ§ØªØ­' : 'Ø¯Ø§ÙƒÙ†';
        }
        function showAddForm() { /* ... */
            addFormModalEl.classList.add('show'); document.getElementById('itemName').value = ''; document.getElementById('itemStock').value = ''; document.getElementById('itemPrice').value = ''; document.getElementById('itemImageInput').value = null; if (addIconPreviewEl) { addIconPreviewEl.src = ''; addIconPreviewEl.style.display = 'none'; } if (addUploadProgressEl) addUploadProgressEl.textContent = ''; capturedImageFile = null;
        }
        function hideAddForm() { addFormModalEl.classList.remove('show'); capturedImageFile = null; }
        function showNotification(message, isError = false, type = 'normal') { /* ... */
             if (!toastEl) return; toastEl.textContent = message; toastEl.className = 'toast'; if (isError) toastEl.classList.add('error'); else if (type === 'warning') toastEl.classList.add('warning'); else if (type === 'success') toastEl.classList.add('success'); toastEl.classList.add('show'); setTimeout(() => { toastEl.classList.remove('show'); }, 3500);
        }

        // --- Initialization ---
        async function initializeAppAndFirestore() {
            console.log("Initializing app..."); updateMainViewStatus("ğŸ”„ ØªÙ‡ÙŠØ¦Ø©..."); listPlaceholderEl.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„..."; listPlaceholderEl.style.display = 'block'; connectionStatusDotEl.className = 'connection-status-dot connecting'; updateConnectionStatusUI(navigator.onLine);
            try {
                console.log("Initializing Firebase..."); app = initializeApp(firebaseConfig); db = getFirestore(app); storage = getStorage(app); console.log("Firebase OK.");
                try { updateMainViewStatus("ğŸ”„ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ..."); console.log("Enabling persistence..."); await enableIndexedDbPersistence(db); console.log("Persistence OK."); } catch (err) { if (err.code === 'failed-precondition') { console.warn("Persistence failed (multi-tabs?)."); showNotification("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ.", false, 'warning'); } else { console.error("Persistence error:", err); showNotification("âš ï¸ Ø®Ø·Ø£ ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ.", true); } if (!db) throw new Error("Firestore init failed."); }
                console.log("Applying theme..."); const isDarkMode = localStorage.getItem('darkMode') === 'true'; if (isDarkMode) document.body.classList.add('dark-mode'); const themeButton = document.querySelector('.control-panel button[onclick*="toggleDarkMode"]'); if(themeButton) themeButton.innerHTML = isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™'; if(themeButton) themeButton.title = isDarkMode ? 'ÙØ§ØªØ­' : 'Ø¯Ø§ÙƒÙ†';
                updateMainViewStatus("ğŸ”„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª..."); console.log("Attaching listener...");
                if (db && !unsubscribeSnapshot) {
                    const itemsCollection = collection(db, 'clothes'); const q = query(itemsCollection, orderBy('createdAt', 'desc'));
                    unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
                        console.log(`Snapshot (${snapshot.docChanges().length} changes). Source: ${snapshot.metadata.fromCache ? 'Cache' : 'Server'}. Pending: ${snapshot.metadata.hasPendingWrites}`); latestSnapshotMetadata = snapshot.metadata; updateConnectionStatusUI(navigator.onLine); let needsTotalUpdate = false;
                        snapshot.docChanges().forEach((change) => {
                            const docData = change.doc.data({ serverTimestamps: "estimate" }); const itemData = { id: change.doc.id, ...docData };
                            if (change.type === "added") { console.debug("Add:", itemData.id); itemsMap.set(itemData.id, itemData); renderItemCard(itemData); needsTotalUpdate = true; }
                            if (change.type === "modified") { console.debug("Mod:", itemData.id); itemsMap.set(itemData.id, itemData); renderItemCard(itemData); needsTotalUpdate = true; if (currentViewItemId === itemData.id) { showItemDetails(itemData.id); } if (currentEditItemId === itemData.id) { console.warn(`Edited item ${itemData.id} modified externally.`); } }
                            if (change.type === "removed") { console.debug("Del:", itemData.id); itemsMap.delete(itemData.id); removeItemCard(itemData.id); needsTotalUpdate = true; if (currentViewItemId === itemData.id) { currentViewItemId = null; updateMainViewStatus("ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶."); } if (currentEditItemId === itemData.id) { currentEditItemId = null; updateMainViewStatus("ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„."); } }
                        });
                        if (needsTotalUpdate) { updateTotalPrice(); }
                        if (!firstLoadComplete) { firstLoadComplete = true; console.log("Initial sync complete."); listPlaceholderEl.style.display = itemsMap.size > 0 ? 'none' : 'block'; if (itemsMap.size === 0) { listPlaceholderEl.textContent = "â• Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª."; } if (!currentViewItemId && !currentEditItemId) { updateMainViewStatus(itemsMap.size > 0 ? "ğŸ‘ˆ Ø§Ø®ØªØ± Ù…Ù†ØªØ¬Ø§Ù‹." : "â• Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª."); } }
                    }, (error) => { console.error("âŒ Listener error:", error); showNotification("Ø®Ø·Ø£ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª.", true); updateMainViewStatus(`ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}.`, true); updateConnectionStatusUI(false); firstLoadComplete = true; listPlaceholderEl.textContent = "âŒ Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"; listPlaceholderEl.style.display = 'block'; });
                    console.log("Listener attached.");
                } else { throw new Error("DB not available."); }
                 console.log("Setting up listeners..."); window.addEventListener('online', () => updateConnectionStatusUI(true)); window.addEventListener('offline', () => updateConnectionStatusUI(false));
                 console.log("Exposing functions..."); window.addItem = addItem; window.updateItem = updateItem; window.deleteItem = deleteItem; window.showItemDetails = showItemDetails; window.showEditForm = showEditForm; window.cancelEdit = cancelEdit; window.showConfirmModal = showConfirmModal; window.hideConfirmModal = hideConfirmModal; window.generateReport = generateReport; window.toggleDarkMode = toggleDarkMode; window.showAddForm = showAddForm; window.hideAddForm = hideAddForm; window.handleImagePreview = handleImagePreview;
                 console.log("âœ… Init success.");
            } catch (initError) { console.error("âŒ Init Failed:", initError); updateMainViewStatus(`ÙØ´Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ${initError.message} (${initError.code || ''}).`, true); listPlaceholderEl.textContent = "âŒ ÙØ´Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©"; listPlaceholderEl.style.display = 'block'; connectionStatusDotEl.className = 'connection-status-dot disconnected'; connectionStatusDotEl.title = `ÙØ´Ù„: ${initError.message}`; }
        }

        // Start the App
        document.addEventListener('DOMContentLoaded', initializeAppAndFirestore);
        // Cleanup listener
        window.addEventListener('beforeunload', () => { if (unsubscribeSnapshot) { console.log("Detaching listener."); unsubscribeSnapshot(); } });

    </script>

</body>
</html>
