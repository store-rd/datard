<!DOCTYPE html>
<html lang="ar" class="no-js" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نظام إدارة المبيعات والمخزون الإحترافي v10.10</title> <!-- Version updated -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#B71C1C" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#455A64" media="(prefers-color-scheme: dark)">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/apple-icon-180.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="المبيعات والمخزون">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Changa:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
:root {
    /* --- Enhanced Light Theme Colors --- */
    --primary-light: #B71C1C; /* Darker Red */
    --secondary-light: #FF6F00; /* Darker Amber */
    --accent-light: #0D47A1; /* Darker Blue */
    --info-light: #1B5E20; /* Darker Green */
    --info-hover-light: #0a3d1b;
    --danger-light: #D32F2F; /* Standard Red */
    --danger-hover-light: #B71C1C; /* Darker Red */
    --warning-light: #FFA000; /* Amber 700 */
    --warning-hover-light: #FF8F00; /* Amber 800 */
    --dark-text-light: #212121; /* Near Black */
    --light-bg: #FAFAFA; /* Very Light Grey */
    --grey-light-bg: #FFFFFF; /* White */
    --grey-medium-border: #E0E0E0; /* Light Grey Border */
    --grey-dark-text: #424242; /* Darker Grey Text */
    --offline-indicator: #FF8F00; /* Amber */
    --timestamp-color: #757575; /* Medium Grey */
    --partner-profit-color: #1B5E20; /* Dark Green */
    --partner-field-bg: #F5F5F5; /* Light Grey Background */
    --debt-color: #C62828; /* Strong Red */
    /* RGB values for rgba() */
    --grey-light-rgb: 255, 255, 255; /* White */
    --dark-bg-rgb: 33, 33, 33; /* Near black */

    /* --- Enhanced Dark Theme Colors --- */
    --primary-dark: #E57373; /* Lighter Red */
    --secondary-dark: #FFB74D; /* Lighter Amber */
    --accent-dark: #64B5F6; /* Lighter Blue */
    --info-dark: #81C784; /* Lighter Green */
    --info-hover-dark: #A5D6A7;
    --danger-dark: #EF9A9A; /* Light Red */
    --danger-hover-dark: #E57373; /* Slightly darker light red */
    --warning-dark: #FFCA28; /* Amber 400 */
    --warning-hover-dark: #FFD54F; /* Amber 300 */
    --dark-bg: #121212; /* True Dark Background */
    --light-text-dark: #E0E0E0; /* Light Grey Text */
    --grey-light-dark-bg: #212121; /* Dark Grey */
    --grey-medium-dark-border: #424242; /* Darker Grey Border */
    --grey-dark-dark-text: #BDBDBD; /* Medium Light Grey Text */
    --timestamp-color-dark: #9E9E9E; /* Lighter Grey */
    --partner-profit-color-dark: #A5D6A7; /* Lighter Green */
    --partner-field-bg-dark: rgba(255, 255, 255, 0.05); /* Subtle White Background */
    --debt-color-dark: #EF9A9A; /* Light Red */
    /* RGB values for rgba() */
    --grey-light-dark-bg-rgb: 33, 33, 33; /* Dark Grey */

    /* --- Shadows --- */
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
    --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.12);
    --shadow-inset: inset 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-dark-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
    --shadow-dark-md: 0 4px 8px rgba(0, 0, 0, 0.4);
    --shadow-dark-lg: 0 10px 20px rgba(0, 0, 0, 0.5);
    --shadow-dark-inset: inset 0 1px 2px rgba(0, 0, 0, 0.2);

    /* --- Fonts & Transitions --- */
    --font-primary: 'Tajawal', 'Changa', sans-serif;
    --transition-speed: 0.25s;
    --transition-ease: cubic-bezier(0.4, 0, 0.2, 1);
    --border-radius-sm: 4px;
    --border-radius-md: 8px;
    --border-radius-lg: 12px;

    /* --- Current Values (Set initially for light mode) --- */
    --primary: var(--primary-light);
    --secondary: var(--secondary-light);
    --accent: var(--accent-light);
    --info: var(--info-light);
    --info-hover: var(--info-hover-light);
    --danger: var(--danger-light);
    --danger-hover: var(--danger-hover-light);
    --warning: var(--warning-light);
    --warning-hover: var(--warning-hover-light);
    --dark: var(--dark-text-light);
    --light: var(--light-bg);
    --grey-light: var(--grey-light-bg);
    --grey-medium: var(--grey-medium-border);
    --grey-dark: var(--grey-dark-text);
    --current-timestamp-color: var(--timestamp-color);
    --current-debt-color: var(--debt-color);
    --current-partner-profit-color: var(--partner-profit-color);
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }
body {
    font-family: var(--font-primary);
    background: var(--light);
    color: var(--dark);
    display: flex;
    height: 100vh;
    overflow: hidden;
    transition: background var(--transition-speed) var(--transition-ease), color var(--transition-speed) var(--transition-ease);
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    perspective: 1200px;
    padding-top: env(safe-area-inset-top, 0px);
    padding-bottom: env(safe-area-inset-bottom, 0px);
    padding-left: env(safe-area-inset-left, 0px);
    padding-right: env(safe-area-inset-right, 0px);
}
body.dark-mode {
    background: var(--dark-bg);
    color: var(--light-text-dark);
    --primary: var(--primary-dark);
    --secondary: var(--secondary-dark);
    --accent: var(--accent-dark);
    --info: var(--info-dark);
    --info-hover: var(--info-hover-dark);
    --danger: var(--danger-dark);
    --danger-hover: var(--danger-hover-dark);
    --warning: var(--warning-dark);
    --warning-hover: var(--warning-hover-dark);
    --dark: var(--dark-bg); /* Reference dark background */
    --light: var(--light-text-dark); /* Reference light text */
    --grey-light: var(--grey-light-dark-bg);
    --grey-medium: var(--grey-medium-dark-border);
    --grey-dark: var(--grey-dark-dark-text);
    --current-timestamp-color: var(--timestamp-color-dark);
    --current-debt-color: var(--debt-color-dark);
    --current-partner-profit-color: var(--partner-profit-color-dark);
    --shadow-sm: var(--shadow-dark-sm);
    --shadow-md: var(--shadow-dark-md);
    --shadow-lg: var(--shadow-dark-lg);
    --shadow-inset: var(--shadow-dark-inset);
}
.offline-banner { position: fixed; top: env(safe-area-inset-top, 0px); left: 0; right: 0; background-color: var(--offline-indicator); color: var(--dark-text-light); text-align: center; padding: 8px 12px; font-size: 0.95em; z-index: 2001; display: none; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2); font-weight: 700; animation: slideDown 0.4s ease-out; }
@keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.offline-banner.show { display: block; }

.sidebar { width: 360px; min-width: 320px; background: var(--grey-light); height: 100%; display: flex; flex-direction: column; border-left: 1px solid var(--grey-medium); box-shadow: -3px 0 15px rgba(0, 0, 0, 0.04); z-index: 10; transition: all var(--transition-speed) var(--transition-ease); }
.dark-mode .sidebar { background: var(--grey-light-dark-bg); border-left-color: var(--grey-medium-dark-border); box-shadow: -5px 0 20px rgba(0, 0, 0, 0.15); }
.sidebar-header { padding: 18px 20px; border-bottom: 1px solid var(--grey-medium); font-size: 1.3em; font-weight: 700; color: var(--primary); flex-shrink: 0; position: relative; display: flex; align-items: center; justify-content: space-between; background: rgba(var(--grey-light-rgb), 0.7); backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px); }
.dark-mode .sidebar-header { border-bottom-color: var(--grey-medium-dark-border); color: var(--primary); background: rgba(var(--grey-light-dark-bg-rgb), 0.7); }
.connection-status-dot { width: 12px; height: 12px; border-radius: 50%; background-color: #FFC107; display: inline-block; transition: background-color 0.5s, box-shadow 0.3s; flex-shrink: 0; border: 1px solid rgba(0, 0, 0, 0.1); margin-left: 8px; }
.connection-status-dot.connecting { background-color: #FFC107; animation: pulse 1.5s infinite ease-in-out; }
.connection-status-dot.connected { background-color: var(--info); border-color: var(--info-hover); box-shadow: 0 0 6px var(--info); animation: none; }
.connection-status-dot.syncing { background-color: var(--offline-indicator); border-color: #E65100; box-shadow: 0 0 6px var(--offline-indicator); animation: pulse 1s infinite ease-in-out; }
.connection-status-dot.disconnected { background-color: var(--danger); border-color: var(--danger-hover); box-shadow: 0 0 6px var(--danger); animation: none; }
.dark-mode .connection-status-dot { border-color: rgba(255, 255, 255, 0.2); }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

#items-list { flex-grow: 1; overflow-y: auto; padding: 10px; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
#items-list .empty-list-placeholder { text-align: center; padding: 50px 20px; opacity: 0.7; color: var(--grey-dark); font-size: 1.1em; }
.dark-mode #items-list .empty-list-placeholder { color: var(--grey-dark-dark-text); }
.item-card { padding: 12px 15px; margin-bottom: 10px; background: #ffffff; border: 1px solid var(--grey-medium); border-radius: var(--border-radius-md); cursor: pointer; transition: all var(--transition-speed) var(--transition-ease); display: flex; align-items: center; gap: 12px; position: relative; border-left: 5px solid transparent; box-shadow: var(--shadow-sm); transform: translateZ(0); min-height: 75px; }
.item-card.has-pending-writes { border-left-color: var(--offline-indicator); }
.dark-mode .item-card { background: var(--grey-light-dark-bg); border-color: var(--grey-medium-dark-border); }
.item-card:hover { transform: translateY(-3px) translateZ(10px); box-shadow: var(--shadow-md); z-index: 10; border-left-color: var(--accent); }
.item-card.selected { background: linear-gradient(135deg, var(--accent), color-mix(in srgb, var(--accent-light), white 20%)); color: white; border-color: var(--accent); box-shadow: 0 4px 12px color-mix(in srgb, var(--accent-light), transparent 70%); transform: scale(1.01) translateZ(5px); border-left-color: var(--accent); }
.item-card.selected.has-pending-writes { border-left-color: var(--secondary); }
.dark-mode .item-card.selected { background: linear-gradient(135deg, var(--primary), color-mix(in srgb, var(--primary-dark), black 20%)); color: white; border-color: var(--primary); box-shadow: 0 4px 12px color-mix(in srgb, var(--primary-dark), transparent 70%); border-left-color: var(--primary); }
.dark-mode .item-card.selected.has-pending-writes { border-left-color: var(--secondary); }
.item-icon { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid var(--grey-light); box-shadow: var(--shadow-sm); padding: 2px; background-color: var(--grey-light); transition: transform var(--transition-speed) var(--transition-ease); }
.item-card:hover .item-icon { transform: scale(1.1); }
.dark-mode .item-icon { border-color: var(--grey-dark); background-color: var(--grey-light-dark-bg); }
.item-card.selected .item-icon { border-color: rgba(255, 255, 255, 0.7); background-color: transparent; }
.item-details { flex-grow: 1; overflow: hidden; }
.item-details h4 { margin: 0 0 4px 0; font-size: 1.1em; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--dark); }
.item-details p { margin: 0; font-size: 0.9em; opacity: 0.8; white-space: nowrap; color: var(--grey-dark); font-weight: 400; }
.dark-mode .item-details h4 { color: var(--light); }
.dark-mode .item-details p { color: var(--grey-dark-dark-text); opacity: 0.8; }
.item-card.selected h4, .item-card.selected p { color: white; opacity: 1; }
.item-actions { display: flex; gap: 8px; flex-shrink: 0; align-items: center; opacity: 0; transition: opacity var(--transition-speed) ease; margin-right: auto; }
.item-card:hover .item-actions, .item-card.selected .item-actions { opacity: 1; }
.item-actions button { background: transparent; border: 1px solid var(--grey-medium); color: var(--grey-dark); cursor: pointer; padding: 0; font-size: 1em; border-radius: 50%; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; transition: all var(--transition-speed) var(--transition-ease); box-shadow: var(--shadow-sm); }
.dark-mode .item-actions button { border-color: var(--grey-medium-dark-border); color: var(--grey-dark-dark-text); }
.item-card.selected .item-actions button { background: rgba(255, 255, 255, 0.15); border-color: rgba(255, 255, 255, 0.3); color: white; }
.item-actions button:hover { transform: scale(1.1); box-shadow: var(--shadow-md); }
.item-actions .edit-btn:hover { background-color: var(--accent); color: white; border-color: transparent; }
.item-actions .delete-btn:hover { background-color: var(--danger); color: white; border-color: transparent; }

.sidebar-footer { padding: 15px; border-top: 1px solid var(--grey-medium); flex-shrink: 0; background: rgba(var(--grey-light-rgb), 0.7); backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px); }
.dark-mode .sidebar-footer { border-top-color: var(--grey-medium-dark-border); background: rgba(var(--grey-light-dark-bg-rgb), 0.7); }
#footer-summary { text-align: center; margin-bottom: 8px; font-weight: 600; font-size: 1em; color: var(--dark); }
.dark-mode #footer-summary { color: var(--light); }
#all-paid-sales-summary { color: var(--info); font-weight: 700; font-size: 1.05em; }
.dark-mode #all-paid-sales-summary { color: var(--info-dark); }
#debts-summary { text-align: center; margin-bottom: 12px; font-weight: 600; font-size: 1em; color: var(--dark); display: none; }
.dark-mode #debts-summary { color: var(--light); }
#total-debts-amount { color: var(--current-debt-color); font-weight: 700; font-size: 1.05em; }
.report-btn { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 10px 15px; background-color: var(--dark); color: white; border: none; border-radius: var(--border-radius-md); cursor: pointer; font-family: var(--font-primary); font-size: 1em; transition: all var(--transition-speed) var(--transition-ease); font-weight: 700; box-shadow: var(--shadow-sm); min-height: 40px; margin-top: 8px; }
.report-btn:hover { background-color: color-mix(in srgb, var(--dark-text-light), black 10%); transform: translateY(-2px); box-shadow: var(--shadow-md); }
.dark-mode .report-btn { background-color: var(--grey-dark-dark-text); color: var(--dark-bg); }
.dark-mode .report-btn:hover { background-color: color-mix(in srgb, var(--grey-dark-dark-text), white 15%); }
.report-btn .icon, .report-btn i { margin-left: 5px; }

#detail-view-container { flex-grow: 1; height: 100%; padding: 30px; overflow-y: auto; position: relative; display: flex; align-items: center; justify-content: center; background-color: var(--light); -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
.dark-mode #detail-view-container { background-color: var(--dark-bg); }
.detail-placeholder, .detail-error { text-align: center; padding: 40px; font-size: 1.2em; font-weight: 600; opacity: 0.8; }
.detail-placeholder { color: var(--grey-dark); }
.dark-mode .detail-placeholder { color: var(--grey-dark-dark-text); }
.detail-error { color: var(--danger); background-color: color-mix(in srgb, var(--danger-light), transparent 92%); border: 1px solid color-mix(in srgb, var(--danger-light), transparent 70%); border-radius: var(--border-radius-md); }
.dark-mode .detail-error { color: var(--danger-dark); background-color: color-mix(in srgb, var(--danger-dark), transparent 85%); border-color: color-mix(in srgb, var(--danger-dark), transparent 60%); }
.detail-error strong { display: block; margin-bottom: 8px; }
.detail-content, .edit-form-container { background: #ffffff; padding: 30px 35px; border-radius: var(--border-radius-lg); border: 1px solid var(--grey-medium); box-shadow: var(--shadow-md); width: 100%; max-width: 600px; animation: fadeIn 0.4s var(--transition-ease); transform: translateZ(0); margin-bottom: 20px; }
.dark-mode .detail-content, .dark-mode .edit-form-container { background: var(--grey-light-dark-bg); border-color: var(--grey-medium-dark-border); box-shadow: var(--shadow-dark-lg); }
@keyframes fadeIn { from { opacity: 0; transform: translateY(15px) translateZ(0); } to { opacity: 1; transform: translateY(0) translateZ(0); } }
.detail-content h2, .edit-form-container h3 { margin-top: 0; margin-bottom: 25px; color: var(--primary); text-align: center; font-weight: 700; font-size: 1.6em; }
.dark-mode .detail-content h2, .dark-mode .edit-form-container h3 { color: var(--primary-dark); }
.detail-content p { margin-bottom: 15px; font-size: 1.05em; line-height: 1.7; color: var(--dark); }
.dark-mode .detail-content p { color: var(--light); }
.detail-content p strong { color: var(--dark); font-weight: 700; margin-left: 8px; }
.dark-mode .detail-content p strong { color: var(--light); }
.detail-content p.partner-cost-info {
    font-size: 1em;
    background-color: var(--partner-field-bg);
    padding: 8px 12px;
    border-radius: var(--border-radius-sm);
    border: 1px solid var(--grey-medium);
    border-left: 3px solid var(--secondary);
}
.dark-mode .detail-content p.partner-cost-info {
    background-color: var(--partner-field-bg-dark);
    border-color: var(--grey-medium-dark-border);
    border-left-color: var(--secondary-dark);
}
.detail-content p.partner-cost-info strong { color: var(--secondary); }
.dark-mode .detail-content p.partner-cost-info strong { color: var(--secondary-dark); }
.detail-content .timestamp { font-size: 0.85em; color: var(--current-timestamp-color); text-align: center; margin-top: 25px; border-top: 1px dashed var(--grey-medium); padding-top: 15px; line-height: 1.6; opacity: 0.8; }
.dark-mode .detail-content .timestamp { border-top-color: var(--grey-medium-dark-border); }
.detail-content .history-section { font-size: 0.85em; color: var(--current-timestamp-color); text-align: right; margin-top: 25px; border-top: 1px dashed var(--grey-medium); padding-top: 15px; line-height: 1.7; max-height: 180px; overflow-y: auto; background: var(--partner-field-bg); padding: 15px; border-radius: var(--border-radius-md); -webkit-overflow-scrolling: touch; overscroll-behavior: contain; border: 1px solid var(--grey-medium); }
.dark-mode .detail-content .history-section { border-top-color: var(--grey-medium-dark-border); background: var(--partner-field-bg-dark); border-color: var(--grey-medium-dark-border); }
.history-section h4 { margin-bottom: 12px; color: var(--dark); font-size: 1em; text-align: center; font-weight: 700; opacity: 0.9; }
.dark-mode .history-section h4 { color: var(--light); }
.history-section ul { list-style: none; padding: 0; margin: 0; }
.history-section li { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(0, 0, 0, 0.06); }
.dark-mode .history-section li { border-bottom-color: rgba(255, 255, 255, 0.08); }
.history-section li:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }
.history-section .history-timestamp { font-weight: 700; color: var(--accent); display: block; margin-bottom: 5px; font-size: 0.9em; }
.dark-mode .history-section .history-timestamp { color: var(--accent-dark); }
.history-section .change-detail { display: block; font-size: 0.95em; color: var(--dark); }
.dark-mode .history-section .change-detail { color: var(--light); }
.history-section del { opacity: 0.7; text-decoration: line-through; color: var(--danger); background-color: color-mix(in srgb, var(--danger-light), transparent 95%); padding: 0 2px; border-radius: 3px; }
.dark-mode .history-section del { color: var(--danger-dark); background-color: color-mix(in srgb, var(--danger-dark), transparent 90%); }
.detail-content img.detail-icon { display: block; width: 85px; height: 85px; border-radius: 50%; margin: 0 auto 25px auto; border: 4px solid var(--grey-light); box-shadow: var(--shadow-lg); background-color: var(--grey-light); object-fit: cover; }
.dark-mode .detail-content img.detail-icon { border-color: var(--grey-dark); background-color: var(--grey-light-dark-bg); }

/* Form Styles */
.form-field-group { margin-bottom: 18px; }
.edit-form-container label, .modal-content label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.95em; color: var(--grey-dark); }
.dark-mode .edit-form-container label, .dark-mode .modal-content label { color: var(--grey-dark-dark-text); }
.edit-form-container input[type="text"], .edit-form-container input[type="number"], .edit-form-container input[type="url"],
.modal-content input[type="text"], .modal-content input[type="number"], .modal-content input[type="url"],
.modal-content select, .modal-content input[type="date"], .modal-content textarea {
    width: 100%;
    padding: 12px 15px;
    margin-bottom: 0;
    border: 1px solid var(--grey-medium);
    border-radius: var(--border-radius-md);
    font-family: var(--font-primary);
    font-size: 1em;
    transition: border-color var(--transition-speed) var(--transition-ease), box-shadow var(--transition-speed) var(--transition-ease);
    box-shadow: var(--shadow-inset);
    background-color: #FFFFFF;
    color: var(--dark);
    min-height: 44px;
}
.modal-content textarea { min-height: 70px; resize: vertical; line-height: 1.6; }
.edit-form-container input:focus, .modal-content input:focus, .modal-content select:focus,
.modal-content input[type="date"]:focus, .modal-content textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-light), transparent 80%), var(--shadow-inset);
    outline: none;
}
.dark-mode .edit-form-container input[type="text"], .dark-mode .edit-form-container input[type="number"], .dark-mode .edit-form-container input[type="url"],
.dark-mode .modal-content input[type="text"], .dark-mode .modal-content input[type="number"], .dark-mode .modal-content input[type="url"],
.dark-mode .modal-content select, .dark-mode .modal-content input[type="date"], .dark-mode .modal-content textarea {
    background-color: var(--grey-light-dark-bg);
    border-color: var(--grey-medium-dark-border);
    color: var(--light);
    box-shadow: var(--shadow-dark-inset);
}
.dark-mode .edit-form-container input:focus, .dark-mode .modal-content input:focus, .dark-mode .modal-content select:focus,
.dark-mode .modal-content input[type="date"]:focus, .dark-mode .modal-content textarea:focus {
    border-color: var(--secondary);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--secondary-dark), transparent 80%), var(--shadow-dark-inset);
}
.modal-content input:read-only, .modal-content input:disabled, .modal-content textarea:read-only, .modal-content textarea:disabled { background-color: #eeeeee !important; cursor: not-allowed; opacity: 0.7; }
.dark-mode .modal-content input:read-only, .dark-mode .modal-content input:disabled, .dark-mode .modal-content textarea:read-only, .dark-mode .modal-content textarea:disabled { background-color: var(--grey-medium-dark-border) !important; opacity: 0.6; }

.payment-status-group { display: flex; gap: 15px; margin-bottom: 18px; align-items: center; justify-content: flex-start; padding: 10px; background-color: var(--partner-field-bg); border-radius: var(--border-radius-md); }
.dark-mode .payment-status-group { background-color: var(--partner-field-bg-dark); }
.payment-status-group label { margin-bottom: 0; display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 600; padding: 8px 10px; border-radius: var(--border-radius-sm); transition: background-color 0.2s ease; color: var(--dark); min-height: 40px; }
.dark-mode .payment-status-group label { color: var(--light); }
.payment-status-group input[type="radio"] { appearance: none; -webkit-appearance: none; margin: 0; width: 18px; height: 18px; border: 2px solid var(--grey-dark); border-radius: 50%; display: grid; place-content: center; transition: border-color 0.2s ease; }
.dark-mode .payment-status-group input[type="radio"] { border-color: var(--grey-medium); }
.payment-status-group input[type="radio"]::before { content: ""; width: 10px; height: 10px; border-radius: 50%; background-color: var(--accent); transform: scale(0); transition: transform 0.2s ease-in-out; }
.dark-mode .payment-status-group input[type="radio"]::before { background-color: var(--secondary); }
.payment-status-group input[type="radio"]:checked { border-color: var(--accent); }
.dark-mode .payment-status-group input[type="radio"]:checked { border-color: var(--secondary); }
.payment-status-group input[type="radio"]:checked::before { transform: scale(1); }
.payment-status-group label:hover { background-color: rgba(0, 0, 0, 0.05); }
.dark-mode .payment-status-group label:hover { background-color: rgba(255, 255, 255, 0.1); }

.form-buttons { display: flex; gap: 15px; margin-top: 30px; }
.form-buttons button, .modal-footer button { flex-grow: 1; padding: 12px 15px; border: none; border-radius: var(--border-radius-md); cursor: pointer; font-family: var(--font-primary); font-weight: 700; font-size: 1.05em; transition: all var(--transition-speed) var(--transition-ease); display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: var(--shadow-sm); min-height: 46px; }
.form-buttons button:hover:not(:disabled), .modal-footer button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: var(--shadow-md); }
.form-buttons button:active:not(:disabled), .modal-footer button:active:not(:disabled) { transform: translateY(-1px); box-shadow: var(--shadow-sm); }
.form-buttons button:disabled, .modal-footer button:disabled { opacity: 0.6; cursor: not-allowed; background: var(--grey-medium) !important; color: var(--grey-dark) !important; box-shadow: none !important; transform: none !important; text-shadow: none !important; }
.dark-mode .form-buttons button:disabled, .dark-mode .modal-footer button:disabled { background: var(--grey-medium-dark-border) !important; color: var(--grey-dark-dark-text) !important; }
.form-buttons .btn-save, .modal-footer .btn-save { background: linear-gradient(135deg, var(--info), var(--info-hover)); color: white; text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.1); }
.form-buttons .btn-save:hover:not(:disabled), .modal-footer .btn-save:hover:not(:disabled) { background: linear-gradient(135deg, var(--info-hover), var(--info)); }
.form-buttons .btn-cancel, .modal-footer .btn-cancel { background: linear-gradient(135deg, #B0BEC5, #90A4AE); color: #37474F; }
.form-buttons .btn-cancel:hover:not(:disabled), .modal-footer .btn-cancel:hover:not(:disabled) { background: linear-gradient(135deg, #90A4AE, #78909C); }
.dark-mode .form-buttons .btn-save, .dark-mode .modal-footer .btn-save { background: linear-gradient(135deg, var(--accent-dark), color-mix(in srgb, var(--accent-dark), black 15%)); color: var(--dark-bg); text-shadow: none; }
.dark-mode .form-buttons .btn-save:hover:not(:disabled), .dark-mode .modal-footer .btn-save:hover:not(:disabled) { background: linear-gradient(135deg, color-mix(in srgb, var(--accent-dark), black 15%), var(--accent-dark)); }
.dark-mode .form-buttons .btn-cancel, .dark-mode .modal-footer .btn-cancel { background: linear-gradient(135deg, #546E7A, #455A64); color: var(--light); }
.dark-mode .form-buttons .btn-cancel:hover:not(:disabled), .dark-mode .modal-footer .btn-cancel:hover:not(:disabled) { background: linear-gradient(135deg, #455A64, #37474F); }
/* Confirmation Button Specific Style */
#confirmActionBtn.btn-danger { background: linear-gradient(135deg, var(--danger), var(--danger-hover)) !important; color: white !important; text-shadow: 1px 1px 1px rgba(0,0,0,0.15); }
#confirmActionBtn.btn-danger:hover:not(:disabled) { background: linear-gradient(135deg, var(--danger-hover), var(--danger)) !important; }
.dark-mode #confirmActionBtn.btn-danger { background: linear-gradient(135deg, var(--danger-hover), var(--danger-dark)) !important; text-shadow: none; }
.dark-mode #confirmActionBtn.btn-danger:hover:not(:disabled) { background: linear-gradient(135deg, var(--danger-dark), var(--danger-hover)) !important; }

#confirmActionBtn.btn-warning { background: linear-gradient(135deg, var(--warning), var(--warning-hover)) !important; color: var(--dark-text-light) !important; text-shadow: none; }
#confirmActionBtn.btn-warning:hover:not(:disabled) { background: linear-gradient(135deg, var(--warning-hover), var(--warning)) !important; }
.dark-mode #confirmActionBtn.btn-warning { background: linear-gradient(135deg, var(--warning-hover-dark), var(--warning-dark)) !important; color: var(--dark-bg) !important; }
.dark-mode #confirmActionBtn.btn-warning:hover:not(:disabled) { background: linear-gradient(135deg, var(--warning-dark), var(--warning-hover-dark)) !important; }


/* Modal Styles */
.modal { position: fixed; inset: 0; background: rgba(var(--dark-bg-rgb), 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s var(--transition-ease), visibility 0s linear 0.3s; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); overflow-y: auto; padding: 20px; }
.modal.show { opacity: 1; visibility: visible; transition-delay: 0s; }
.modal-content { background: var(--grey-light); padding: 30px 35px; border-radius: var(--border-radius-lg); width: 90%; max-width: 580px; box-shadow: var(--shadow-lg); position: relative; transform: scale(0.95) translateY(15px); transition: transform 0.3s var(--transition-ease); margin: auto; color: var(--dark); }
.modal.show .modal-content { transform: scale(1) translateY(0); }
.dark-mode .modal { background: rgba(var(--dark-bg-rgb), 0.75); }
.dark-mode .modal-content { background: var(--grey-light-dark-bg); color: var(--light); box-shadow: var(--shadow-dark-lg); }
.modal-content h3 { margin-top: 0; margin-bottom: 25px; text-align: center; color: var(--primary); font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1.5em; }
.dark-mode .modal-content h3 { color: var(--primary-dark); }
.close-btn { position: absolute; top: 15px; left: 15px; background: none; border: none; font-size: 2.2em; color: var(--grey-dark); cursor: pointer; line-height: 1; padding: 5px; transition: color var(--transition-speed) var(--transition-ease), transform var(--transition-speed) var(--transition-ease); z-index: 10; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
.close-btn:hover { color: var(--danger); transform: rotate(90deg) scale(1.1); background-color: color-mix(in srgb, var(--danger-light), transparent 90%); }
.dark-mode .close-btn { color: var(--grey-dark-dark-text); }
.dark-mode .close-btn:hover { color: var(--danger-dark); background-color: color-mix(in srgb, var(--danger-dark), transparent 85%); }
#confirmMessage { font-size: 1.1em; line-height: 1.7; color: var(--dark); text-align: center; margin-bottom: 25px; }
.dark-mode #confirmMessage { color: var(--light); }
#logSaleModal .modal-content { max-width: 700px; }
#editSaleModal .modal-content { max-width: 750px; }

/* Sale Item Entry Styles (Log Sale) */
#logSaleModal .sale-item-entry { display: grid; grid-template-columns: 1fr auto auto auto; grid-template-rows: auto auto; gap: 8px 12px; align-items: end; margin-bottom: 18px; padding: 12px 15px; border: 1px solid transparent; border-radius: var(--border-radius-md); transition: background-color 0.2s ease, border-color 0.2s ease; background-color: color-mix(in srgb, var(--grey-medium), transparent 90%); }
.dark-mode #logSaleModal .sale-item-entry { border-color: transparent; background-color: color-mix(in srgb, var(--grey-medium-dark-border), transparent 90%); }
#logSaleModal .sale-item-entry.is-partner-sale { background-color: var(--partner-field-bg); border: 1px dashed var(--secondary); }
.dark-mode #logSaleModal .sale-item-entry.is-partner-sale { background-color: var(--partner-field-bg-dark); border-color: var(--secondary-dark); }
#logSaleModal .sale-item-entry label { display: block; font-size: 0.85em; color: var(--grey-dark); margin-bottom: 3px; font-weight: 500; }
.dark-mode #logSaleModal .sale-item-entry label { color: var(--grey-dark-dark-text); }
#logSaleModal .sale-item-entry select, #logSaleModal .sale-item-entry input { margin-bottom: 0; font-size: 0.95em; padding: 10px 12px; min-height: 42px; }

/* Grid Layout for Sale Item Entry */
#logSaleModal .sale-item-entry .sale-product-select-container { grid-column: 1 / -1; grid-row: 1; }
#logSaleModal .sale-item-entry .sale-cost-price-input-container { grid-column: 1 / 2; grid-row: 2; display: none; } /* Initially hidden */
#logSaleModal .sale-item-entry.is-partner-sale .sale-cost-price-input-container { display: block; } /* Shown for partner sales */
#logSaleModal .sale-item-entry .sale-selling-price-input-container { grid-column: 2 / 3; grid-row: 2; }
#logSaleModal .sale-item-entry.is-partner-sale .sale-selling-price-input-container { grid-column: 2 / 3; } /* Same column for partner sales */
#logSaleModal .sale-item-entry .sale-quantity-input-container { grid-column: 3 / 4; grid-row: 2; }
#logSaleModal .sale-item-entry .sale-quantity-input { width: 85px; text-align: center; }
#logSaleModal .sale-item-entry .remove-sale-item-btn { grid-column: 4 / 5; grid-row: 2; background: transparent; border: none; color: var(--danger); font-size: 1.6em; cursor: pointer; padding: 0 5px; transition: color 0.2s; justify-self: center; align-self: center; min-height: 40px; min-width: 40px; }
#logSaleModal .sale-item-entry .remove-sale-item-btn:hover { color: var(--danger-hover); }

/* Edit Sale Modal Layout */
#editSaleModal .edit-item-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-top: 15px; padding: 15px; background-color: var(--partner-field-bg); border-radius: var(--border-radius-md); border: 1px solid var(--grey-medium); }
.dark-mode #editSaleModal .edit-item-details { background-color: var(--partner-field-bg-dark); border-color: var(--grey-medium-dark-border); }
#editSaleModal .field-container { display: flex; flex-direction: column; }
#editSaleModal .field-container label { font-size: 0.9em; margin-bottom: 4px; color: var(--grey-dark); font-weight: 600; display: flex; align-items: center; gap: 5px; }
.dark-mode #editSaleModal .field-container label { color: var(--grey-dark-dark-text); }
#editSaleModal .field-container input { margin-bottom: 0; padding: 10px 12px; min-height: 42px; }
#editSaleModal .field-container input[readonly] { background-color: #e0e0e0 !important; opacity: 0.8; cursor: default; border-color: #ccc !important; }
.dark-mode #editSaleModal .field-container input[readonly] { background-color: var(--grey-medium-dark-border) !important; opacity: 0.8; border-color: var(--grey-medium-dark-border) !important; }

#add-sale-item-btn { display: block; width: auto; margin: 25px auto 20px auto; padding: 10px 25px; background-color: var(--accent); color: white; border: none; border-radius: var(--border-radius-md); cursor: pointer; font-weight: bold; box-shadow: var(--shadow-sm); transition: all var(--transition-speed) var(--transition-ease); min-height: 44px; font-size: 1em; }
#add-sale-item-btn:hover { background-color: color-mix(in srgb, var(--accent-light), black 10%); box-shadow: var(--shadow-md); transform: translateY(-2px); }
.dark-mode #add-sale-item-btn { background-color: var(--secondary); color: var(--dark-bg); }
.dark-mode #add-sale-item-btn:hover { background-color: color-mix(in srgb, var(--secondary-dark), black 10%); }

#salesReportModal .modal-content, #salesLogModal .modal-content { max-width: 1300px; } /* Increased width */
.report-controls { display: flex; flex-wrap: wrap; gap: 12px 15px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--grey-medium); align-items: flex-end; }
.dark-mode .report-controls { border-bottom-color: var(--grey-medium-dark-border); }
.report-controls > div { display: flex; flex-direction: column; flex-grow: 1; min-width: 150px; }
.report-controls label { margin-bottom: 5px; font-size: 0.9em; font-weight: 600; color: var(--grey-dark); }
.dark-mode .report-controls label { color: var(--grey-dark-dark-text); }
.report-controls input[type="date"], .report-controls select { width: 100%; margin-bottom: 0; padding: 10px 12px; font-size: 0.95em; min-height: 44px; }
.report-controls button { padding: 10px 15px; font-size: 0.95em; margin-top: auto; flex-grow: 0 !important; width: auto; min-width: 120px; min-height: 44px; }

#salesReportArea, #salesLogArea { margin-top: 25px; max-height: 65vh; overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; border: 1px solid var(--grey-medium); border-radius: var(--border-radius-md); padding: 15px; background: var(--partner-field-bg); }
.dark-mode #salesReportArea, .dark-mode #salesLogArea { border-color: var(--grey-medium-dark-border); background: var(--partner-field-bg-dark); }
#salesLogArea { overflow-x: auto; }

#salesReportArea h4, #salesLogArea h4 { margin: 5px 0 15px 0; text-align: center; color: var(--primary); font-size: 1.3em; padding-bottom: 10px; border-bottom: 1px solid var(--grey-medium); }
.dark-mode #salesReportArea h4, .dark-mode #salesLogArea h4 { color: var(--primary-dark); border-bottom-color: var(--grey-medium-dark-border); }

/* Enhanced Sales Log Table Styles */
.professional-report-table { width: 100%; border-collapse: collapse; font-size: 0.95em; table-layout: auto; margin-top: 15px; box-shadow: var(--shadow-sm); border-radius: var(--border-radius-md); overflow: hidden; background-color: #fff; min-width: 1300px; } /* Increased min-width */
.dark-mode .professional-report-table { background-color: var(--grey-light-dark-bg); }
.professional-report-table th, .professional-report-table td { border: 1px solid var(--grey-medium); padding: 12px 14px; text-align: right; vertical-align: middle; white-space: nowrap; }
.professional-report-table th { background-color: var(--grey-light); color: var(--dark); font-weight: 700; position: sticky; top: -16px; z-index: 1; border-bottom-width: 2px; border-bottom-color: var(--grey-medium); }
.dark-mode .professional-report-table th { background-color: var(--grey-light-dark-bg); color: var(--light); border-bottom-color: var(--grey-medium-dark-border); }
.professional-report-table tbody tr:nth-child(even) { background-color: color-mix(in srgb, var(--grey-medium), transparent 95%); }
.dark-mode .professional-report-table tbody tr:nth-child(even) { background-color: color-mix(in srgb, var(--grey-medium-dark-border), transparent 95%); }
.professional-report-table tbody tr:hover { background-color: color-mix(in srgb, var(--accent-light), transparent 92%); }
.dark-mode .professional-report-table tbody tr:hover { background-color: color-mix(in srgb, var(--accent-dark), transparent 88%); }
/* Wrap specific columns */
.professional-report-table .wrap-text { white-space: normal; min-width: 150px; vertical-align: top; line-height: 1.5; }
.professional-report-table td:nth-child(2), /* Buyer Name */
.professional-report-table td:nth-child(4) { /* Product Name */ white-space: normal; min-width: 140px; }
.professional-report-table td:nth-child(11) { /* Notes */ white-space: normal; min-width: 180px; }
.professional-report-table td:nth-child(5) { /* Product ID */ font-family: monospace; font-size: 0.85em; color: var(--grey-dark); }
.dark-mode .professional-report-table td:nth-child(5) { color: var(--grey-dark-dark-text); }
.professional-report-table td.number-cell { text-align: left; font-feature-settings: "tnum"; font-weight: 600; }
.professional-report-table .sale-status { font-weight: bold; text-align: center; padding: 5px 10px; border-radius: var(--border-radius-sm); display: inline-block; min-width: 70px; border: 1px solid transparent; font-size: 0.9em; }
.professional-report-table .sale-status-paid { color: var(--info); background-color: color-mix(in srgb, var(--info-light), transparent 90%); border-color: color-mix(in srgb, var(--info-light), transparent 70%); }
.professional-report-table .sale-status-debt { color: var(--current-debt-color); background-color: color-mix(in srgb, var(--debt-color), transparent 90%); border-color: color-mix(in srgb, var(--debt-color), transparent 70%); }
.dark-mode .professional-report-table .sale-status-paid { color: var(--info-dark); background-color: color-mix(in srgb, var(--info-dark), transparent 85%); border-color: color-mix(in srgb, var(--info-dark), transparent 60%); }
.dark-mode .professional-report-table .sale-status-debt { color: var(--current-debt-color); background-color: color-mix(in srgb, var(--debt-color-dark), transparent 85%); border-color: color-mix(in srgb, var(--debt-color-dark), transparent 60%); }
.professional-report-table .partner-profit { color: var(--current-partner-profit-color); font-weight: bold; background-color: color-mix(in srgb, var(--partner-profit-color), transparent 94%); }
.dark-mode .professional-report-table .partner-profit { background-color: color-mix(in srgb, var(--partner-profit-color-dark), transparent 90%); }
.professional-report-table .log-actions { text-align: center; white-space: nowrap; }
.professional-report-table .log-actions button { background: transparent; border: none; cursor: pointer; padding: 0 5px; font-size: 1.2em; opacity: 0.8; transition: opacity 0.2s, color 0.2s, transform 0.2s; margin: 0 5px; vertical-align: middle; min-height: 36px; min-width: 36px; }
.professional-report-table .log-actions .edit-sale-log-entry { color: var(--accent); }
.professional-report-table .log-actions .delete-sale-log-entry { color: var(--danger); }
.professional-report-table .log-actions button:hover:not(:disabled) { opacity: 1; transform: scale(1.1); }
.professional-report-table .log-actions .edit-sale-log-entry:hover:not(:disabled) { color: var(--info); }
.professional-report-table .log-actions .delete-sale-log-entry:hover:not(:disabled) { color: var(--danger-hover); }
.professional-report-table .log-actions button:disabled { opacity: 0.4; cursor: not-allowed; transform: none; color: var(--grey-dark) !important; }
.dark-mode .professional-report-table th, .dark-mode .professional-report-table td { border-color: var(--grey-medium-dark-border); }
.dark-mode .professional-report-table th { background-color: var(--grey-light-dark-bg); color: var(--light); border-bottom-color: var(--grey-medium-dark-border); }


#salesReportArea .report-summary p { font-size: 1.1em; font-weight: bold; margin-bottom: 12px; padding: 12px; border-bottom: 1px solid var(--grey-medium); background: var(--grey-light); border-radius: var(--border-radius-sm); }
.dark-mode #salesReportArea .report-summary p { border-bottom-color: var(--grey-medium-dark-border); background: var(--grey-light-dark-bg); }
#salesReportArea .report-summary span { color: var(--info); font-size: 1.05em; padding: 0 5px; }
.dark-mode #salesReportArea .report-summary span { color: var(--info-dark); }

#salesLogModal .modal-footer { margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--grey-medium); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
.dark-mode #salesLogModal .modal-footer { border-top-color: var(--grey-medium-dark-border); }
#salesLogModal #clear-log-btn { background: linear-gradient(135deg, var(--danger), var(--danger-hover)); color: white; flex-grow: 0; text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.15); font-size: 1em; padding: 10px 18px; }
#salesLogModal #clear-log-btn:hover:not(:disabled) { background: linear-gradient(135deg, var(--danger-hover), var(--danger)); transform: translateY(-3px); box-shadow: var(--shadow-md); }
#salesLogModal #clear-log-btn:active:not(:disabled) { transform: translateY(-1px); box-shadow: var(--shadow-sm); }
.dark-mode #salesLogModal #clear-log-btn { background: linear-gradient(135deg, var(--danger-hover), var(--danger-dark)); }
.dark-mode #salesLogModal #clear-log-btn:hover:not(:disabled) { background: linear-gradient(135deg, var(--danger-dark), var(--danger-hover)); }
#salesLogModal .modal-footer .btn-cancel { flex-grow: 0; font-size: 1em; padding: 10px 18px; }

#toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #263238; color: white; padding: 14px 25px; border-radius: var(--border-radius-md); z-index: 2000; font-size: 1em; box-shadow: var(--shadow-md); opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0s linear 0.4s, bottom 0.4s ease, transform 0.4s ease; font-weight: 700; width: calc(100% - 40px); max-width: 400px; text-align: center; bottom: calc(20px + env(safe-area-inset-bottom, 0px)); margin: 0 auto; }
#toast.show { opacity: 1; visibility: visible; bottom: calc(30px + env(safe-area-inset-bottom, 0px)); transition: opacity 0.4s ease, visibility 0s linear 0s, bottom 0.4s ease, transform 0.4s ease; }
#toast.error { background-color: var(--danger); }
#toast.warning { background-color: var(--warning); color: #212121; }
#toast.success { background-color: var(--info); }
#toast.info { background-color: var(--accent); }
.dark-mode #toast { background: #CFD8DC; color: #263238; }
.dark-mode #toast.error { background-color: var(--danger-hover); color: white; }
.dark-mode #toast.warning { background-color: var(--warning-dark); color: #424242; }
.dark-mode #toast.success { background-color: var(--info-hover); color: white; }
.dark-mode #toast.info { background-color: var(--accent-dark); color: white; }

.control-panel { position: fixed; display: flex; gap: 15px; z-index: 100; flex-direction: row; bottom: calc(15px + env(safe-area-inset-bottom, 0px)); left: 50%; transform: translateX(-50%); background-color: rgba(var(--grey-light-rgb), 0.9); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); padding: 10px 15px; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-md); border: 1px solid color-mix(in srgb, var(--grey-medium), transparent 50%); flex-wrap: wrap; justify-content: center; }
body.dark-mode .control-panel { background-color: rgba(var(--grey-light-dark-bg-rgb), 0.85); border-color: color-mix(in srgb, var(--grey-medium-dark-border), transparent 50%); }
.btn-magic { background: linear-gradient(145deg, var(--accent), color-mix(in srgb, var(--accent-light), white 10%)); border: none; width: 48px; height: 48px; border-radius: 50%; color: white; font-size: 1.5em; cursor: pointer; transition: all var(--transition-speed) var(--transition-ease); box-shadow: var(--shadow-sm); display: flex; justify-content: center; align-items: center; text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.1); flex-shrink: 0; }
.btn-magic i { line-height: 1; }
.btn-magic:hover:not(:disabled) { background: linear-gradient(145deg, color-mix(in srgb, var(--accent-light), white 10%), var(--accent)); transform: translateY(-4px) scale(1.08); box-shadow: var(--shadow-lg); }
.btn-magic:active:not(:disabled) { transform: translateY(-1px) scale(1.02); box-shadow: var(--shadow-sm); }
.btn-magic:disabled { opacity: 0.5; cursor: not-allowed; background: var(--grey-medium) !important; box-shadow: none !important; transform: none !important; }
.dark-mode .btn-magic { background: linear-gradient(145deg, var(--secondary), color-mix(in srgb, var(--secondary-dark), white 10%)); color: var(--dark-bg); box-shadow: var(--shadow-sm); text-shadow: none; }
.dark-mode .btn-magic:hover:not(:disabled) { background: linear-gradient(145deg, color-mix(in srgb, var(--secondary-dark), white 10%), var(--secondary)); }
.dark-mode .btn-magic:disabled { background: var(--grey-medium-dark-border) !important; color: var(--grey-dark-dark-text) !important; }
/* Specific Backup/Restore Button Colors */
.btn-backup { background: linear-gradient(145deg, var(--info), var(--info-hover)); }
.dark-mode .btn-backup { background: linear-gradient(145deg, var(--info-dark), var(--info-hover-dark)); }
.btn-restore { background: linear-gradient(145deg, var(--warning), var(--warning-hover)); color: var(--dark-text-light) !important; text-shadow: none; }
.dark-mode .btn-restore { background: linear-gradient(145deg, var(--warning-dark), var(--warning-hover-dark)); color: var(--dark-bg) !important; }

@media (max-width: 768px) {
    body { flex-direction: column; overflow-y: auto; height: auto; font-size: 15px; perspective: none; padding-bottom: 140px; } /* Increased padding */
    #detail-view-container { order: 1; height: auto; min-height: 40vh; padding: 20px 15px; overflow-y: visible; }
    .detail-content, .edit-form-container { padding: 20px 25px; max-width: none; margin-bottom: 15px; }
    .sidebar { order: 2; width: 100%; height: auto; min-height: 55vh; border-left: none; border-top: 1px solid var(--grey-medium); box-shadow: none; flex-shrink: 0; }
    .dark-mode .sidebar { border-top-color: var(--grey-medium-dark-border); }
    #items-list { max-height: none; padding: 10px; overflow-y: visible; flex-grow: 1; }
    .sidebar-header { padding: 15px; font-size: 1.2em; }
    .sidebar-footer { padding: 12px 15px; flex-shrink: 0; }
    .item-card { padding: 10px 12px; min-height: 70px; gap: 12px; }
    .item-icon { width: 40px; height: 40px; }
    .item-details h4 { font-size: 1.05em; }
    .item-details p { font-size: 0.85em; }
    .item-actions { opacity: 1; }
    .item-actions button { width: 32px; height: 32px; font-size: 0.9em; }
    .modal-content { width: 95%; padding: 25px 20px; max-width: 95%; }
    .form-buttons { flex-direction: column; gap: 12px; }
    .detail-content .history-section { max-height: 150px; }
    /* Responsive Sale Item Entry */
    #logSaleModal .sale-item-entry { grid-template-columns: 1fr auto; grid-template-rows: auto auto auto auto; gap: 8px 10px; padding: 10px; }
    #logSaleModal .sale-item-entry .sale-product-select-container { grid-column: 1 / -1; grid-row: 1; }
    #logSaleModal .sale-item-entry .sale-cost-price-input-container { grid-column: 1 / -1; grid-row: 2; }
    #logSaleModal .sale-item-entry .sale-selling-price-input-container { grid-column: 1 / 2; grid-row: 3; }
    #logSaleModal .sale-item-entry .sale-quantity-input-container { grid-column: 2 / 3; grid-row: 3; }
    #logSaleModal .sale-item-entry .sale-quantity-input { width: 70px; }
    #logSaleModal .sale-item-entry .remove-sale-item-btn { grid-column: 1 / -1; grid-row: 4; justify-self: center; margin-top: 8px; width: 80%; padding: 8px; font-size: 1.2em; background-color: color-mix(in srgb, var(--danger-light), transparent 90%); border: 1px solid var(--danger); border-radius: var(--border-radius-sm); }
    .dark-mode #logSaleModal .sale-item-entry .remove-sale-item-btn { background-color: color-mix(in srgb, var(--danger-dark), transparent 85%); border-color: var(--danger-dark); }
    /* Responsive Edit Sale */
    #editSaleModal .edit-item-details { grid-template-columns: 1fr; }
    #salesReportModal .report-controls, #salesLogModal .report-controls { flex-direction: column; gap: 10px; }
    #salesReportModal .report-controls > div, #salesLogModal .report-controls > div { width: 100%; }
    #salesReportModal .report-controls button { width: 100%; margin-top: 5px; }
    .professional-report-table { font-size: 0.85em; min-width: 900px; } /* Adjusted min-width */
    .professional-report-table th, .professional-report-table td { padding: 8px 10px; }
    #salesLogModal .modal-footer { justify-content: space-around; }
    /* Specific nowrap columns for sales log (Adjusted indices) */
    #salesLogTable th:nth-child(1), #salesLogTable td:nth-child(1), /* Date */
    #salesLogTable th:nth-child(6), #salesLogTable td:nth-child(6), /* Qty */
    #salesLogTable th:nth-child(12), #salesLogTable td:nth-child(12), /* Status */
    #salesLogTable th:nth-child(13), #salesLogTable td:nth-child(13) /* Actions */
    { white-space: nowrap; }
    .control-panel { gap: 10px; padding: 8px 12px; width: calc(100% - 20px); justify-content: space-around; left: 10px; transform: none; }
    .btn-magic { width: 44px; height: 44px; font-size: 1.4em; }
}
@media (min-width: 769px) {
    #toast { width: auto; max-width: 450px; left: 50%; transform: translateX(-50%); right: auto; }
    .item-actions { margin-right: 0; }
    .control-panel { width: auto; } /* Revert width change on larger screens */
}
    </style>
</head>
<body>
    <div id="offlineBanner" class="offline-banner">أنت غير متصل حالياً. قد تكون بعض البيانات غير محدثة.</div>
    <div id="detail-view-container">
        <div class="detail-placeholder" id="main-placeholder">🔄 تهيئة النظام...</div>
    </div>
    <div class="sidebar">
        <div class="sidebar-header">
             <span><i class="fas fa-store"></i> المنتجات v10.10</span>
             <span id="connectionStatus" class="connection-status-dot connecting" title="حالة الاتصال"></span>
        </div>
        <div id="items-list">
             <div class="empty-list-placeholder" id="list-placeholder" style="display: none;">جارٍ تحميل المنتجات...</div>
        </div>
        <div class="sidebar-footer">
             <div id="footer-summary">
                  إجمالي المدفوع: <span id="all-paid-sales-summary">جار التحميل...</span>
             </div>
             <div id="debts-summary">
                  الديون المطلوبة: <span id="total-debts-amount">جار التحميل...</span>
             </div>
             <button class="report-btn" onclick="window.generateBuyerReport()" title="فتح تقرير المبيعات حسب المشتري (HTML)"><i class="fas fa-user-tag"></i> تقرير المشترين (HTML)</button>
             <button class="report-btn" onclick="window.generateInventoryHTMLReport()" title="فتح تقرير المنتجات الحالية (HTML)"><i class="fas fa-boxes"></i> تقرير المنتجات (HTML)</button>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addFormModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="window.hideAddForm()" title="إغلاق">&times;</button>
            <h3><i class="fas fa-box-open"></i> إضافة منتج جديد</h3>
            <div class="form-field-group">
                <label for="itemName"><i class="fas fa-tag"></i> اسم المنتج:</label>
                <input type="text" id="itemName" placeholder="مثال: قميص قطني أزرق..." required>
            </div>
            <div class="form-field-group">
                <label for="itemPrice"><i class="fas fa-dollar-sign"></i> سعر البيع (د.ع):</label>
                <input type="number" id="itemPrice" placeholder="مثال: 25000" required min="0" step="any">
            </div>
            <div class="form-field-group">
                <label for="itemPartnerCost"><i class="fas fa-handshake"></i><i class="fas fa-money-bill-wave"></i> سعر التكلفة للشريك (د.ع) (اختياري):</label>
                <input type="number" id="itemPartnerCost" placeholder="اتركه فارغاً أو 0 إذا لم يطبق" min="0" step="any">
            </div>
            <div class="form-field-group">
                <label for="itemIconUrl"><i class="fas fa-image"></i> رابط الأيقونة (اختياري):</label>
                <input type="url" id="itemIconUrl" placeholder="اتركه فارغاً للأيقونة التلقائية">
            </div>
            <!-- ملاحظة: لا يوجد حقل لـ partnerName هنا حالياً -->
            <div class="form-buttons">
                <button id="addItemBtn" class="btn-save" onclick="window.addItem()"><i class="fas fa-plus"></i> إضافة المنتج</button>
                <button class="btn-cancel" onclick="window.hideAddForm()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Log Sale Modal -->
    <div id="logSaleModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="window.hideLogSaleModal()" title="إغلاق">&times;</button>
            <h3><i class="fas fa-cash-register"></i> تسجيل عملية بيع جديدة</h3>

            <div class="form-field-group">
                <label for="saleDate"><i class="fas fa-calendar-alt"></i> تاريخ البيع:</label>
                <input type="date" id="saleDate" required>
            </div>

            <div class="form-field-group">
                <label for="salePartner"><i class="fas fa-handshake"></i> نوع البيع / الشريك:</label>
                <select id="salePartner" onchange="window.handlePartnerSelectionChange(this)">
                     <option value="">بيع مباشر (لا يوجد شريك)</option>
                     <option value="حسن">شريك: حسن</option> <!-- شريك حسن مضاف بشكل ثابت -->
                     <!-- <option value="علي">شريك: علي</option> --> <!-- مثال لشريك آخر يمكنك إضافته -->
                     <!-- أضف المزيد من الشركاء هنا إذا لزم الأمر -->
                </select>
            </div>

            <div class="form-field-group">
                <label for="saleBuyerName"><i class="fas fa-user"></i> اسم المشتري:</label>
                <input type="text" id="saleBuyerName" placeholder="اسم العميل (اختياري)">
            </div>

             <div class="form-field-group">
                <label for="saleNotes"><i class="fas fa-sticky-note"></i> ملاحظات (اختياري):</label>
                <textarea id="saleNotes" placeholder="اكتب أي ملاحظات حول هذه البيعة هنا (مثل قياس، لون خاص، تبديل، إلخ)..." rows="2"></textarea>
            </div>

            <div class="form-field-group">
                <label><i class="fas fa-money-bill-wave"></i> حالة الدفع:</label>
                <div class="payment-status-group">
                    <label><input type="radio" id="saleStatusPaid" name="salePaymentStatus" value="paid" checked><span>تم الدفع</span></label>
                    <label><input type="radio" id="saleStatusDebt" name="salePaymentStatus" value="debt"><span>دين</span></label>
                </div>
            </div>

            <hr style="margin: 25px 0; border: none; border-top: 1px dashed var(--grey-medium);">
            <label style="font-weight: bold; margin-bottom: 15px; display:block; font-size: 1.1em;"><i class="fas fa-shopping-cart"></i> البنود المباعة:</label>
            <div id="sale-items-list">
                 <!-- Sale item entries generated by JS -->
            </div>
            <button type="button" id="add-sale-item-btn" onclick="window.addSaleItemEntry()"><i class="fas fa-plus"></i> إضافة بند آخر</button>

            <div class="form-buttons">
                <button id="saveSaleBtn" class="btn-save" onclick="window.saveSales()"><i class="fas fa-save"></i> حفظ المبيعات</button>
                <button class="btn-cancel" onclick="window.hideLogSaleModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Edit Sale Modal -->
    <div id="editSaleModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="window.hideEditSaleModal()" title="إغلاق">&times;</button>
            <h3><i class="fas fa-edit"></i> تعديل عملية بيع</h3>
            <input type="hidden" id="editSaleId">

            <div class="form-field-group">
                <label for="editSaleDate"><i class="fas fa-calendar-alt"></i> تاريخ البيع:</label>
                <input type="date" id="editSaleDate" required>
            </div>

            <div class="field-container form-field-group">
                <label for="editPartnerNameDisplay"><i class="fas fa-handshake"></i> الشريك:</label>
                <input type="text" id="editPartnerNameDisplay" readonly disabled> <!-- Partner is read-only -->
            </div>

            <div class="form-field-group">
                <label for="editSaleBuyerName"><i class="fas fa-user"></i> اسم المشتري:</label>
                <input type="text" id="editSaleBuyerName" placeholder="اسم العميل (اختياري)">
            </div>

            <div class="form-field-group">
                <label for="editSaleNotes"><i class="fas fa-sticky-note"></i> الملاحظات:</label>
                <textarea id="editSaleNotes" placeholder="اكتب أي ملاحظات..." rows="3"></textarea>
            </div>

            <div class="form-field-group">
                <label><i class="fas fa-money-bill-wave"></i> حالة الدفع:</label>
                <div class="payment-status-group">
                    <label><input type="radio" id="editSaleStatusPaid" name="editSalePaymentStatus" value="paid"><span>تم الدفع</span></label>
                    <label><input type="radio" id="editSaleStatusDebt" name="editSalePaymentStatus" value="debt"><span>دين</span></label>
                </div>
            </div>

            <hr style="margin: 25px 0; border: none; border-top: 1px dashed var(--grey-medium);">
            <label style="font-weight: bold; margin-bottom: 10px; display:block; font-size: 1.1em;"><i class="fas fa-box"></i> تفاصيل البند:</label>
             <div class="edit-item-details">
                 <div class="field-container">
                     <label for="editSaleProductName"><i class="fas fa-tag"></i> المنتج:</label>
                     <input type="text" id="editSaleProductName" readonly disabled> <!-- Product name is read-only -->
                 </div>
                 <div class="field-container edit-cost-price-container" style="display: none;">
                     <label for="editSaleCostPrice"><i class="fas fa-dollar-sign"></i> التكلفة (المسجلة):</label>
                     <input type="number" id="editSaleCostPrice" placeholder="التكلفة" readonly disabled> <!-- Cost is read-only -->
                 </div>
                 <div class="field-container">
                      <label for="editSaleSellingPrice" class="edit-price-label"><i class="fas fa-money-bill-alt"></i> سعر البيع:</label>
                      <input type="number" id="editSaleSellingPrice" placeholder="سعر البيع" min="0" step="any" required>
                 </div>
                 <div class="field-container">
                     <label for="editSaleQuantity"><i class="fas fa-boxes"></i> الكمية:</label>
                     <input type="number" id="editSaleQuantity" placeholder="الكمية" min="1" required>
                 </div>
                 <div class="field-container">
                     <label><i class="fas fa-calculator"></i> الإجمالي:</label>
                     <input type="text" id="editSaleTotalDisplay" readonly disabled style="font-weight: bold; font-size: 1.1em; background-color: color-mix(in srgb, var(--grey-medium), transparent 50%) !important;">
                      <span style="font-size: 0.8em; color: var(--grey-dark); margin-top: 4px;">(الكمية × سعر البيع)</span>
                 </div>
            </div>
            <div class="form-buttons">
                 <button id="updateSaleBtn" class="btn-save" onclick="window.updateSaleEntry()"><i class="fas fa-save"></i> حفظ التعديلات</button>
                 <button class="btn-cancel" onclick="window.hideEditSaleModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Sales Report Modal -->
    <div id="salesReportModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="window.hideSalesReportModal()" title="إغلاق">&times;</button>
            <h3><i class="fas fa-chart-line"></i> تقارير المبيعات</h3>
            <div class="report-controls">
                <div> <label for="reportStartDate">من تاريخ:</label> <input type="date" id="reportStartDate" required> </div>
                <div> <label for="reportEndDate">إلى تاريخ:</label> <input type="date" id="reportEndDate" required> </div>
                <div> <label for="reportPaymentStatusFilter">حالة الدفع:</label>
                    <select id="reportPaymentStatusFilter">
                        <option value="all">الكل</option>
                        <option value="paid">مدفوع فقط</option>
                        <option value="debt">دين فقط</option>
                    </select>
                </div>
                 <div> <label for="reportPartnerFilter"><i class="fas fa-handshake"></i> الشريك:</label>
                    <select id="reportPartnerFilter">
                        <option value="all">الكل (مباشر وشركاء)</option>
                        <option value="direct">بيع مباشر فقط</option>
                        <option value="حسن">حسن فقط</option> <!-- شريك حسن مضاف بشكل ثابت -->
                        <!-- <option value="علي">علي فقط</option> --> <!-- مثال لشريك آخر يمكنك إضافته -->
                         <!-- أضف المزيد من الشركاء هنا إذا لزم الأمر -->
                    </select>
                </div>
                <div> <label>&nbsp;</label> <button class="btn-save" onclick="window.generateSalesReport('summary')"><i class="fas fa-list-alt"></i> ملخص وتفاصيل</button> </div>
                <div> <label>&nbsp;</label> <button class="btn-save" onclick="window.generateSalesReport('bestSellerQty')"><i class="fas fa-star"></i> الأكثر مبيعاً (كمية)</button> </div>
                <div> <label>&nbsp;</label> <button class="btn-save" onclick="window.generateSalesReport('bestSellerValue')"><i class="fas fa-dollar-sign"></i> الأكثر مبيعاً (قيمة)</button> </div>
                <div> <label>&nbsp;</label> <button class="btn-save" onclick="window.generateSalesReport('buyerSummary')"><i class="fas fa-users"></i> ملخص حسب المشتري</button> </div>
                <div> <label>&nbsp;</label> <button class="btn-save" onclick="window.generateSalesReport('partnerSummary')"><i class="fas fa-handshake"></i> ملخص حسب الشريك</button> </div>
                <div> <label>&nbsp;</label> <button class="btn-save" onclick="window.exportSalesToCSV()"><i class="fas fa-file-csv"></i> تصدير CSV</button> </div>
            </div>
            <div id="salesReportArea">
                <p class="detail-placeholder">اختر فترة زمنية ونوع التقرير لعرض البيانات.</p>
            </div>
        </div>
    </div>

    <!-- Sales Log Modal -->
    <div id="salesLogModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="window.hideSalesLogModal()" title="إغلاق">&times;</button>
            <h3><i class="fas fa-history"></i> سجل المبيعات المفصل</h3>
            <div id="salesLogArea">
                <p class="detail-placeholder">جارٍ تحميل السجل...</p>
                <table id="salesLogTable" class="professional-report-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>التاريخ والوقت</th>      <!-- 1 -->
                            <th class="wrap-text">المشتري</th>    <!-- 2 -->
                            <th>الشريك</th>             <!-- 3 -->
                            <th class="wrap-text">اسم المنتج</th> <!-- 4 -->
                            <th>معرف المنتج</th>         <!-- 5 -->
                            <th>الكمية</th>             <!-- 6 -->
                            <th>سعر التكلفة</th>       <!-- 7 -->
                            <th>سعر البيع</th>         <!-- 8 -->
                            <th>الإجمالي</th>           <!-- 9 -->
                            <th>الربح التقريبي</th>     <!-- 10 -->
                            <th class="wrap-text">الملاحظات</th> <!-- 11 -->
                            <th>الحالة</th>             <!-- 12 -->
                            <th>إجراء</th>             <!-- 13 -->
                        </tr>
                    </thead>
                    <tbody><!-- Log entries will be populated here --></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button id="clear-log-btn" onclick="window.confirmClearSalesLog()"><i class="fas fa-exclamation-triangle"></i> مسح كل السجل</button>
                <button class="btn-cancel" onclick="window.hideSalesLogModal()">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="window.hideConfirmModal()" title="إغلاق">&times;</button>
            <h3 id="confirmTitle"><i class="fas fa-exclamation-triangle"></i> تأكيد الإجراء</h3>
            <div id="confirmMessage" style="text-align: center; margin-bottom: 25px; font-size: 1.1em;">هل أنت متأكد؟</div>
            <div class="form-buttons">
                <button id="confirmActionBtn" class="btn-save"><i class="fas fa-check"></i> نعم، تأكيد</button> <!-- Class/Style set dynamically -->
                <button class="btn-cancel" onclick="window.hideConfirmModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"></div>

    <!-- Floating Control Panel -->
    <div class="control-panel">
        <button class="btn-magic" onclick="window.toggleDarkMode()" title="تبديل الوضع"><i class="fas fa-lightbulb"></i></button>
        <button class="btn-magic" onclick="window.showAddForm()" title="إضافة منتج جديد"><i class="fas fa-plus"></i></button>
        <button class="btn-magic" onclick="window.showLogSaleModal()" title="تسجيل عملية بيع"><i class="fas fa-cash-register"></i></button>
        <button class="btn-magic" onclick="window.showSalesLogModal()" title="عرض سجل المبيعات"><i class="fas fa-history"></i></button>
        <button class="btn-magic" onclick="window.showSalesReportModal()" title="عرض تقارير المبيعات"><i class="fas fa-chart-line"></i></button>
        <button class="btn-magic btn-backup" onclick="window.backupData()" title="إنشاء نسخة احتياطية للبيانات"><i class="fas fa-download"></i></button>
        <button class="btn-magic btn-restore" onclick="window.triggerRestore()" title="استعادة بيانات من نسخة احتياطية"><i class="fas fa-upload"></i></button>
    </div>

    <!-- Hidden File Input for Restore -->
    <input type="file" id="restoreFile" accept=".json" style="display: none;">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getFirestore, enableIndexedDbPersistence, collection, collectionGroup, query, orderBy, onSnapshot, getDocs, limit, where, addDoc, updateDoc, deleteDoc, doc, serverTimestamp, Timestamp, getDoc, writeBatch, getCountFromServer } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

        // --- Firebase Config ---
        // تأكد من أن هذه المعلومات صحيحة لمشروع Firebase الخاص بك
        const firebaseConfig = { apiKey: "AIzaSyABUQJfis7wbSn508w1RuGCd6ZsoxMoEEAAIzaSyABUQJfis7wbSn508w1RuGCd6ZsoxMoEEA", authDomain: "storedatabase-642e0.firebaseapp.com", projectId: "storedatabase-642e0", storageBucket: "storedatabase-642e0.appspot.com", messagingSenderId: "806751758744", appId: "1:806751758744:web:079104a8fe4e73cdc023ed", measurementId: "G-778H49MMJK" };

        // --- Global Variables ---
        let app;
        let db;
        let unsubscribeItems = null;
        let itemsMap = new Map(); // Stores full item data {id, name, price, icon, partnerCost, createdAt, updatedAt}
        let currentEditItemId = null;
        let currentViewItemId = null;
        let isDefinitelyOffline = !navigator.onLine;
        let latestSnapshotMetadata = { fromCache: true, hasPendingWrites: false };
        let firstLoadComplete = false;
        const defaultIcon = 'https://img.icons8.com/fluency/48/ffffff/box.png'; // White outline icon
        const HISTORY_LIMIT = 15;
        const SALES_LOG_LIMIT = 500; // Increased limit
        const CLEAR_LOG_PASSWORD = "0750";
        const BACKUP_VERSION = "1.0"; // Version for backup file structure
        const BATCH_DELETE_LIMIT = 450; // Firestore batch write limit (use slightly less than 500)
        let professionalTipInterval = null;
        let toastTimer = null;

        // --- Constants & Maps ---
        const professionalTips = [
            "💡 تذكر: ابتسامة لطيفة عند التعامل مع الزبون تترك انطباعاً إيجابياً دائماً.", "💡 خاطب الزبون باحترام واستخدم ألقاباً مثل 'أستاذ' أو 'حضرتك'.", "💡 استمع جيداً لاحتياجات الزبون قبل عرض المنتجات.", "💡 كن خبيراً بمنتجاتك واشرح ميزاتها بوضوح وثقة.", "💡 قدم حلولاً ومقترحات للزبون بدلاً من مجرد عرض البضاعة.", "💡 حافظ على مظهر المحل نظيفاً ومنظماً.", "💡 اهتم بالتفاصيل الصغيرة، فهي تصنع فرقاً كبيراً في تجربة العميل.", "💡 لا تتردد في طلب رأي الزبون حول الخدمة أو المنتج.", "💡 عرض المنتجات بشكل جذاب ومنظم يسهل على الزبون الاختيار.", "💡 كن صبوراً مع الزبائن المترددين وقدم المساعدة بلطف.", "💡 تابع مع الزبائن الدائمين وقدم لهم عروضاً خاصة.", "💡 كلمة 'شكراً' بعد إتمام البيع تزيد من ولاء الزبون.", "💡 تحليل تقارير المبيعات يساعدك على فهم المنتجات الأكثر طلباً.", "💡 تنظيم المخزون بشكل دوري يمنع نفاد البضاعة أو تكدسها.", "💡 كتابة ملاحظات دقيقة عند تسجيل البيع تساعدك لاحقاً في المتابعة أو التبديل.", "💡 تحديد سعر تكلفة للشريك مسبقاً يسهل عملية تسجيل البيع للشريك.", "💡 استخدم ميزة النسخ الاحتياطي بانتظام لحماية بياناتك."
        ];
        const keywordIconMap = { 'قميص': 'https://img.icons8.com/fluency/48/ffffff/shirt.png', 'تيشيرت': 'https://img.icons8.com/fluency/48/ffffff/t-shirt.png', 'تي شيرت': 'https://img.icons8.com/fluency/48/ffffff/t-shirt.png', 'بولو': 'https://img.icons8.com/fluency/48/ffffff/polo-shirt.png', 'بنطلون': 'https://img.icons8.com/fluency/48/ffffff/pantaloon.png', 'جينز': 'https://img.icons8.com/fluency/48/ffffff/jeans.png', 'سروال': 'https://img.icons8.com/fluency/48/ffffff/pantaloon.png', 'شورت': 'https://img.icons8.com/fluency/48/ffffff/shorts.png', 'برمودا': 'https://img.icons8.com/fluency/48/ffffff/bermuda-shorts.png', 'فستان': 'https://img.icons8.com/fluency/48/ffffff/dress.png', 'تنورة': 'https://img.icons8.com/fluency/48/ffffff/skirt.png', 'جيبة': 'https://img.icons8.com/fluency/48/ffffff/skirt.png', 'جاكيت': 'https://img.icons8.com/fluency/48/ffffff/jacket.png', 'سترة': 'https://img.icons8.com/fluency/48/ffffff/vest.png', 'معطف': 'https://img.icons8.com/fluency/48/ffffff/coat.png', 'بليزر': 'https://img.icons8.com/fluency/48/ffffff/blazer.png', 'هودي': 'https://img.icons8.com/fluency/48/ffffff/hoodie.png', 'كنزة': 'https://img.icons8.com/fluency/48/ffffff/sweater.png', 'بلوفر': 'https://img.icons8.com/fluency/48/ffffff/sweater.png', 'حذاء': 'https://img.icons8.com/fluency/48/ffffff/trainers.png', 'احذية': 'https://img.icons8.com/fluency/48/ffffff/trainers.png', 'رياضي': 'https://img.icons8.com/fluency/48/ffffff/sneakers.png', 'جزمة': 'https://img.icons8.com/fluency/48/ffffff/boot.png', 'كعب': 'https://img.icons8.com/fluency/48/ffffff/high-heels.png', 'صندل': 'https://img.icons8.com/fluency/48/ffffff/sandal.png', 'شبشب': 'https://img.icons8.com/fluency/48/ffffff/slippers.png', 'ملابس داخلية': 'https://img.icons8.com/fluency/48/ffffff/underwear.png', 'داخلي': 'https://img.icons8.com/fluency/48/ffffff/underwear.png', 'بدي': 'https://img.icons8.com/fluency/48/ffffff/bodysuit.png', 'بيجامة': 'https://img.icons8.com/fluency/48/ffffff/pajamas.png', 'قبعة': 'https://img.icons8.com/fluency/48/ffffff/baseball-cap.png', 'طاقية': 'https://img.icons8.com/fluency/48/ffffff/winter-hat.png', 'كاب': 'https://img.icons8.com/fluency/48/ffffff/baseball-cap.png', 'وشاح': 'https://img.icons8.com/fluency/48/ffffff/scarf.png', 'شال': 'https://img.icons8.com/fluency/48/ffffff/scarf.png', 'قفاز': 'https://img.icons8.com/fluency/48/ffffff/gloves.png', 'كفوف': 'https://img.icons8.com/fluency/48/ffffff/gloves.png', 'حزام': 'https://img.icons8.com/fluency/48/ffffff/belt.png', 'ربطة': 'https://img.icons8.com/fluency/48/ffffff/tie.png', 'حقيبة': 'https://img.icons8.com/fluency/48/ffffff/handbag.png', 'شنطة': 'https://img.icons8.com/fluency/48/ffffff/school-bag.png' };

        // --- DOM Element References ---
        const itemsListEl = document.getElementById('items-list');
        const listPlaceholderEl = document.getElementById('list-placeholder');
        const detailViewContainerEl = document.getElementById('detail-view-container');
        const footerSummaryEl = document.getElementById('footer-summary');
        const allPaidSalesSummarySpan = document.getElementById('all-paid-sales-summary');
        const debtsSummaryDiv = document.getElementById('debts-summary');
        const totalDebtsAmountSpan = document.getElementById('total-debts-amount');
        const addFormModalEl = document.getElementById('addFormModal');
        const logSaleModalEl = document.getElementById('logSaleModal');
        const editSaleModalEl = document.getElementById('editSaleModal');
        const salesReportModalEl = document.getElementById('salesReportModal');
        const salesLogModalEl = document.getElementById('salesLogModal');
        const confirmModalEl = document.getElementById('confirmModal');
        const confirmMessageEl = document.getElementById('confirmMessage');
        const confirmTitleEl = document.getElementById('confirmTitle');
        const confirmActionBtnEl = document.getElementById('confirmActionBtn');
        const toastEl = document.getElementById('toast');
        const offlineBannerEl = document.getElementById('offlineBanner');
        const connectionStatusDotEl = document.getElementById('connectionStatus');
        const addFormButton = addFormModalEl?.querySelector('#addItemBtn');
        const saleItemsListContainer = document.getElementById('sale-items-list');
        const salesReportArea = document.getElementById('salesReportArea');
        const salesLogTableBody = salesLogModalEl?.querySelector('#salesLogTable tbody');
        const clearLogBtn = document.getElementById('clear-log-btn');
        const salesLogCloseBtn = salesLogModalEl?.querySelector('.modal-footer .btn-cancel');
        const salesLogModalCloseIconBtn = salesLogModalEl?.querySelector('.close-btn');
        const updateSaleBtn = document.getElementById('updateSaleBtn');
        const restoreFileInput = document.getElementById('restoreFile');
        const backupBtn = document.querySelector('.btn-backup');
        const restoreBtn = document.querySelector('.btn-restore');

        // --- Utility Functions ---
        function formatCurrency(amount) {
            const num = parseFloat(amount);
            if (isNaN(num)) { return '-'; }
            const numberPart = num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            return `${numberPart} د.ع`;
        }

        function formatFirestoreTimestamp(timestamp, includeTime = true) {
            if (!timestamp) return '-';
            try {
                let date;
                if (timestamp?.toDate && typeof timestamp.toDate === 'function') {
                    date = timestamp.toDate();
                } else if (timestamp instanceof Date) {
                    date = timestamp;
                } else if (typeof timestamp === 'string') {
                    date = new Date(timestamp);
                } else {
                    date = new Date(timestamp);
                }
                if (isNaN(date.getTime())) return 'تاريخ غير صالح';

                const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
                if (includeTime) {
                    options.hour = '2-digit';
                    options.minute = '2-digit';
                    options.hour12 = true;
                }
                return date.toLocaleString('ar-EG', options).replace('،', '');
            } catch (e) {
                console.warn("Timestamp formatting error:", e, "Input:", timestamp);
                return 'تاريخ غير صالح';
            }
        }

        function escapeHtml(unsafe) {
             if (unsafe === null || typeof unsafe === 'undefined') return '';
             return String(unsafe)
                  .replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;")
                  .replace(/"/g, "&quot;")
                  .replace(/'/g, "&#039;");
        }

        function getIconForName(name) {
            if (!name) return defaultIcon;
            const lowerCaseName = name.toLowerCase();
            const keywords = Object.keys(keywordIconMap).sort((a, b) => b.length - a.length);
            for (const keyword of keywords) {
                if (lowerCaseName.includes(keyword.toLowerCase())) {
                    return keywordIconMap[keyword];
                }
            }
            return defaultIcon;
        }

        function updateConnectionStatusUI(online) {
            isDefinitelyOffline = !online;
            offlineBannerEl.classList.toggle('show', !online);
            connectionStatusDotEl.className = 'connection-status-dot';
            if (!online) {
                connectionStatusDotEl.classList.add('disconnected');
                connectionStatusDotEl.title = 'غير متصل بالإنترنت';
            } else {
                if (latestSnapshotMetadata.hasPendingWrites) {
                    connectionStatusDotEl.classList.add('syncing');
                    connectionStatusDotEl.title = 'متصل (جاري مزامنة التغييرات...)';
                } else if (latestSnapshotMetadata.fromCache && !firstLoadComplete) {
                    connectionStatusDotEl.classList.add('connecting');
                    connectionStatusDotEl.title = 'متصل (البيانات من الذاكرة المؤقتة)';
                } else {
                    connectionStatusDotEl.classList.add('connected');
                    connectionStatusDotEl.title = 'متصل ومُحدّث';
                }
            }
            if (backupBtn) backupBtn.disabled = !online;
            if (restoreBtn) restoreBtn.disabled = !online;
        }

        function updateMainViewStatus(message, isError = false) {
            if (!detailViewContainerEl) return;
            const safeMessage = escapeHtml(message);
            if (isError) {
                detailViewContainerEl.innerHTML = `<div class="detail-error"><strong><i class="fas fa-exclamation-circle"></i> خطأ:</strong> ${safeMessage}</div>`;
            } else {
                if (!currentViewItemId && !currentEditItemId) {
                    detailViewContainerEl.innerHTML = `<div class="detail-placeholder">${safeMessage}</div>`;
                }
            }
        }

        // --- Item Rendering & Management ---
        function renderItemCard(itemData) {
            const existingCard = itemsListEl?.querySelector(`.item-card[data-id="${itemData.id}"]`);
            const displayIcon = itemData.icon || getIconForName(itemData.name) || defaultIcon;
            const partnerCostDisplay = itemData.partnerCost > 0 ? `<p style="font-size: 0.8em; opacity: 0.7; margin-top: 2px;">تكلفة شريك: ${formatCurrency(itemData.partnerCost)}</p>` : '';
            const cardHTML = `
                <img class="item-icon" src="${escapeHtml(displayIcon)}" alt="${escapeHtml(itemData.name)}" loading="lazy" onerror="this.onerror=null; this.src='${defaultIcon}'">
                <div class="item-details">
                    <h4>${escapeHtml(itemData.name)}</h4>
                    <p>السعر: ${formatCurrency(itemData.price)}</p>
                    ${partnerCostDisplay}
                </div>
                <div class="item-actions">
                    <button class="edit-btn" onclick="event.stopPropagation(); window.showEditForm('${itemData.id}')" title="تعديل المنتج"><i class="fas fa-edit"></i></button>
                    <button class="delete-btn" onclick="event.stopPropagation(); window.showConfirmModal('${itemData.id}', 'product')" title="حذف المنتج"><i class="fas fa-trash-alt"></i></button>
                </div>`;

            if (existingCard) {
                existingCard.innerHTML = cardHTML;
                existingCard.classList.toggle('selected', itemData.id === currentViewItemId || itemData.id === currentEditItemId);
                existingCard.classList.toggle('has-pending-writes', latestSnapshotMetadata.hasPendingWrites && !latestSnapshotMetadata.fromCache);
            } else if (itemsListEl) {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.setAttribute('data-id', itemData.id);
                card.innerHTML = cardHTML;
                card.classList.toggle('selected', itemData.id === currentViewItemId || itemData.id === currentEditItemId);
                card.classList.toggle('has-pending-writes', latestSnapshotMetadata.hasPendingWrites && !latestSnapshotMetadata.fromCache);
                card.addEventListener('click', () => showItemDetails(itemData.id));

                let inserted = false;
                const cards = itemsListEl.querySelectorAll('.item-card');
                const newItemNameLower = itemData.name.toLowerCase();
                for (let i = 0; i < cards.length; i++) {
                    const currentCardId = cards[i].getAttribute('data-id');
                    const currentCardData = itemsMap.get(currentCardId);
                    const currentCardNameLower = currentCardData?.name?.toLowerCase() ?? '';
                    if (newItemNameLower.localeCompare(currentCardNameLower, 'ar') < 0) {
                        itemsListEl.insertBefore(card, cards[i]);
                        inserted = true;
                        break;
                    }
                }
                if (!inserted) {
                    itemsListEl.appendChild(card);
                }
            }

            if (listPlaceholderEl) {
                listPlaceholderEl.style.display = itemsMap.size > 0 ? 'none' : (firstLoadComplete ? 'block' : 'none');
                if (firstLoadComplete && itemsMap.size === 0) {
                    listPlaceholderEl.textContent = "➕ لا توجد منتجات. انقر على زر (+) للإضافة.";
                }
            }
        }

        function removeItemCard(itemId) {
            const cardToRemove = itemsListEl?.querySelector(`.item-card[data-id="${itemId}"]`);
            if (cardToRemove) {
                cardToRemove.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                cardToRemove.style.opacity = '0';
                cardToRemove.style.transform = 'scale(0.9)';
                setTimeout(() => {
                     cardToRemove.remove();
                     if (listPlaceholderEl) {
                         listPlaceholderEl.style.display = itemsMap.size > 0 ? 'none' : 'block';
                         if (itemsMap.size === 0) listPlaceholderEl.textContent = "➕ لا توجد منتجات. انقر على زر (+) للإضافة.";
                     }
                }, 300);
            } else {
                 if (listPlaceholderEl) {
                     listPlaceholderEl.style.display = itemsMap.size > 0 ? 'none' : 'block';
                     if (itemsMap.size === 0) listPlaceholderEl.textContent = "➕ لا توجد منتجات. انقر على زر (+) للإضافة.";
                 }
            }
        }

        async function showItemDetails(itemId) {
            if (!db) { showNotification("الخدمة غير جاهزة لعرض التفاصيل.", true); return; }
            const item = itemsMap.get(itemId);
            if (!item) {
                updateMainViewStatus(`لم يتم العثور على المنتج (ID: ${itemId}). ربما تم حذفه.`, true);
                currentViewItemId = null;
                itemsListEl?.querySelector('.item-card.selected')?.classList.remove('selected');
                return;
            }
            if (currentViewItemId === itemId && !currentEditItemId) return;

            currentEditItemId = null;
            currentViewItemId = itemId;
            itemsListEl?.querySelectorAll('.item-card').forEach(card => card.classList.toggle('selected', card.getAttribute('data-id') === itemId));

            const createdAtFormatted = formatFirestoreTimestamp(item.createdAt);
            const updatedAtFormatted = formatFirestoreTimestamp(item.updatedAt);
            const displayIcon = item.icon || getIconForName(item.name) || defaultIcon;

            const historyCollectionRef = collection(db, 'clothes', itemId, 'history');
            const qHistory = query(historyCollectionRef, orderBy('timestamp', 'desc'), limit(HISTORY_LIMIT));
            let historyHtml = '<ul>';
            let historyEntriesFound = false;
            try {
                const historySnapshot = await getDocs(qHistory);
                if (!historySnapshot.empty) {
                     historyEntriesFound = true;
                    historySnapshot.docs.forEach(doc => {
                        const d = doc.data();
                        const ts = formatFirestoreTimestamp(d.timestamp);
                        let c = [];
                        if (d.changes?.name) c.push(`<span class="change-detail">الاسم: <del>${escapeHtml(d.changes.name.old)}</del> ← ${escapeHtml(d.changes.name.new)}</span>`);
                        if (d.changes?.price !== undefined) c.push(`<span class="change-detail">سعر البيع: <del>${formatCurrency(d.changes.price.old ?? 0)}</del> ← ${formatCurrency(d.changes.price.new ?? 0)}</span>`);
                         if (d.changes?.partnerCost !== undefined) c.push(`<span class="change-detail">تكلفة الشريك: <del>${formatCurrency(d.changes.partnerCost.old ?? 0)}</del> ← ${formatCurrency(d.changes.partnerCost.new ?? 0)}</span>`);
                        if (d.changes?.icon) c.push(`<span class="change-detail">تحديث رابط الأيقونة.</span>`);

                        if (c.length > 0) {
                             historyHtml += `<li><span class="history-timestamp">${ts}</span>${c.join('')}</li>`;
                        }
                    });
                    if (historySnapshot.docs.length >= HISTORY_LIMIT) {
                        historyHtml += `<li class="no-history" style="text-align:center; opacity: 0.7;"><em>(عرض أحدث ${HISTORY_LIMIT} تعديل)</em></li>`;
                    }
                }
            } catch (error) {
                console.error("History fetch error:", error);
                historyHtml += '<li class="no-history" style="color: var(--danger);"><em>خطأ في جلب سجل التعديلات.</em></li>';
                 historyEntriesFound = true;
            }
            if (!historyEntriesFound) historyHtml += '<li class="no-history"><em>لا يوجد سجل تعديلات.</em></li>';
             historyHtml += '</ul>';

            const partnerCostInfo = item.partnerCost > 0 ? `
                <p class="partner-cost-info"><strong><i class="fas fa-handshake"></i> تكلفة الشريك:</strong> <span style="font-weight:700; color: var(--secondary); font-size: 1.1em;">${formatCurrency(item.partnerCost)}</span></p>` : '';

            if (detailViewContainerEl) {
                detailViewContainerEl.innerHTML = `
                    <div class="detail-content">
                        <img src="${escapeHtml(displayIcon)}" alt="${escapeHtml(item.name)}" class="detail-icon" onerror="this.onerror=null; this.src='${defaultIcon}'">
                        <h2>${escapeHtml(item.name)}</h2>
                        <p><strong><i class="fas fa-dollar-sign"></i> سعر البيع:</strong> <span style="font-weight:700; color: var(--info); font-size: 1.1em;">${formatCurrency(item.price)}</span></p>
                        ${partnerCostInfo}

                        <div class="history-section">
                            <h4><i class="fas fa-history"></i> سجل تعديلات المنتج <small>(غير مشمول بالنسخ الاحتياطي)</small></h4>
                            ${historyHtml}
                        </div>

                        <div class="timestamp">
                           <i class="fas fa-plus-circle"></i> أنشئ: ${createdAtFormatted} | <i class="fas fa-edit"></i> آخر تعديل: ${updatedAtFormatted || '-'}
                        </div>
                        <div class="form-buttons" style="margin-top: 20px;">
                            <button class="btn-save" onclick="window.showEditForm('${item.id}')"><i class="fas fa-edit"></i> تعديل المنتج</button>
                        </div>
                        <p style="font-size:0.8em; opacity:0.6; text-align:center; margin-top:15px; user-select: text;">ID: ${escapeHtml(item.id)}</p>
                    </div>`;
            }
        }

        function showEditForm(itemId) {
            const item = itemsMap.get(itemId);
            if (!item) {
                showNotification("المنتج غير موجود للتعديل!", true);
                itemsListEl?.querySelector('.item-card.selected')?.classList.remove('selected');
                currentEditItemId = null;
                currentViewItemId = null;
                updateMainViewStatus("المنتج المطلوب غير موجود.");
                return;
            }
            currentViewItemId = null;
            currentEditItemId = itemId;
            itemsListEl?.querySelectorAll('.item-card').forEach(card => card.classList.toggle('selected', card.getAttribute('data-id') === itemId));

            const currentIcon = item.icon || '';
            const currentPartnerCost = item.partnerCost ?? '';

            if (detailViewContainerEl) {
                detailViewContainerEl.innerHTML = `
                    <div class="edit-form-container">
                        <h3><i class="fas fa-edit"></i> تعديل المنتج</h3>
                        <input type="hidden" id="editItemId" value="${escapeHtml(item.id)}">
                        <div class="form-field-group">
                             <label for="editItemName"><i class="fas fa-tag"></i> الاسم:</label>
                             <input type="text" id="editItemName" value="${escapeHtml(item.name)}" required>
                        </div>
                        <div class="form-field-group">
                             <label for="editItemPrice"><i class="fas fa-dollar-sign"></i> سعر البيع (د.ع):</label>
                             <input type="number" id="editItemPrice" value="${item.price}" required min="0" step="any">
                        </div>
                        <div class="form-field-group">
                             <label for="editItemPartnerCost"><i class="fas fa-handshake"></i><i class="fas fa-money-bill-wave"></i> سعر التكلفة للشريك (د.ع) (اختياري):</label>
                             <input type="number" id="editItemPartnerCost" value="${currentPartnerCost}" placeholder="اتركه فارغاً أو 0" min="0" step="any">
                        </div>
                        <div class="form-field-group">
                             <label for="editItemIcon"><i class="fas fa-image"></i> رابط الأيقونة:</label>
                             <input type="url" id="editItemIcon" value="${escapeHtml(currentIcon)}" placeholder="اتركه فارغاً للأيقونة الافتراضية">
                        </div>
                        <div class="form-buttons">
                            <button id="updateItemBtn" class="btn-save" onclick="window.updateItem()"><i class="fas fa-save"></i> حفظ التغييرات</button>
                            <button class="btn-cancel" onclick="window.cancelEdit()">إلغاء</button>
                        </div>
                    </div>`;
                 detailViewContainerEl.querySelector('#editItemName')?.focus();
            }
        }

        function cancelEdit() {
            const previousEditId = currentEditItemId;
            currentEditItemId = null;
            const card = itemsListEl?.querySelector(`.item-card[data-id="${previousEditId}"]`);
            if (card) card.classList.remove('selected');

            const itemExists = itemsMap.has(previousEditId);
            if (previousEditId && itemExists) {
                showItemDetails(previousEditId);
            } else {
                updateMainViewStatus(itemsMap.size > 0 ? "👈 اختر منتجاً لعرض التفاصيل." : "➕ لا توجد منتجات.");
                currentViewItemId = null;
            }
        }

        async function addItem() {
            if (!db || !addFormButton || !addFormModalEl) { showNotification('الخدمة غير جاهزة.', true); return; }

            const nameInput = addFormModalEl.querySelector('#itemName');
            const priceInput = addFormModalEl.querySelector('#itemPrice');
            const partnerCostInput = addFormModalEl.querySelector('#itemPartnerCost');
            const iconUrlInput = addFormModalEl.querySelector('#itemIconUrl');

            const name = nameInput.value.trim();
            const price = parseFloat(priceInput.value);
            const partnerCostValue = partnerCostInput.value.trim();
            const iconUrl = iconUrlInput.value.trim();

            if (!name || isNaN(price) || price < 0) {
                showNotification('يرجى إدخال اسم المنتج وسعر البيع الصحيح!', true);
                return;
            }

             let partnerCost = null;
             if (partnerCostValue !== "") {
                partnerCost = parseFloat(partnerCostValue);
                if (isNaN(partnerCost) || partnerCost < 0) {
                    showNotification('سعر تكلفة الشريك غير صالح. يرجى إدخال رقم موجب أو اتركه فارغاً.', true);
                    return;
                }
                if (partnerCost > price) {
                     showNotification('تحذير: سعر تكلفة الشريك أعلى من سعر البيع!', false, 'warning');
                }
             }

            addFormButton.disabled = true;
            addFormButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جارٍ الإضافة...';
            let finalIconUrl = iconUrl ? iconUrl : (getIconForName(name) || defaultIcon);

            const newItemData = {
                name: name,
                price: price,
                partnerCost: partnerCost,
                icon: finalIconUrl,
                createdAt: serverTimestamp(),
                updatedAt: null
            };

            try {
                const docRef = await addDoc(collection(db, 'clothes'), newItemData);
                showNotification(`✅ تم إضافة "${escapeHtml(name)}" بنجاح!`, false, 'success');
                hideAddForm();
                nameInput.value = '';
                priceInput.value = '';
                partnerCostInput.value = '';
                iconUrlInput.value = '';

                 setTimeout(async () => {
                    if(itemsMap.has(docRef.id)) {
                        await showItemDetails(docRef.id);
                        const newCard = itemsListEl?.querySelector(`.item-card[data-id="${docRef.id}"]`);
                        newCard?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                        console.warn("New item not yet in map after add, cannot show details immediately.");
                    }
                 }, 500);

            } catch (error) {
                showNotification(`خطأ في إضافة المنتج: ${error.message}`, true);
                console.error("Add item error: ", error);
            } finally {
                if (addFormButton) {
                    addFormButton.disabled = false;
                    addFormButton.innerHTML = '<i class="fas fa-plus"></i> إضافة المنتج';
                }
            }
        }

        async function updateItem() {
            if (!db || !detailViewContainerEl) { showNotification('الخدمة غير جاهزة.', true); return; }

            const updateButton = detailViewContainerEl.querySelector('#updateItemBtn');
            const itemIdInput = detailViewContainerEl.querySelector('#editItemId');
            const nameInput = detailViewContainerEl.querySelector('#editItemName');
            const priceInput = detailViewContainerEl.querySelector('#editItemPrice');
            const partnerCostInput = detailViewContainerEl.querySelector('#editItemPartnerCost');
            const iconInput = detailViewContainerEl.querySelector('#editItemIcon');

            if (!updateButton || !itemIdInput || !nameInput || !priceInput || !partnerCostInput || !iconInput) {
                showNotification('خطأ: لم يتم العثور على حقول التعديل.', true);
                return;
            }

            updateButton.disabled = true;
            updateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جارٍ الحفظ...';

            const itemId = itemIdInput.value;
            const name = nameInput.value.trim();
            const price = parseFloat(priceInput.value);
            const partnerCostValue = partnerCostInput.value.trim();
            let newIconUrl = iconInput.value.trim();

            if (!itemId || !name || isNaN(price) || price < 0) {
                showNotification('يرجى ملء الاسم وسعر البيع بشكل صحيح!', true);
                if (updateButton) { updateButton.disabled = false; updateButton.innerHTML = '<i class="fas fa-save"></i> حفظ التغييرات'; }
                return;
            }

             let partnerCost = null;
             if (partnerCostValue !== "") {
                partnerCost = parseFloat(partnerCostValue);
                if (isNaN(partnerCost) || partnerCost < 0) {
                    showNotification('سعر تكلفة الشريك غير صالح. يرجى إدخال رقم موجب أو اتركه فارغاً.', true);
                     if (updateButton) { updateButton.disabled = false; updateButton.innerHTML = '<i class="fas fa-save"></i> حفظ التغييرات'; }
                    return;
                }
                 if (partnerCost > price) {
                     showNotification('تحذير: سعر تكلفة الشريك أعلى من سعر البيع!', false, 'warning');
                 }
             }

            const itemRef = doc(db, 'clothes', itemId);
            const historyRef = collection(db, 'clothes', itemId, 'history');

            try {
                const currentDocSnap = await getDoc(itemRef);
                if (!currentDocSnap.exists()) { throw new Error("المستند غير موجود!"); }
                const currentData = currentDocSnap.data();
                const currentIcon = currentData.icon || '';
                 const currentPartnerCost = currentData.partnerCost ?? null;

                if (!newIconUrl) {
                     const autoIcon = getIconForName(name);
                     if ((autoIcon !== defaultIcon && currentIcon === defaultIcon) || (autoIcon !== defaultIcon && autoIcon !== currentIcon) ) {
                          newIconUrl = autoIcon;
                     } else {
                         newIconUrl = currentIcon || defaultIcon;
                     }
                } else {
                    newIconUrl = newIconUrl || defaultIcon;
                }

                const iconChanged = newIconUrl !== currentIcon;
                const nameChanged = currentData.name !== name;
                const priceChanged = Math.abs((currentData.price || 0) - price) > 0.001;
                 const partnerCostChanged = currentPartnerCost !== partnerCost;

                if (!nameChanged && !priceChanged && !iconChanged && !partnerCostChanged) {
                     showNotification('لم يتم إجراء تغييرات.', false, 'info');
                     currentEditItemId = null;
                     await showItemDetails(itemId);
                     return;
                }

                const updatedData = {
                    name: name,
                    price: price,
                    partnerCost: partnerCost,
                    icon: newIconUrl,
                    updatedAt: serverTimestamp()
                };

                const logEntry = { timestamp: serverTimestamp(), changes: {} };
                if (nameChanged) logEntry.changes.name = { old: currentData.name, new: name };
                if (priceChanged) logEntry.changes.price = { old: currentData.price, new: price };
                if (partnerCostChanged) logEntry.changes.partnerCost = { old: currentPartnerCost, new: partnerCost };
                if (iconChanged) logEntry.changes.icon = { old: currentIcon, new: newIconUrl };

                const batch = writeBatch(db);
                batch.update(itemRef, updatedData);
                 if (Object.keys(logEntry.changes).length > 0) {
                     batch.set(doc(historyRef), logEntry);
                 }
                await batch.commit();

                showNotification('✅ تم تحديث المنتج بنجاح!', false, 'success');
                currentEditItemId = null;
                await showItemDetails(itemId);

            } catch (error) {
                showNotification(`خطأ في تحديث المنتج: ${error.message}`, true);
                console.error("Update item error: ", error);
            } finally {
                 const stillEditing = detailViewContainerEl?.querySelector('#updateItemBtn');
                 if (stillEditing) {
                     stillEditing.disabled = false;
                     stillEditing.innerHTML = '<i class="fas fa-save"></i> حفظ التغييرات';
                 }
            }
        }

        // --- Confirmation Modal ---
        function showConfirmModal(id, type = 'product', data = null) {
            if (!id && type !== 'clearSales' && type !== 'restoreBackup') return;
            if (!confirmModalEl || !confirmTitleEl || !confirmMessageEl || !confirmActionBtnEl) {
                console.error("Confirm modal elements not found");
                return;
            }

            let message = "هل أنت متأكد؟";
            let title = "<i class='fas fa-exclamation-triangle'></i> تأكيد الإجراء";
            let action = () => {};
            let confirmButtonText = '<i class="fas fa-check"></i> نعم، تأكيد';
            let confirmButtonClass = 'btn-danger'; // Default to danger for delete actions
            let iconClass = 'fa-check';

            if (type === 'product') {
                const item = itemsMap.get(id);
                if (!item) { showNotification('المنتج غير موجود!', true); return; }
                const safeItemName = escapeHtml(item.name);
                title = `<i class="fas fa-trash-alt"></i> تأكيد حذف المنتج`;
                message = `هل أنت متأكد من حذف المنتج: <strong style="color: var(--danger); font-weight: bold;">${safeItemName}</strong>؟<br><small>(لا يمكن التراجع عن حذف المنتج نفسه)</small>`;
                action = () => deleteItem(id);
                iconClass = 'fa-trash-alt';
                confirmButtonText = `<i class="fas ${iconClass}"></i> نعم، حذف المنتج`;

            } else if (type === 'saleEntry') {
                title = `<i class="fas fa-eraser"></i> تأكيد حذف سجل البيع`;
                message = `هل أنت متأكد من حذف هذا السجل؟ <br><small>(لا يمكن التراجع)</small>`;
                action = () => deleteSalesLogEntry(id);
                iconClass = 'fa-eraser';
                confirmButtonText = `<i class="fas ${iconClass}"></i> نعم، حذف السجل`;

            } else if (type === 'clearSales') {
                title = `<i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> تأكيد مسح السجل بالكامل`;
                message = `تحذير! سيتم حذف <strong style="color: var(--danger);">جميع</strong> سجلات المبيعات بشكل نهائي.<br><strong>لا يمكن التراجع عن هذا الإجراء.</strong> هل أنت متأكد؟`;
                action = () => executeClearSalesLog();
                iconClass = 'fa-skull-crossbones';
                confirmButtonText = `<i class="fas ${iconClass}"></i> نعم، مسح الكل`;

            } else if (type === 'restoreBackup') {
                 title = `<i class="fas fa-upload" style="color: var(--warning);"></i> تأكيد الاستعادة`;
                 message = `<strong style="color: var(--danger); display: block; font-size: 1.2em; margin-bottom: 10px;">⚠ تحذير خطير! ⚠</strong>
                            سيتم <strong style="color: var(--danger);">حذف جميع المنتجات وسجلات المبيعات الحالية</strong> بشكل نهائي واستبدالها بالبيانات من الملف المختار.
                            <br><br>
                            <strong style="color: var(--warning);">تأكد من أنك اخترت الملف الصحيح وأنه لديك نسخة احتياطية حديثة إذا كنت غير متأكد.</strong>
                            <br><br>
                            هل أنت متأكد تماماً من المتابعة؟`;
                 action = () => processRestoreFile(data.file);
                 iconClass = 'fa-upload';
                 confirmButtonClass = 'btn-warning'; // Use warning style for restore
                 confirmButtonText = `<i class="fas ${iconClass}"></i> نعم، حذف واستعادة`;
            }
            else {
                console.error("Unknown confirmation type:", type);
                return;
            }

            confirmTitleEl.innerHTML = title;
            confirmMessageEl.innerHTML = message;
            confirmActionBtnEl.onclick = action;
            // Apply base class btn-save for structure, then add specific danger/warning class
            confirmActionBtnEl.className = `btn-save ${confirmButtonClass}`;
            confirmActionBtnEl.innerHTML = confirmButtonText;

            confirmModalEl.classList.add('show');
        }

        function hideConfirmModal() {
            confirmModalEl?.classList.remove('show');
        }

        // --- Item Deletion ---
        async function deleteItem(itemId) {
            if (!db) { showNotification('الخدمة غير جاهزة.', true); return; }

            const item = itemsMap.get(itemId);
            const itemName = item ? item.name : `ID: ${itemId}`;
            hideConfirmModal();
            showNotification(`⏳ جارٍ حذف "${escapeHtml(itemName)}"...`, false, 'info');

            try {
                // Note: History subcollection is NOT deleted automatically.
                // Add code here to delete history if required, using deleteCollection helper.
                await deleteDoc(doc(db, 'clothes', itemId));

                // UI updates (removal from list, clearing view) are handled by the listener.
                showNotification(`✅ تم حذف "${escapeHtml(itemName)}".`, false, 'success');

                 // If the deleted item was being viewed or edited, clear the main view immediately
                 if (currentViewItemId === itemId) { currentViewItemId = null; updateMainViewStatus("🗑️ تم حذف المنتج."); }
                 if (currentEditItemId === itemId) { currentEditItemId = null; updateMainViewStatus("🗑️ تم حذف المنتج."); }

                 // Refresh product dropdowns as the deleted item should be removed
                 populateProductSelectsInModals();

            } catch (error) {
                showNotification(`خطأ حذف "${escapeHtml(itemName)}": ${error.message}`, true);
                console.error("Delete item error: ", error);
            }
        }

        // --- HTML Reports ---
        function generateInventoryHTMLReport() {
             if (itemsMap.size === 0) { showNotification("لا توجد منتجات لإنشاء تقرير.", false, 'warning'); return; }

             let reportWindow = null;
             try {
                 // 1. Open window immediately
                 reportWindow = window.open("", "_blank", "noopener,noreferrer");
                 if (reportWindow) {
                     reportWindow.document.write('<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>تقرير المنتجات - جارٍ التحميل...</title><style>body{font-family:sans-serif; padding: 20px; text-align: center;} h1{color:#555;}</style></head><body><h1><i class="fas fa-spinner fa-spin"></i> جارٍ تحضير تقرير المنتجات...</h1></body></html>');
                     reportWindow.document.close(); // Close stream for initial write
                 } else {
                     showNotification("⚠️ فشل فتح نافذة التقرير. يرجى التأكد من السماح بالنوافذ المنبثقة لهذا الموقع.", true, 'warning');
                     return; // Stop if window couldn't be opened
                 }

                 // 2. Prepare report content (asynchronously)
                 showNotification('⏳ تحضير تقرير المنتجات...', false, 'info');
                 let reportHtml = `<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>تقرير المنتجات</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Changa:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet"><style>body{font-family:'Tajawal','Changa',sans-serif;direction:rtl;margin:20px;background-color:#fdfdfd;color:#333;font-size:14px}h1{text-align:center;color:#B71C1C;border-bottom:2px solid #FF6F00;padding-bottom:10px;margin-bottom:25px;font-size:1.8em}table{width:100%;border-collapse:collapse;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);background-color:#fff;border:1px solid #ddd}th,td{border:1px solid #ddd;padding:10px 12px;text-align:right;vertical-align:middle}th{background-color:#f5f5f5;font-weight:700;color:#424242;font-size:1.1em}tr:nth-child(even){background-color:#fbfbfb}tr:hover{background-color:#f0f0f0}td.number-cell{text-align:left;font-feature-settings:"tnum";font-weight:600}td.id-cell{font-size:0.85em;color:#777;font-family:monospace; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}.footer{text-align:center;margin-top:25px;font-size:0.9em;color:#777;border-top:1px solid #ccc;padding-top:15px}@media print{body{margin:10px;background-color:#fff;font-size:12px}h1{font-size:1.5em;margin-bottom:15px}table{box-shadow:none;border:1px solid #ccc}th,td{padding:6px 8px} td.id-cell{max-width: 100px;}}</style></head><body><h1><i class="fas fa-boxes"></i> تقرير المنتجات الحالية</h1><table><thead><tr><th>#</th><th>اسم المنتج</th><th>سعر البيع</th><th>تكلفة الشريك</th><th>تاريخ الإنشاء</th><th>آخر تعديل</th><th>المعرف (ID)</th></tr></thead><tbody>`;
                 let index = 0;
                 const sortedItems = Array.from(itemsMap.values()).sort((a, b) => a.name.localeCompare(b.name, 'ar'));
                 sortedItems.forEach((item) => {
                     index++;
                     const createdAt = formatFirestoreTimestamp(item.createdAt, false);
                     const updatedAt = formatFirestoreTimestamp(item.updatedAt, false);
                     const partnerCostFormatted = item.partnerCost > 0 ? formatCurrency(item.partnerCost) : '-';
                     reportHtml += `<tr><td>${index}</td><td>${escapeHtml(item.name)}</td><td class="number-cell">${formatCurrency(item.price)}</td><td class="number-cell">${partnerCostFormatted}</td><td>${createdAt}</td><td>${updatedAt}</td><td class="id-cell" title="${escapeHtml(item.id)}">${escapeHtml(item.id)}</td></tr>`;
                 });
                 reportHtml += `</tbody></table><div class="footer">إجمالي أنواع المنتجات: ${itemsMap.size}<br>تاريخ التقرير: ${new Date().toLocaleString('ar-EG')}</div></body></html>`;

                 // 3. Write final content to the already opened window
                 reportWindow.document.open(); // Re-open stream
                 reportWindow.document.write(reportHtml);
                 reportWindow.document.close(); // Close stream
                 showNotification('✅ تم فتح تقرير المنتجات.', false, 'success');

             } catch (e) {
                 showNotification("فشل إنشاء تقرير المنتجات.", true);
                 console.error("Inventory HTML Report error:", e);
                 // If window was opened, try to write error message there
                 if (reportWindow && !reportWindow.closed) {
                    try {
                         reportWindow.document.open();
                         reportWindow.document.write('<html><body><h1>خطأ</h1><p>حدث خطأ أثناء إنشاء التقرير.</p></body></html>');
                         reportWindow.document.close();
                     } catch (writeError) {
                         console.error("Error writing error message to report window:", writeError);
                     }
                 }
             }
        }

        async function generateBuyerReport() {
             if (!db) { showNotification("الخدمة غير جاهزة.", true); return; }

             let reportWindow = null;
             try {
                 // 1. Open window immediately
                 reportWindow = window.open("", "_blank", "noopener,noreferrer");
                 if (reportWindow) {
                     reportWindow.document.write('<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>تقرير المشترين - جارٍ التحميل...</title><style>body{font-family:sans-serif; padding: 20px; text-align: center;} h1{color:#555;}</style></head><body><h1><i class="fas fa-spinner fa-spin"></i> جارٍ تحضير تقرير المشترين...</h1></body></html>');
                     reportWindow.document.close();
                 } else {
                      showNotification("⚠️ فشل فتح نافذة التقرير. يرجى التأكد من السماح بالنوافذ المنبثقة.", true, 'warning');
                      return;
                 }

                 // 2. Fetch data and prepare report
                 showNotification('⏳ تحضير تقرير المشترين...', false, 'info');
                 const salesRef = collection(db, 'sales');
                 const q = query(salesRef, orderBy('saleTimestamp', 'desc'));
                 const salesSnapshot = await getDocs(q);

                 if (salesSnapshot.empty) {
                     reportWindow.document.open();
                     reportWindow.document.write('<html><body><h1>لا توجد بيانات</h1><p>لا توجد مبيعات مسجلة لإنشاء التقرير.</p></body></html>');
                     reportWindow.document.close();
                     showNotification("لا توجد مبيعات مسجلة لإنشاء التقرير.", false, 'warning');
                     return;
                 }

                 const buyerSales = {};
                 let totalOverallValue = 0; let totalOverallQuantity = 0;
                 salesSnapshot.docs.forEach(doc => {
                     const sale = doc.data();
                     const buyerName = sale.buyerName?.trim() || 'زبون غير مسجل';
                     const saleValue = sale.totalSaleAmount || 0;
                     const saleQuantity = sale.quantitySold || 0;
                     if (!buyerSales[buyerName]) { buyerSales[buyerName] = { name: buyerName, qty: 0, value: 0 }; }
                     buyerSales[buyerName].qty += saleQuantity;
                     buyerSales[buyerName].value += saleValue;
                     totalOverallQuantity += saleQuantity;
                     totalOverallValue += saleValue;
                 });
                 const sortedBuyers = Object.values(buyerSales).sort((a, b) => b.value - a.value);

                 let reportHtml = `<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>تقرير المبيعات حسب المشتري</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Changa:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet"><style>body{font-family:'Tajawal','Changa',sans-serif;direction:rtl;margin:20px;background-color:#fdfdfd;color:#333;font-size:14px}h1{text-align:center;color:#0D47A1;border-bottom:2px solid #FF6F00;padding-bottom:10px;margin-bottom:25px;font-size:1.8em}table{width:100%;border-collapse:collapse;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);background-color:#fff;border:1px solid #ddd}th,td{border:1px solid #ddd;padding:10px 12px;text-align:right;vertical-align:middle}th{background-color:#e3f2fd;font-weight:700;color:#0D47A1;font-size:1.1em}tr:nth-child(even){background-color:#fbfbfb}tr:hover{background-color:#f0f8ff}td.number-cell{text-align:left;font-feature-settings:"tnum";font-weight:700}.footer{text-align:center;margin-top:25px;font-size:0.9em;color:#777;border-top:1px solid #ccc;padding-top:15px}.summary-total{font-weight:bold;background-color:#eee;font-size:1.1em}@media print{body{margin:10px;background-color:#fff;font-size:12px}h1{font-size:1.5em;margin-bottom:15px}table{box-shadow:none;border:1px solid #ccc}th,td{padding:6px 8px}}</style></head><body><h1><i class="fas fa-users"></i> تقرير المبيعات حسب المشتري</h1><p style="text-align:center;margin-bottom:15px;color:#555;">(الإجمالي بناءً على سعر البيع النهائي - يشمل جميع المبيعات المسجلة)</p><table><thead><tr><th>#</th><th>اسم المشتري</th><th>إجمالي الكمية</th><th>إجمالي القيمة</th></tr></thead><tbody>`;
                 let index = 0;
                 sortedBuyers.forEach((buyer) => { index++; reportHtml += `<tr><td>${index}</td><td>${escapeHtml(buyer.name)}</td><td class="number-cell">${buyer.qty.toLocaleString('ar-IQ')}</td><td class="number-cell">${formatCurrency(buyer.value)}</td></tr>`; });
                 reportHtml += `<tr class="summary-total"><td colspan="2"><strong>الإجمالي العام</strong></td><td class="number-cell">${totalOverallQuantity.toLocaleString('ar-IQ')}</td><td class="number-cell">${formatCurrency(totalOverallValue)}</td></tr></tbody></table><div class="footer">إجمالي عدد المشترين (مع غير المسجلين): ${Object.keys(buyerSales).length}<br>تاريخ التقرير: ${new Date().toLocaleString('ar-EG')}</div></body></html>`;

                 // 3. Write final content
                 reportWindow.document.open();
                 reportWindow.document.write(reportHtml);
                 reportWindow.document.close();
                 showNotification('✅ تم فتح تقرير المشترين.', false, 'success');

             } catch (error) {
                 showNotification("فشل إنشاء تقرير المشترين.", true);
                 console.error("Buyer Report error:", error);
                  if (reportWindow && !reportWindow.closed) {
                    try {
                         reportWindow.document.open();
                         reportWindow.document.write('<html><body><h1>خطأ</h1><p>حدث خطأ أثناء إنشاء التقرير.</p></body></html>');
                         reportWindow.document.close();
                     } catch (writeError) {
                         console.error("Error writing error message to report window:", writeError);
                     }
                 }
             }
         }


        // --- Dark Mode & Theme ---
        function toggleDarkMode() {
            const isDarkMode = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDarkMode ? 'true' : 'false');
            applyCurrentTheme();
        }

        function applyCurrentTheme() {
            const isDarkMode = document.body.classList.contains('dark-mode');
            const themeButton = document.querySelector('.control-panel button[onclick*="toggleDarkMode"]');
            if (themeButton) {
                themeButton.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                themeButton.title = isDarkMode ? 'الوضع الفاتح' : 'الوضع الداكن';
            }
             const themeMetaLight = document.querySelector('meta[name="theme-color"][media="(prefers-color-scheme: light)"]');
             const themeMetaDark = document.querySelector('meta[name="theme-color"][media="(prefers-color-scheme: dark)"]');
             const currentThemeMeta = document.querySelector('meta[name="theme-color"]:not([media])') || document.createElement('meta');
             if (!currentThemeMeta.parentNode) {
                 currentThemeMeta.name = "theme-color";
                 document.head.appendChild(currentThemeMeta);
             }

             if(isDarkMode){
                if(themeMetaDark) currentThemeMeta.content = themeMetaDark.content;
             } else {
                if(themeMetaLight) currentThemeMeta.content = themeMetaLight.content;
             }
        }

        // --- Modal Visibility ---
        function showAddForm() {
            if (!addFormModalEl) return;
            addFormModalEl.classList.add('show');
            addFormModalEl.querySelector('#itemName').value = '';
            addFormModalEl.querySelector('#itemPrice').value = '';
            addFormModalEl.querySelector('#itemPartnerCost').value = '';
            addFormModalEl.querySelector('#itemIconUrl').value = '';
            addFormModalEl.querySelector('#itemName')?.focus();
            if (addFormButton) {
                 addFormButton.disabled = false;
                 addFormButton.innerHTML = '<i class="fas fa-plus"></i> إضافة المنتج';
            }
        }
        function hideAddForm() { addFormModalEl?.classList.remove('show'); }

        function showNotification(message, isError = false, type = 'normal', duration = null) {
            if (!toastEl) return;
            toastEl.textContent = message;
            toastEl.className = 'toast';
            let finalDuration = 3500;

            if (isError) { toastEl.classList.add('error'); finalDuration = 4500; }
             else if (type === 'warning') { toastEl.classList.add('warning'); finalDuration = 4000; }
             else if (type === 'success') { toastEl.classList.add('success'); }
             else if (type === 'info') { toastEl.classList.add('info'); finalDuration = 5000; }

            if(duration !== null && duration > 0) {
                finalDuration = duration;
            }

            toastEl.classList.add('show');
            if(toastTimer) clearTimeout(toastTimer);
            toastTimer = setTimeout(() => {
                toastEl.classList.remove('show');
                toastTimer = null;
            }, finalDuration);
        }

        // --- Professional Tips ---
        function showProfessionalTip() {
            if (professionalTips.length > 0 && !isDefinitelyOffline && firstLoadComplete) {
                const randomIndex = Math.floor(Math.random() * professionalTips.length);
                showNotification(professionalTips[randomIndex], false, 'info', 7000);
            }
        }

        // --- Sales Modal Logic ---
        function populateProductSelect(selectElement) {
            if (!selectElement) return;
            const currentValue = selectElement.value;
            selectElement.innerHTML = '<option value="" disabled selected>-- اختر المنتج --</option>';
            const sortedItems = Array.from(itemsMap.values()).sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            sortedItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${escapeHtml(item.name)} (${formatCurrency(item.price)})`;
                 option.dataset.price = item.price;
                 option.dataset.partnerCost = item.partnerCost ?? '';
                if (item.id === currentValue) option.selected = true;
                selectElement.appendChild(option);
            });
             handleProductSelectionChange(selectElement, window.getSelectedPartner());
        }

         // Simplified: Only populates PRODUCT selects. Partner selects are now hardcoded in HTML.
         function populateProductSelectsInModals() {
            const logSaleSelects = logSaleModalEl?.querySelectorAll('.sale-product-select');
            logSaleSelects?.forEach(populateProductSelect);
         }


         function handlePartnerSelectionChange(partnerSelect) {
             const partnerName = partnerSelect?.value ?? '';
             const entries = saleItemsListContainer?.querySelectorAll('.sale-item-entry');
             entries?.forEach(entry => {
                 updateSaleEntryUI(entry, partnerName);
                 const productSelect = entry.querySelector('.sale-product-select');
                 handleProductSelectionChange(productSelect, partnerName);
             });
         }

        function updateSaleEntryUI(entryElement, partnerName) {
            if (!entryElement) return;
            const costContainer = entryElement.querySelector('.sale-cost-price-input-container');
            const sellingLabel = entryElement.querySelector('.sale-price-label');
            const costInput = costContainer?.querySelector('.sale-cost-price-input');
            const sellingInput = entryElement.querySelector('.sale-selling-price-input');

            entryElement.classList.toggle('is-partner-sale', !!partnerName);

            if (partnerName) {
                if (costContainer) costContainer.style.display = 'block';
                if (costInput) costInput.required = true;
                if (sellingLabel) sellingLabel.textContent = 'سعر البيع للزبون:';
                 if (sellingInput) sellingInput.placeholder = 'السعر للزبون';
            } else {
                if (costContainer) costContainer.style.display = 'none';
                if (costInput) { costInput.required = false; costInput.value = ''; }
                if (sellingLabel) sellingLabel.textContent = 'سعر البيع:';
                 if (sellingInput) sellingInput.placeholder = 'السعر';
            }
        }

         function handleProductSelectionChange(selectElement, partnerName) {
             if (!selectElement) return;
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const entryDiv = selectElement.closest('.sale-item-entry');
             if (!entryDiv || !selectedOption || !selectedOption.value) return;

            const costInput = entryDiv.querySelector('.sale-cost-price-input');
            const sellingInput = entryDiv.querySelector('.sale-selling-price-input');
            if (!sellingInput) return;

             const baseSellingPrice = selectedOption.dataset.price || '';
             const basePartnerCost = selectedOption.dataset.partnerCost || '';

             sellingInput.value = baseSellingPrice;
             const sellingPlaceholderBase = partnerName ? 'السعر للزبون' : 'السعر';
             sellingInput.placeholder = baseSellingPrice ? `${sellingPlaceholderBase} (أساس: ${formatCurrency(baseSellingPrice)})` : sellingPlaceholderBase;

             if (partnerName && costInput) {
                 if (basePartnerCost !== '') {
                     costInput.value = basePartnerCost;
                     costInput.placeholder = `التكلفة (أساس: ${formatCurrency(basePartnerCost)})`;
                 } else {
                     costInput.value = '';
                     costInput.placeholder = 'أدخل التكلفة يدوياً';
                 }
             } else if (costInput) {
                 costInput.value = '';
                 costInput.placeholder = 'التكلفة';
             }
        }

        function showLogSaleModal() {
            if (!logSaleModalEl || !saleItemsListContainer) return;
            logSaleModalEl.classList.add('show');
            const dateInput = logSaleModalEl.querySelector('#saleDate');
            const buyerNameInput = logSaleModalEl.querySelector('#saleBuyerName');
            const notesInput = logSaleModalEl.querySelector('#saleNotes');
            const paidRadio = logSaleModalEl.querySelector('#saleStatusPaid');
            const partnerSelect = logSaleModalEl.querySelector('#salePartner');
            const saveButton = logSaleModalEl.querySelector('#saveSaleBtn');

            if (dateInput) dateInput.valueAsDate = new Date();
            if (buyerNameInput) buyerNameInput.value = '';
            if (notesInput) notesInput.value = '';
            if (paidRadio) paidRadio.checked = true;
            if (partnerSelect) partnerSelect.value = '';

            saleItemsListContainer.innerHTML = '';
            addSaleItemEntry();

            if (saveButton) {
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save"></i> حفظ المبيعات';
            }
            handlePartnerSelectionChange(partnerSelect);
             dateInput?.focus();
        }

        function addSaleItemEntry() {
             if (!saleItemsListContainer) return;
             const partnerName = window.getSelectedPartner();

             const entryDiv = document.createElement('div');
             entryDiv.className = `sale-item-entry ${partnerName ? 'is-partner-sale' : ''}`;

             const productSelectContainer = document.createElement('div');
             productSelectContainer.className = 'sale-product-select-container';
             const productSelect = document.createElement('select');
             productSelect.className = 'sale-product-select';
             productSelect.required = true;
             productSelect.innerHTML = '<option value="" disabled selected>-- اختر المنتج --</option>';
              productSelect.addEventListener('change', () => handleProductSelectionChange(productSelect, window.getSelectedPartner()));
             productSelectContainer.appendChild(productSelect);
             entryDiv.appendChild(productSelectContainer);

             const costContainer = document.createElement('div');
             costContainer.className = 'sale-cost-price-input-container';
             costContainer.style.display = partnerName ? 'block' : 'none';
             const costLabel = document.createElement('label');
             costLabel.textContent = 'سعر التكلفة للشريك:';
             const costInput = document.createElement('input');
             costInput.type = 'number';
             costInput.className = 'sale-cost-price-input';
             costInput.placeholder = 'التكلفة';
             costInput.min = "0";
             costInput.step = "any";
             costInput.required = !!partnerName;
             costContainer.appendChild(costLabel);
             costContainer.appendChild(costInput);
             entryDiv.appendChild(costContainer);

             const sellingContainer = document.createElement('div');
             sellingContainer.className = 'sale-selling-price-input-container';
             const sellingLabel = document.createElement('label');
             sellingLabel.className = 'sale-price-label';
             sellingLabel.textContent = partnerName ? 'سعر البيع للزبون:' : 'سعر البيع:';
             const sellingInput = document.createElement('input');
             sellingInput.type = 'number';
             sellingInput.className = 'sale-selling-price-input';
             sellingInput.placeholder = partnerName ? 'السعر للزبون' : 'السعر';
             sellingInput.min = '0';
             sellingInput.step = 'any';
             sellingInput.required = true;
             sellingContainer.appendChild(sellingLabel);
             sellingContainer.appendChild(sellingInput);
             entryDiv.appendChild(sellingContainer);

             const quantityContainer = document.createElement('div');
             quantityContainer.className = 'sale-quantity-input-container';
             const quantityLabel = document.createElement('label');
             quantityLabel.textContent = 'الكمية:';
             const quantityInput = document.createElement('input');
             quantityInput.type = 'number';
             quantityInput.className = 'sale-quantity-input';
             quantityInput.placeholder = 'الكمية';
             quantityInput.value = '1';
             quantityInput.min = '1';
             quantityInput.required = true;
             quantityContainer.appendChild(quantityLabel);
             quantityContainer.appendChild(quantityInput);
             entryDiv.appendChild(quantityContainer);

             const removeBtn = document.createElement('button');
             removeBtn.type = 'button';
             removeBtn.className = 'remove-sale-item-btn';
             removeBtn.title = 'إزالة هذا البند';
             removeBtn.innerHTML = '&times;';
              removeBtn.addEventListener('click', () => removeSaleItem(removeBtn));
             entryDiv.appendChild(removeBtn);

             saleItemsListContainer.appendChild(entryDiv);
             populateProductSelect(productSelect);
             productSelect.focus();
        }

         window.getSelectedPartner = () => logSaleModalEl?.querySelector('#salePartner')?.value ?? '';

        function removeSaleItem(button) {
            const entry = button?.closest('.sale-item-entry');
            if (entry && saleItemsListContainer && saleItemsListContainer.querySelectorAll('.sale-item-entry').length > 1) {
                 entry.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                 entry.style.opacity = '0';
                 entry.style.transform = 'scale(0.95)';
                 setTimeout(() => { entry.remove(); }, 300);
            } else {
                showNotification('يجب وجود بند واحد على الأقل في عملية البيع.', true, 'warning');
            }
        }

        function hideLogSaleModal() { logSaleModalEl?.classList.remove('show'); }

        async function saveSales() {
            if (!db || !logSaleModalEl || !saleItemsListContainer) return;

            const saleDateInput = logSaleModalEl.querySelector('#saleDate');
            const buyerNameInput = logSaleModalEl.querySelector('#saleBuyerName');
            const notesInput = logSaleModalEl.querySelector('#saleNotes');
            const paymentStatusInput = logSaleModalEl.querySelector('input[name="salePaymentStatus"]:checked');
            const partnerSelect = logSaleModalEl.querySelector('#salePartner');
            const saleEntries = saleItemsListContainer.querySelectorAll('.sale-item-entry');
            const saveButton = logSaleModalEl.querySelector('#saveSaleBtn');

            if (!saveButton || !saleDateInput || !paymentStatusInput || !partnerSelect) {
                showNotification("خطأ: عناصر النموذج مفقودة.", true); return;
            }

            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جارٍ الحفظ...';

            const saleDate = saleDateInput.valueAsDate;
            const buyerName = buyerNameInput.value.trim();
            const notes = notesInput.value.trim();
            const paymentStatus = paymentStatusInput.value;
            const partnerName = partnerSelect.value || null;

            if (!saleDate) {
                showNotification('يرجى تحديد تاريخ البيع!', true, 'warning');
                saveButton.disabled = false; saveButton.innerHTML = '<i class="fas fa-save"></i> حفظ المبيعات'; saleDateInput.focus(); return;
            }

             const now = new Date();
             const saleTimestamp = new Date(saleDate.getFullYear(), saleDate.getMonth(), saleDate.getDate(), now.getHours(), now.getMinutes(), now.getSeconds());

            const batch = writeBatch(db);
            const salesToLog = [];
            let isValid = true;

            for (const entry of saleEntries) {
                const productSelect = entry.querySelector('.sale-product-select');
                const quantityInput = entry.querySelector('.sale-quantity-input');
                const sellingPriceInput = entry.querySelector('.sale-selling-price-input');
                const costPriceInput = entry.querySelector('.sale-cost-price-input');

                entry.style.border = '1px solid transparent';
                 [productSelect, quantityInput, sellingPriceInput, costPriceInput].forEach(el => { if(el) el.style.borderColor = ''; });

                if (!productSelect || !quantityInput || !sellingPriceInput || !costPriceInput) { isValid = false; entry.style.border = '1px solid var(--danger)'; continue; }

                const productId = productSelect.value;
                const quantitySold = parseInt(quantityInput.value);
                const sellingPricePerUnit = parseFloat(sellingPriceInput.value);
                let costPricePerUnit = null;

                let entryValid = true;
                if (!productId) { entryValid = false; productSelect.style.borderColor = 'var(--danger)'; }
                if (isNaN(quantitySold) || quantitySold <= 0) { entryValid = false; quantityInput.style.borderColor = 'var(--danger)'; }
                if (isNaN(sellingPricePerUnit) || sellingPricePerUnit < 0) { entryValid = false; sellingPriceInput.style.borderColor = 'var(--danger)'; }

                if (partnerName) {
                    costPricePerUnit = parseFloat(costPriceInput.value);
                    if (isNaN(costPricePerUnit) || costPricePerUnit < 0) {
                        entryValid = false;
                        costPriceInput.style.borderColor = 'var(--danger)';
                    }
                     if (costPricePerUnit > sellingPricePerUnit) {
                          costPriceInput.style.borderColor = 'var(--warning)';
                          sellingPriceInput.style.borderColor = 'var(--warning)';
                          showNotification(`تحذير في البند ${salesToLog.length + 1}: التكلفة (${formatCurrency(costPricePerUnit)}) أعلى من البيع (${formatCurrency(sellingPricePerUnit)}).`, false, 'warning', 6000);
                     }
                }

                if (!entryValid) { isValid = false; entry.style.border = '1px solid var(--danger)'; continue; }

                const productData = itemsMap.get(productId);
                if (productData) {
                     salesToLog.push({
                         productId: productId,
                         productName: productData.name,
                         quantitySold: quantitySold,
                         pricePerUnitAtSale: sellingPricePerUnit,
                         costPricePerUnit: costPricePerUnit,
                         partnerName: partnerName,
                         totalSaleAmount: quantitySold * sellingPricePerUnit,
                         saleTimestamp: Timestamp.fromDate(saleTimestamp),
                         buyerName: buyerName || null,
                         paymentStatus: paymentStatus,
                         notes: notes || null
                     });
                } else {
                    isValid = false; entry.style.border = '1px solid var(--danger)'; productSelect.style.borderColor = 'var(--danger)';
                    showNotification(`خطأ: المنتج المحدد في البند ${salesToLog.length + 1} غير موجود.`, true);
                    break;
                }
            }

            if (!isValid || salesToLog.length === 0) {
                showNotification('يرجى مراجعة البنود التي عليها علامة حمراء أو صفراء والتأكد من صحة البيانات.', true);
                saveButton.disabled = false; saveButton.innerHTML = '<i class="fas fa-save"></i> حفظ المبيعات'; return;
            }

            try {
                salesToLog.forEach(saleData => batch.set(doc(collection(db, 'sales')), saleData));
                await batch.commit();
                showNotification(`✅ تم تسجيل ${salesToLog.length} ${salesToLog.length === 1 ? 'بند بيع' : 'بنود بيع'} بنجاح!`, false, 'success');
                hideLogSaleModal();
                fetchAllPaidSalesSummary();
                fetchAndDisplayOutstandingDebts();
            } catch (error) {
                showNotification(`خطأ حفظ المبيعات: ${error.message}`, true);
                console.error("Error saving sales: ", error);
                saveButton.disabled = false; saveButton.innerHTML = '<i class="fas fa-save"></i> حفظ المبيعات';
            }
        }

        // --- Sales Report Modal ---
        function showSalesReportModal() {
            if (!salesReportModalEl) return;
            salesReportModalEl.classList.add('show');
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const startDateInput = salesReportModalEl.querySelector('#reportStartDate');
            const endDateInput = salesReportModalEl.querySelector('#reportEndDate');
            const filterSelect = salesReportModalEl.querySelector('#reportPaymentStatusFilter');
            const partnerFilterSelect = salesReportModalEl.querySelector('#reportPartnerFilter');

            if (startDateInput) startDateInput.valueAsDate = startOfMonth;
            if (endDateInput) endDateInput.valueAsDate = today;
            if (filterSelect) filterSelect.value = 'all';
            if (partnerFilterSelect) partnerFilterSelect.value = 'all';
            // No need to populate partner filter dynamically here as it's hardcoded
            if (salesReportArea) salesReportArea.innerHTML = '<p class="detail-placeholder">اختر فترة ونوع التقرير.</p>';
        }
        function hideSalesReportModal() { salesReportModalEl?.classList.remove('show'); }

        async function generateSalesReport(reportType) {
            if (!db || !salesReportModalEl || !salesReportArea) { showNotification("الخدمة غير جاهزة.", true); return; }
            const startDateInput = salesReportModalEl.querySelector('#reportStartDate');
            const endDateInput = salesReportModalEl.querySelector('#reportEndDate');
            const paymentStatusFilterInput = salesReportModalEl.querySelector('#reportPaymentStatusFilter');
            const partnerFilterInput = salesReportModalEl.querySelector('#reportPartnerFilter');

            if (!startDateInput || !endDateInput || !paymentStatusFilterInput || !partnerFilterInput) { showNotification("خطأ: عناصر التحكم مفقودة.", true); return; }
            const paymentStatusFilter = paymentStatusFilterInput.value;
            const partnerFilter = partnerFilterInput.value;
            const startDate = startDateInput.valueAsDate;
            const endDate = endDateInput.valueAsDate;
            if (!startDate || !endDate || endDate < startDate) { showNotification('يرجى تحديد فترة صحيحة.', true, 'warning'); return; }

            const endOfDay = new Date(endDate); endOfDay.setHours(23, 59, 59, 999);
            salesReportArea.innerHTML = '<p class="detail-placeholder"><i class="fas fa-spinner fa-spin"></i> جارٍ تحميل بيانات التقرير...</p>';

            try {
                const salesRef = collection(db, 'sales');
                let conditions = [
                     where('saleTimestamp', '>=', Timestamp.fromDate(startDate)),
                     where('saleTimestamp', '<=', Timestamp.fromDate(endOfDay))
                 ];
                if (paymentStatusFilter !== 'all') { conditions.push(where('paymentStatus', '==', paymentStatusFilter)); }
                if (partnerFilter === 'direct') { conditions.push(where('partnerName', '==', null)); }
                else if (partnerFilter !== 'all') { conditions.push(where('partnerName', '==', partnerFilter)); }
                conditions.push(orderBy('saleTimestamp', 'desc'));

                const q = query(salesRef, ...conditions);
                const salesSnapshot = await getDocs(q);

                if (salesSnapshot.empty) {
                    salesReportArea.innerHTML = `<p class="detail-placeholder">لا توجد مبيعات تطابق الفلترة المحددة.</p>`;
                    return;
                }

                let reportHtml = '';
                const salesData = salesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const dateRangeText = `${startDate.toLocaleDateString('ar-EG')} - ${endDate.toLocaleDateString('ar-EG')}`;
                const statusText = paymentStatusFilter === 'paid' ? ' (مدفوع)' : paymentStatusFilter === 'debt' ? ' (دين)' : ' (الكل)';
                const partnerText = partnerFilter === 'direct' ? ' (مباشر)' : (partnerFilter !== 'all' ? ` (${escapeHtml(partnerFilter)})` : ' (الكل)');

                 if (reportType === 'summary') {
                     let totalValue = 0, totalQuantity = 0;
                     salesData.forEach(sale => { totalValue += sale.totalSaleAmount || 0; totalQuantity += sale.quantitySold || 0; });
                     reportHtml = `<h4>ملخص وتفاصيل${statusText}${partnerText}<br><small>(${dateRangeText})</small></h4><div class="report-summary"><p>إجمالي القيمة: <span>${formatCurrency(totalValue)}</span></p><p>إجمالي الكمية: <span>${totalQuantity.toLocaleString('ar-IQ')}</span> قطعة</p></div><br><h4>التفاصيل:</h4><div style="overflow-x: auto;"><table class="professional-report-table"><thead><tr><th>التاريخ</th><th>المشتري</th><th>الشريك</th><th>المنتج</th><th>الكمية</th><th>سعر البيع</th><th>الإجمالي</th><th class="wrap-text">الملاحظات</th><th>الحالة</th></tr></thead><tbody>${salesData.map(s => `<tr><td>${formatFirestoreTimestamp(s.saleTimestamp)}</td><td class="wrap-text">${escapeHtml(s.buyerName) || '-'}</td><td>${escapeHtml(s.partnerName) || 'مباشر'}</td><td class="wrap-text">${escapeHtml(s.productName) || '?'}</td><td class="number-cell">${(s.quantitySold || 0).toLocaleString('ar-IQ')}</td><td class="number-cell">${formatCurrency(s.pricePerUnitAtSale)}</td><td class="number-cell">${formatCurrency(s.totalSaleAmount)}</td><td class="wrap-text">${escapeHtml(s.notes) || '-'}</td><td><span class="sale-status ${s.paymentStatus === 'paid' ? 'sale-status-paid' : 'sale-status-debt'}">${s.paymentStatus === 'paid' ? 'مدفوع' : 'دين'}</span></td></tr>`).join('')}</tbody></table></div>`;
                 } else if (reportType === 'bestSellerQty' || reportType === 'bestSellerValue') {
                     const productSales = {}; salesData.forEach(sale => { const pid = sale.productId || 'unknown'; if (!productSales[pid]) productSales[pid] = { name: sale.productName || '?', qty: 0, value: 0 }; productSales[pid].qty += sale.quantitySold || 0; productSales[pid].value += sale.totalSaleAmount || 0; }); const sorted = Object.values(productSales).sort((a, b) => (reportType === 'bestSellerQty' ? b.qty - a.qty : b.value - a.value)); reportHtml = `<h4>الأكثر مبيعاً ${reportType === 'bestSellerQty' ? '(حسب الكمية)' : '(حسب القيمة)'}${statusText}${partnerText}<br><small>(${dateRangeText})</small></h4><div style="overflow-x: auto;"><table class="professional-report-table"><thead><tr><th>المنتج</th><th>إجمالي الكمية</th><th>إجمالي القيمة</th></tr></thead><tbody>${sorted.map(p => `<tr><td class="wrap-text">${escapeHtml(p.name)}</td><td class="number-cell">${(p.qty || 0).toLocaleString('ar-IQ')}</td><td class="number-cell">${formatCurrency(p.value)}</td></tr>`).join('')}</tbody></table></div>`;
                 } else if (reportType === 'buyerSummary') {
                     const buyerSales = {}; salesData.forEach(sale => { const bName = sale.buyerName?.trim() || 'زبون غير مسجل'; if (!buyerSales[bName]) buyerSales[bName] = { name: bName, qty: 0, value: 0 }; buyerSales[bName].qty += sale.quantitySold || 0; buyerSales[bName].value += sale.totalSaleAmount || 0; }); const sorted = Object.values(buyerSales).sort((a, b) => b.value - a.value); reportHtml = `<h4>ملخص حسب المشتري${statusText}${partnerText}<br><small>(${dateRangeText})</small></h4><div style="overflow-x: auto;"><table class="professional-report-table"><thead><tr><th>المشتري</th><th>إجمالي الكمية</th><th>إجمالي القيمة</th></tr></thead><tbody>${sorted.map(b => `<tr><td class="wrap-text">${escapeHtml(b.name)}</td><td class="number-cell">${(b.qty || 0).toLocaleString('ar-IQ')}</td><td class="number-cell">${formatCurrency(b.value)}</td></tr>`).join('')}</tbody></table></div>`;
                 } else if (reportType === 'partnerSummary') {
                     const partnerSales = {}; let totalCost=0, totalSelling=0, totalProfit=0, totalQty=0;
                     salesData.forEach(sale => {
                        const pName = sale.partnerName || 'بيع مباشر';
                        if (!partnerSales[pName]) partnerSales[pName] = { name: pName, qty: 0, totalCost: 0, totalSelling: 0, totalProfit: 0 };
                        const qty = sale.quantitySold || 0;
                        const costPU = sale.costPricePerUnit;
                        const sellingPU = sale.pricePerUnitAtSale || 0;
                        const isPartnerSale = pName !== 'بيع مباشر';
                        const cost = (isPartnerSale && costPU != null && costPU >= 0) ? costPU * qty : 0;
                        const selling = sellingPU * qty;
                        const profit = (isPartnerSale && costPU != null && costPU >= 0) ? (sellingPU - costPU) * qty : 0;
                        partnerSales[pName].qty += qty;
                        partnerSales[pName].totalCost += cost;
                        partnerSales[pName].totalSelling += selling;
                        partnerSales[pName].totalProfit += profit;
                        totalQty += qty;
                        totalCost += cost;
                        totalSelling += selling;
                        totalProfit += profit;
                     });
                     const sorted = Object.values(partnerSales).sort((a, b) => { if (a.name === 'بيع مباشر') return 1; if (b.name === 'بيع مباشر') return -1; return b.totalProfit - a.totalProfit; });
                     reportHtml = `<h4>ملخص الشركاء والمبيعات المباشرة${statusText}${partnerText}<br><small>(${dateRangeText})</small></h4><div style="overflow-x: auto;"><table class="professional-report-table"><thead><tr><th>الشريك/النوع</th><th>الكمية المباعة</th><th>إجمالي التكلفة (للشركاء)</th><th>إجمالي سعر البيع</th><th>إجمالي الربح (للشركاء)</th></tr></thead><tbody>${sorted.map(p => `<tr><td>${escapeHtml(p.name)}</td><td class="number-cell">${(p.qty || 0).toLocaleString('ar-IQ')}</td><td class="number-cell">${p.name !== 'بيع مباشر' ? formatCurrency(p.totalCost) : '-'}</td><td class="number-cell">${formatCurrency(p.totalSelling)}</td><td class="number-cell partner-profit">${p.name !== 'بيع مباشر' ? formatCurrency(p.totalProfit) : '-'}</td></tr>`).join('')}<tr style="font-weight: bold; background-color: var(--grey-light); border-top: 2px solid var(--grey-medium);"><td style="background-color:var(--grey-light);"><strong>الإجمالي (للفترة المحددة)</strong></td><td class="number-cell">${totalQty.toLocaleString('ar-IQ')}</td><td class="number-cell">${formatCurrency(totalCost)}</td><td class="number-cell">${formatCurrency(totalSelling)}</td><td class="number-cell partner-profit">${formatCurrency(totalProfit)}</td></tr></tbody></table></div><p style="font-size: 0.85em; text-align: center; margin-top: 10px; opacity: 0.8;">* الربح والتكلفة محسوبة فقط لمبيعات الشركاء التي تم تسجيل سعر تكلفة لها.</p>`;
                 } else {
                     reportHtml = '<p class="detail-placeholder">نوع التقرير غير معروف.</p>';
                 }

                salesReportArea.innerHTML = reportHtml;
            } catch (error) {
                 console.error("Error generating report:", error);
                 salesReportArea.innerHTML = `<p class="detail-error">خطأ في إنشاء التقرير: ${error.message}</p>`;
            }
        }

        // --- Export Sales to CSV ---
        function exportSalesToCSV() {
             if (!db || !salesReportModalEl) return;
             const sDateIn = salesReportModalEl.querySelector('#reportStartDate');
             const eDateIn = salesReportModalEl.querySelector('#reportEndDate');
             const statusFilterIn = salesReportModalEl.querySelector('#reportPaymentStatusFilter');
             const partnerFilterIn = salesReportModalEl.querySelector('#reportPartnerFilter');

             if (!sDateIn || !eDateIn || !statusFilterIn || !partnerFilterIn) {
                 showNotification("خطأ: عناصر التحكم في التقرير مفقودة.", true); return;
             }
             const statusFilter = statusFilterIn.value;
             const partnerFilter = partnerFilterIn.value;
             const startDate = sDateIn.valueAsDate;
             const endDate = eDateIn.valueAsDate;
             if (!startDate || !endDate || endDate < startDate) {
                 showNotification('يرجى تحديد فترة زمنية صحيحة للتصدير.', true, 'warning'); return;
             }
             const endOfDay = new Date(endDate); endOfDay.setHours(23, 59, 59, 999);

             showNotification('⏳ تحضير بيانات التصدير...', false, 'info');

             const salesRef = collection(db, 'sales');
             let conditions = [
                 where('saleTimestamp', '>=', Timestamp.fromDate(startDate)),
                 where('saleTimestamp', '<=', Timestamp.fromDate(endOfDay))
             ];
             if (statusFilter !== 'all') conditions.push(where('paymentStatus', '==', statusFilter));
             if (partnerFilter === 'direct') conditions.push(where('partnerName', '==', null));
             else if (partnerFilter !== 'all') conditions.push(where('partnerName', '==', partnerFilter));
             conditions.push(orderBy('saleTimestamp', 'desc'));

             const q = query(salesRef, ...conditions);

             getDocs(q).then(snapshot => {
                 if (snapshot.empty) {
                     showNotification('لا توجد بيانات مطابقة للفترة المحددة للتصدير.', false, 'warning'); return;
                 }

                 let csvContent = "\uFEFF";
                 csvContent += "التاريخ,الوقت,اسم المشتري,الشريك,معرف المنتج,اسم المنتج,الكمية,سعر التكلفة للوحدة,سعر البيع للوحدة,الإجمالي,الحالة,الملاحظات\r\n";

                 const formatCsvField = (field) => {
                     if (field == null) return '';
                     let str = String(field);
                     if (str.includes(',') || str.includes('\n') || str.includes('"')) {
                         str = str.replace(/"/g, '""');
                         return `"${str}"`;
                     }
                     return str;
                 };

                 snapshot.docs.forEach(doc => {
                     const s = doc.data();
                     const ts = s.saleTimestamp?.toDate ? s.saleTimestamp.toDate() : new Date();
                     const date = ts.toLocaleDateString('en-CA');
                     const time = ts.toLocaleTimeString('en-GB', { hour12: false });

                     const row = [
                         date, time, formatCsvField(s.buyerName), formatCsvField(s.partnerName || 'مباشر'),
                         s.productId || '', formatCsvField(s.productName), s.quantitySold || 0,
                         s.costPricePerUnit ?? '', s.pricePerUnitAtSale ?? 0, s.totalSaleAmount ?? 0,
                         s.paymentStatus === 'paid' ? 'مدفوع' : 'دين', formatCsvField(s.notes)
                     ].join(',');
                     csvContent += row + "\r\n";
                 });

                 const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                 const link = document.createElement("a");
                 const url = URL.createObjectURL(blob);
                 link.setAttribute("href", url);
                 const dateStr = `${startDate.toISOString().slice(0, 10)}_to_${endDate.toISOString().slice(0, 10)}`;
                 const partnerStr = partnerFilter === 'all' ? 'all' : partnerFilter === 'direct' ? 'direct' : partnerFilter.replace(/[^a-z0-9]/gi, '_');
                 const filename = `sales_report_${dateStr}_status-${statusFilter}_partner-${partnerStr}.csv`;
                 link.setAttribute("download", filename);
                 link.style.visibility = 'hidden';
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);
                 URL.revokeObjectURL(url);
                 showNotification('✅ تم تنزيل ملف CSV بنجاح.', false, 'success');

             }).catch(err => {
                 console.error("Error exporting CSV:", err);
                 showNotification(`خطأ في تصدير البيانات: ${err.message}`, true);
             });
        }

        // --- Sales Log Modal ---
        function showSalesLogModal() {
            if (!salesLogModalEl) return;
            salesLogModalEl.classList.add('show');
            loadSalesLog();
            if (clearLogBtn) clearLogBtn.disabled = false;
            if (salesLogCloseBtn) salesLogCloseBtn.disabled = false;
            if (salesLogModalCloseIconBtn) salesLogModalCloseIconBtn.disabled = false;
        }
        function hideSalesLogModal() {
            if (salesLogModalEl) {
                salesLogModalEl.classList.remove('show');
                if (salesLogTableBody) salesLogTableBody.innerHTML = '';
            }
        }

        async function loadSalesLog() {
            if (!db || !salesLogTableBody) return;
            salesLogTableBody.innerHTML = `<tr><td colspan="13" class="detail-placeholder"><i class="fas fa-spinner fa-spin"></i> جارٍ تحميل السجل...</td></tr>`;
            if(salesLogTableBody.parentElement) salesLogTableBody.parentElement.style.display = 'table';

            try {
                const salesRef = collection(db, 'sales');
                const q = query(salesRef, orderBy('saleTimestamp', 'desc'), limit(SALES_LOG_LIMIT));
                const salesSnapshot = await getDocs(q);

                if (salesSnapshot.empty) {
                    salesLogTableBody.innerHTML = `<tr><td colspan="13" class="detail-placeholder">لا توجد مبيعات مسجلة في السجل.</td></tr>`;
                    return;
                }

                let logHtml = '';
                salesSnapshot.docs.forEach(doc => {
                    const sale = { id: doc.id, ...doc.data() };
                    const statusClass = sale.paymentStatus === 'paid' ? 'sale-status-paid' : 'sale-status-debt';
                    const statusText = sale.paymentStatus === 'paid' ? 'مدفوع' : 'دين';
                    const partnerName = sale.partnerName || 'مباشر';
                    const costPrice = sale.costPricePerUnit;
                    const sellingPrice = sale.pricePerUnitAtSale;
                    const quantity = sale.quantitySold || 0;
                    let profit = '-';
                    if (partnerName !== 'مباشر' && costPrice != null && costPrice >= 0 && sellingPrice != null) {
                        profit = formatCurrency((sellingPrice - costPrice) * quantity);
                    }

                    logHtml += `
                        <tr data-sale-id="${sale.id}">
                            <td>${formatFirestoreTimestamp(sale.saleTimestamp)}</td>
                            <td class="wrap-text">${escapeHtml(sale.buyerName) || '-'}</td>
                            <td>${escapeHtml(partnerName)}</td>
                            <td class="wrap-text">${escapeHtml(sale.productName) || '?'}</td>
                            <td>${escapeHtml(sale.productId) || '-'}</td>
                            <td class="number-cell">${quantity.toLocaleString('ar-IQ')}</td>
                            <td class="number-cell">${(partnerName !== 'مباشر' && costPrice != null && costPrice >= 0) ? formatCurrency(costPrice) : '-'}</td>
                            <td class="number-cell">${formatCurrency(sellingPrice || 0)}</td>
                            <td class="number-cell">${formatCurrency(sale.totalSaleAmount || 0)}</td>
                            <td class="number-cell partner-profit">${profit}</td>
                            <td class="wrap-text">${escapeHtml(sale.notes) || '-'}</td>
                            <td><span class="sale-status ${statusClass}">${statusText}</span></td>
                            <td class="log-actions">
                                <button class="edit-sale-log-entry" onclick="window.showEditSaleModal('${sale.id}')" title="تعديل السجل"><i class="fas fa-edit"></i></button>
                                <button class="delete-sale-log-entry" onclick="window.confirmDeleteSalesLogEntry('${sale.id}', this)" title="حذف السجل"><i class="fas fa-times-circle"></i></button>
                            </td>
                        </tr>`;
                });
                salesLogTableBody.innerHTML = logHtml;
                 if (salesSnapshot.docs.length >= SALES_LOG_LIMIT) {
                    salesLogTableBody.insertAdjacentHTML('beforeend', `<tr><td colspan="13" style="text-align: center; font-size: 0.9em; opacity: 0.7; padding: 8px;">(عرض أحدث ${SALES_LOG_LIMIT} سجل)</td></tr>`);
                }

            } catch (error) {
                console.error("Error loading sales log:", error);
                salesLogTableBody.innerHTML = `<tr><td colspan="13" class="detail-error">خطأ في تحميل سجل المبيعات: ${error.message}</td></tr>`;
            }
        }

        // --- Edit Sale Modal Logic ---
        async function showEditSaleModal(saleId) {
            if (!db || !saleId || !editSaleModalEl) return;
            const idInput = editSaleModalEl.querySelector('#editSaleId');
            const dateInput = editSaleModalEl.querySelector('#editSaleDate');
            const partnerNameDisplay = editSaleModalEl.querySelector('#editPartnerNameDisplay');
            const buyerNameInput = editSaleModalEl.querySelector('#editSaleBuyerName');
            const notesInput = editSaleModalEl.querySelector('#editSaleNotes');
            const productNameInput = editSaleModalEl.querySelector('#editSaleProductName');
            const quantityInput = editSaleModalEl.querySelector('#editSaleQuantity');
            const costPriceDisplay = editSaleModalEl.querySelector('#editSaleCostPrice');
            const sellingPriceInput = editSaleModalEl.querySelector('#editSaleSellingPrice');
            const costContainer = editSaleModalEl.querySelector('.edit-cost-price-container');
            const sellingLabel = editSaleModalEl.querySelector('.edit-price-label');
            const totalDisplay = editSaleModalEl.querySelector('#editSaleTotalDisplay');
            const paidRadio = editSaleModalEl.querySelector('#editSaleStatusPaid');
            const debtRadio = editSaleModalEl.querySelector('#editSaleStatusDebt');

            if (!idInput || !dateInput || !partnerNameDisplay || !buyerNameInput || !notesInput || !productNameInput ||
                !quantityInput || !costPriceDisplay || !sellingPriceInput || !costContainer || !sellingLabel ||
                !totalDisplay || !paidRadio || !debtRadio || !updateSaleBtn) {
                showNotification("خطأ: عناصر نافذة تعديل البيع مفقودة.", true); return;
            }

            sellingPriceInput.removeEventListener('input', updateEditSaleTotal);
            quantityInput.removeEventListener('input', updateEditSaleTotal);
            sellingPriceInput.addEventListener('input', updateEditSaleTotal);
            quantityInput.addEventListener('input', updateEditSaleTotal);

            try {
                 showNotification("⏳ جلب بيانات السجل للتعديل...", false, 'info');
                const saleRef = doc(db, 'sales', saleId);
                const docSnap = await getDoc(saleRef);
                if (!docSnap.exists()) {
                    showNotification("السجل المطلوب غير موجود!", true);
                    hideEditSaleModal();
                    return;
                }
                const saleData = docSnap.data();

                idInput.value = saleId;
                dateInput.valueAsDate = saleData.saleTimestamp?.toDate ? saleData.saleTimestamp.toDate() : null;
                buyerNameInput.value = saleData.buyerName || '';
                notesInput.value = saleData.notes || '';
                productNameInput.value = saleData.productName || '?';
                quantityInput.value = saleData.quantitySold || 1;
                sellingPriceInput.value = saleData.pricePerUnitAtSale ?? 0;
                partnerNameDisplay.value = saleData.partnerName || 'بيع مباشر';

                if (saleData.partnerName && saleData.costPricePerUnit != null) {
                    costContainer.style.display = 'flex';
                    costPriceDisplay.value = saleData.costPricePerUnit;
                    sellingLabel.textContent = 'سعر البيع للزبون:';
                } else {
                    costContainer.style.display = 'none';
                    costPriceDisplay.value = '';
                    sellingLabel.textContent = 'سعر البيع:';
                }
                costPriceDisplay.readOnly = true;
                costPriceDisplay.disabled = true;

                if (saleData.paymentStatus === 'paid') paidRadio.checked = true;
                else debtRadio.checked = true;
                updateEditSaleTotal();
                updateSaleBtn.disabled = false;
                updateSaleBtn.innerHTML = '<i class="fas fa-save"></i> حفظ التعديلات';
                editSaleModalEl.classList.add('show');
                dateInput.focus();

            } catch (error) {
                 console.error("Error fetching sale for edit:", error);
                 showNotification(`خطأ في جلب بيانات السجل: ${error.message}`, true);
             }
        }

         function updateEditSaleTotal() {
             const quantityInput = editSaleModalEl?.querySelector('#editSaleQuantity');
             const sellingPriceInput = editSaleModalEl?.querySelector('#editSaleSellingPrice');
             const totalDisplay = editSaleModalEl?.querySelector('#editSaleTotalDisplay');
             if (quantityInput && sellingPriceInput && totalDisplay) {
                 const quantity = parseInt(quantityInput.value) || 0;
                 const sellingPrice = parseFloat(sellingPriceInput.value) || 0;
                 totalDisplay.value = formatCurrency(quantity * sellingPrice);
             }
         }

        function hideEditSaleModal() {
             if (!editSaleModalEl) return;
             editSaleModalEl.classList.remove('show');
             const sellingPriceInput = editSaleModalEl.querySelector('#editSaleSellingPrice');
             const quantityInput = editSaleModalEl.querySelector('#editSaleQuantity');
             sellingPriceInput?.removeEventListener('input', updateEditSaleTotal);
             quantityInput?.removeEventListener('input', updateEditSaleTotal);
         }

        async function updateSaleEntry() {
            if (!db || !editSaleModalEl || !updateSaleBtn) return;
            const saleIdInput = editSaleModalEl.querySelector('#editSaleId');
            const saleDateInput = editSaleModalEl.querySelector('#editSaleDate');
            const buyerNameInput = editSaleModalEl.querySelector('#editSaleBuyerName');
            const notesInput = editSaleModalEl.querySelector('#editSaleNotes');
            const quantityInput = editSaleModalEl.querySelector('#editSaleQuantity');
            const sellingPriceInput = editSaleModalEl.querySelector('#editSaleSellingPrice');
            const paymentStatusInput = editSaleModalEl.querySelector('input[name="editSalePaymentStatus"]:checked');

            if (!saleIdInput || !saleDateInput || !buyerNameInput || !notesInput || !quantityInput || !sellingPriceInput || !paymentStatusInput) {
                showNotification("خطأ: حقول التعديل مفقودة أو غير صالحة.", true); return;
            }
            const saleId = saleIdInput.value;
            const saleDate = saleDateInput.valueAsDate;
            const buyerName = buyerNameInput.value.trim();
            const notes = notesInput.value.trim();
            const quantity = parseInt(quantityInput.value);
            const sellingPrice = parseFloat(sellingPriceInput.value);
            const paymentStatus = paymentStatusInput.value;

            if (!saleId || !saleDate || isNaN(quantity) || quantity <= 0 || isNaN(sellingPrice) || sellingPrice < 0 || !paymentStatus) {
                 showNotification("يرجى ملء الحقول المطلوبة (التاريخ، الكمية، السعر) بشكل صحيح.", true, 'warning');
                 if (isNaN(quantity) || quantity <= 0) quantityInput.style.borderColor = 'var(--danger)'; else quantityInput.style.borderColor = '';
                 if (isNaN(sellingPrice) || sellingPrice < 0) sellingPriceInput.style.borderColor = 'var(--danger)'; else sellingPriceInput.style.borderColor = '';
                 if (!saleDate) saleDateInput.style.borderColor = 'var(--danger)'; else saleDateInput.style.borderColor = '';
                 return;
            }

            updateSaleBtn.disabled = true; updateSaleBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جارٍ الحفظ...';
            const saleRef = doc(db, 'sales', saleId);

            try {
                const originalDoc = await getDoc(saleRef);
                if (!originalDoc.exists()) throw new Error("السجل الأصلي غير موجود ليتم تحديثه");
                const originalData = originalDoc.data();
                const originalTimestampDate = originalData.saleTimestamp?.toDate ? originalData.saleTimestamp.toDate() : new Date();
                const newTimestamp = new Date(
                    saleDate.getFullYear(), saleDate.getMonth(), saleDate.getDate(),
                    originalTimestampDate.getHours(), originalTimestampDate.getMinutes(), originalTimestampDate.getSeconds()
                );
                const calculatedTotal = quantity * sellingPrice;

                const updatedData = {
                    saleTimestamp: Timestamp.fromDate(newTimestamp),
                    buyerName: buyerName || null,
                    quantitySold: quantity,
                    pricePerUnitAtSale: sellingPrice,
                    totalSaleAmount: calculatedTotal,
                    paymentStatus: paymentStatus,
                    notes: notes || null,
                };

                await updateDoc(saleRef, updatedData);
                showNotification("✅ تم تحديث سجل البيع بنجاح!", false, 'success');
                hideEditSaleModal();
                loadSalesLog();
                fetchAllPaidSalesSummary();
                fetchAndDisplayOutstandingDebts();

            } catch (error) {
                 console.error("updateSaleEntry Error:", error);
                 showNotification(`❌ فشل تحديث السجل: ${error.message}`, true);
                 updateSaleBtn.disabled = false; updateSaleBtn.innerHTML = '<i class="fas fa-save"></i> حفظ التعديلات';
             }
        }

        // --- Delete & Clear Sales Log ---
        function confirmDeleteSalesLogEntry(saleId, buttonElement) {
            if (!saleId || !buttonElement) return;
            buttonElement.disabled = true;
            showConfirmModal(saleId, 'saleEntry');
             const cancelBtn = confirmModalEl.querySelector('.btn-cancel');
             const closeXBtn = confirmModalEl.querySelector('.close-btn');
             const enableButton = () => {
                 if(buttonElement) buttonElement.disabled = false;
                 cancelBtn?.removeEventListener('click', enableButton);
                 closeXBtn?.removeEventListener('click', enableButton);
             }
             cancelBtn?.addEventListener('click', enableButton);
             closeXBtn?.addEventListener('click', enableButton);
        }

        async function deleteSalesLogEntry(saleId) {
            if (!db || !saleId) return;
            hideConfirmModal();
            showNotification('⏳ جارٍ حذف السجل...', false, 'info');
            const rowToRemove = salesLogTableBody?.querySelector(`tr[data-sale-id="${saleId}"]`);
            const deleteButtonInRow = rowToRemove?.querySelector('.delete-sale-log-entry');

            try {
                await deleteDoc(doc(db, 'sales', saleId));
                showNotification('✅ تم حذف سجل البيع بنجاح.', false, 'success');
                if (rowToRemove) {
                    rowToRemove.style.transition = 'opacity 0.4s, transform 0.4s';
                    rowToRemove.style.opacity = '0';
                    rowToRemove.style.transform = 'translateX(50px)';
                    setTimeout(() => {
                         rowToRemove.remove();
                         if (salesLogTableBody && salesLogTableBody.rows.length === 0) {
                             loadSalesLog();
                         }
                     }, 400);
                } else {
                    loadSalesLog();
                }
                fetchAllPaidSalesSummary();
                fetchAndDisplayOutstandingDebts();
            } catch (error) {
                 console.error(`Error deleting log entry ${saleId}:`, error);
                 showNotification(`❌ فشل حذف السجل: ${error.message}`, true);
                 if (deleteButtonInRow) deleteButtonInRow.disabled = false;
            }
        }

        function confirmClearSalesLog() {
            if (!clearLogBtn || clearLogBtn.disabled) return;
            const password = prompt(`للتأكيد، أدخل كلمة السر (${CLEAR_LOG_PASSWORD}) لمسح **جميع** سجلات المبيعات:\n(لا يمكن التراجع عن هذا الإجراء!)`);
            if (password === null) return;
            if (password !== CLEAR_LOG_PASSWORD) {
                 showNotification("❌ كلمة السر المدخلة غير صحيحة!", true); return;
            }
            showConfirmModal(null, 'clearSales');
        }

        async function executeClearSalesLog() {
            if (!db) { showNotification("الخدمة غير جاهزة.", true); return; }
            hideConfirmModal();
            if (clearLogBtn) clearLogBtn.disabled = true;
            if (salesLogCloseBtn) salesLogCloseBtn.disabled = true;
            if (salesLogModalCloseIconBtn) salesLogModalCloseIconBtn.disabled = true;

            showNotification("⏳⏳ جارٍ مسح جميع سجلات المبيعات... قد يستغرق هذا بعض الوقت.", false, 'warning', 10000);

            try {
                const deletedCount = await deleteCollection(collection(db, 'sales'));
                 showNotification(`✅ تم مسح السجل بنجاح (${deletedCount} سجلات تم حذفها).`, false, 'success');
                 loadSalesLog();
                 fetchAllPaidSalesSummary();
                 fetchAndDisplayOutstandingDebts();
            } catch(e) {
                 showNotification(`❌ فشل مسح السجل بالكامل: ${e.message}`, true, 'error', 10000);
                 console.error("Error clearing sales log:", e);
            } finally {
                 if (clearLogBtn) clearLogBtn.disabled = false;
                 if (salesLogCloseBtn) salesLogCloseBtn.disabled = false;
                 if (salesLogModalCloseIconBtn) salesLogModalCloseIconBtn.disabled = false;
            }
        }

        // --- Backup and Restore ---

        async function deleteCollection(collectionRef) {
            if (!db) throw new Error("Database not initialized");
            let deletedCount = 0;
            const path = collectionRef.path || 'unknown collection'; // Get path for messages
            showNotification(`⏳ بدء حذف المجموعة: ${path}...`, false, 'info', 5000);
            try {
                while (true) {
                    const q = query(collectionRef, limit(BATCH_DELETE_LIMIT));
                    const snapshot = await getDocs(q);
                    if (snapshot.empty) break;

                    const batch = writeBatch(db);
                    snapshot.docs.forEach(d => batch.delete(d.ref));

                    const batchSize = snapshot.size;
                    await batch.commit();
                    deletedCount += batchSize;
                    showNotification(`⏳ حذف ${deletedCount} مستندات من ${path}...`, false, 'info', 3000);
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                showNotification(`✅ اكتمل حذف المجموعة: ${path} (${deletedCount} مستندات).`, false, 'success', 5000);
                return deletedCount;
            } catch (error) {
                console.error(`Error deleting collection ${path}:`, error);
                throw new Error(`فشل حذف المجموعة ${path}: ${error.message}`);
            }
        }

        async function backupData() {
             if (!db || isDefinitelyOffline) { showNotification("لا يمكن إجراء النسخ الاحتياطي وأنت غير متصل.", true, 'warning'); return; }
             if (backupBtn) backupBtn.disabled = true;
             showNotification("⏳ جارٍ تحضير النسخة الاحتياطية...", false, 'info', 10000);

             try {
                 showNotification("⏳ جلب بيانات المنتجات...", false, 'info');
                 const productsRef = collection(db, 'clothes');
                 const productsSnapshot = await getDocs(query(productsRef, orderBy('createdAt', 'desc')));
                 const products = productsSnapshot.docs.map(doc => {
                     const data = doc.data();
                     return {
                         id: doc.id, ...data,
                         createdAt: data.createdAt?.toDate ? data.createdAt.toDate().toISOString() : null,
                         updatedAt: data.updatedAt?.toDate ? data.updatedAt.toDate().toISOString() : null,
                     };
                 });
                 showNotification(`⏳ تم جلب ${products.length} منتجات.`, false, 'info');

                 showNotification("⏳ جلب بيانات المبيعات...", false, 'info');
                 const salesRef = collection(db, 'sales');
                 // Consider adding a limit if sales collection is huge, but backup should ideally be complete
                 const salesSnapshot = await getDocs(query(salesRef, orderBy('saleTimestamp', 'desc')));
                 const sales = salesSnapshot.docs.map(doc => {
                     const data = doc.data();
                     return {
                         id: doc.id, ...data,
                         saleTimestamp: data.saleTimestamp?.toDate ? data.saleTimestamp.toDate().toISOString() : null,
                     };
                 });
                 showNotification(`⏳ تم جلب ${sales.length} سجلات مبيعات.`, false, 'info');

                 const backupObject = {
                     backupVersion: BACKUP_VERSION, createdAt: new Date().toISOString(),
                     productCount: products.length, salesCount: sales.length,
                     products: products, sales: sales,
                 };

                 const jsonString = JSON.stringify(backupObject, null, 2);
                 const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
                 const link = document.createElement("a");
                 const url = URL.createObjectURL(blob);
                 link.setAttribute("href", url);
                 const dateStr = new Date().toISOString().slice(0, 10);
                 const filename = `sales_inventory_backup_${dateStr}.json`;
                 link.setAttribute("download", filename);
                 link.style.visibility = 'hidden';
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);
                 URL.revokeObjectURL(url);

                 showNotification(`✅ تم إنشاء وتنزيل ملف النسخ الاحتياطي (${filename}) بنجاح!`, false, 'success', 7000);

             } catch (error) {
                 console.error("Backup Error:", error);
                 showNotification(`❌ فشل إنشاء النسخة الاحتياطية: ${error.message}`, true, 'error', 10000);
             } finally {
                 if (backupBtn) backupBtn.disabled = false;
             }
         }

        function triggerRestore() {
             if (!db || isDefinitelyOffline) { showNotification("لا يمكن استعادة البيانات وأنت غير متصل.", true, 'warning'); return; }
             if (!restoreFileInput) { showNotification("خطأ: لم يتم العثور على عنصر إدخال الملف.", true); return; }
             restoreFileInput.value = '';
             restoreFileInput.click();
        }

        function handleRestoreFileSelect(event) {
            const file = event.target.files?.[0];
            if (!file) return; // User cancelled
            if (!file.type || file.type !== 'application/json') {
                showNotification("خطأ: يرجى اختيار ملف نسخة احتياطية بصيغة JSON (.json).", true);
                return;
            }
            showConfirmModal(null, 'restoreBackup', { file: file });
        }

        async function processRestoreFile(file) {
            if (!db || !file) {
                showNotification("خطأ: لا يوجد ملف أو قاعدة بيانات غير جاهزة.", true);
                hideConfirmModal(); return;
            }
            hideConfirmModal();
            showNotification("⏳ جارٍ قراءة ملف النسخة الاحتياطية...", false, 'info');
            if (restoreBtn) restoreBtn.disabled = true;
            if (backupBtn) backupBtn.disabled = true;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const content = e.target?.result;
                    if (typeof content !== 'string') throw new Error("فشل قراءة محتوى الملف.");
                    const backupData = JSON.parse(content);

                    if (!backupData || typeof backupData !== 'object' || backupData.backupVersion !== BACKUP_VERSION || !Array.isArray(backupData.products) || !Array.isArray(backupData.sales)) {
                         throw new Error("ملف النسخ الاحتياطي غير صالح أو غير متوافق.");
                    }
                    const productCount = backupData.products.length;
                    const salesCount = backupData.sales.length;
                    showNotification(`⏳ التحقق: ${productCount} منتجات, ${salesCount} مبيعات.`, false, 'info', 5000);

                    showNotification("⚠ تحذير: سيتم الآن حذف جميع البيانات الحالية...", false, 'warning', 8000);
                    await new Promise(resolve => setTimeout(resolve, 3000));

                    // Clear collections using helper function
                    await deleteCollection(collection(db, 'clothes'));
                    await deleteCollection(collection(db, 'sales'));
                    itemsMap.clear();
                    itemsListEl.innerHTML = '';
                    listPlaceholderEl.textContent = "جارٍ استعادة المنتجات..."; listPlaceholderEl.style.display = 'block';
                    updateMainViewStatus("جارٍ استعادة البيانات...");


                    showNotification(`⏳ بدء استعادة ${productCount} منتجات...`, false, 'info');
                    const productsRef = collection(db, 'clothes');
                    let productsBatch = writeBatch(db);
                    let productsAdded = 0;
                    for (let i = 0; i < backupData.products.length; i++) {
                         const product = backupData.products[i];
                         const docRef = doc(productsRef, product.id); // Use original ID
                         const productData = { ...product,
                             createdAt: product.createdAt ? Timestamp.fromDate(new Date(product.createdAt)) : serverTimestamp(),
                             updatedAt: product.updatedAt ? Timestamp.fromDate(new Date(product.updatedAt)) : null,
                         };
                         delete productData.id;
                         productsBatch.set(docRef, productData);
                         productsAdded++;
                         if (productsAdded % BATCH_DELETE_LIMIT === 0 || i === backupData.products.length - 1) {
                             await productsBatch.commit();
                             showNotification(`⏳ استعادة المنتجات: ${productsAdded}/${productCount}...`, false, 'info', 3000);
                             if (i < backupData.products.length - 1) productsBatch = writeBatch(db);
                         }
                    }
                    showNotification(`✅ تم استعادة ${productsAdded} منتجات.`, false, 'success', 5000);


                    showNotification(`⏳ بدء استعادة ${salesCount} سجلات مبيعات...`, false, 'info');
                    const salesRef = collection(db, 'sales');
                    let salesBatch = writeBatch(db);
                    let salesAdded = 0;
                    for (let i = 0; i < backupData.sales.length; i++) {
                         const sale = backupData.sales[i];
                         const docRef = doc(salesRef, sale.id);
                         const saleData = { ...sale,
                             saleTimestamp: sale.saleTimestamp ? Timestamp.fromDate(new Date(sale.saleTimestamp)) : serverTimestamp(),
                         };
                         delete saleData.id;
                         salesBatch.set(docRef, saleData);
                         salesAdded++;
                         if (salesAdded % BATCH_DELETE_LIMIT === 0 || i === backupData.sales.length - 1) {
                             await salesBatch.commit();
                             showNotification(`⏳ استعادة المبيعات: ${salesAdded}/${salesCount}...`, false, 'info', 3000);
                             if (i < backupData.sales.length - 1) salesBatch = writeBatch(db);
                         }
                     }
                     showNotification(`✅ تم استعادة ${salesAdded} سجلات مبيعات.`, false, 'success', 5000);


                     showNotification("🎉 اكتملت عملية الاستعادة بنجاح! سيتم تحديث الواجهة تلقائياً.", false, 'success', 7000);
                     // Data will refresh via the main listener. Refresh summaries manually.
                     fetchAllPaidSalesSummary();
                     fetchAndDisplayOutstandingDebts();
                     // Partner selects don't need explicit update as they are hardcoded now.

                } catch (error) {
                    console.error("Restore Processing Error:", error);
                    showNotification(`❌ فشلت عملية الاستعادة: ${error.message}`, true, 'error', 15000);
                     updateMainViewStatus(`فشلت الاستعادة: ${error.message}. قد تحتاج إلى إعادة تحميل الصفحة.`, true);
                } finally {
                    if (restoreBtn) restoreBtn.disabled = false;
                    if (backupBtn) backupBtn.disabled = false;
                     if (restoreFileInput) restoreFileInput.value = '';
                }
            };
            reader.onerror = (e) => {
                console.error("File Reading Error:", e);
                showNotification("❌ خطأ في قراءة الملف المحدد.", true);
                if (restoreBtn) restoreBtn.disabled = false;
                if (backupBtn) backupBtn.disabled = false;
                 if (restoreFileInput) restoreFileInput.value = '';
            };
            reader.readAsText(file);
        }

        // Add listener for the hidden file input
        if (restoreFileInput) {
             restoreFileInput.addEventListener('change', handleRestoreFileSelect);
        }

        // --- Summary Calculations ---
        async function fetchAllPaidSalesSummary() {
            if (!db || !allPaidSalesSummarySpan || !footerSummaryEl) return;
            allPaidSalesSummarySpan.innerHTML = `<span style="opacity:0.6;">جلب...</span>`;
            const q = query(collection(db, 'sales'), where('paymentStatus', '==', 'paid'));
            try {
                 const snap = await getDocs(q);
                 let total = 0;
                 snap.forEach(doc => total += parseFloat(doc.data().totalSaleAmount || 0));
                 allPaidSalesSummarySpan.innerHTML = `${formatCurrency(total)}`;
                 footerSummaryEl.style.display = 'block';
             } catch (e) {
                 console.error("Error fetching paid summary:", e);
                 allPaidSalesSummarySpan.innerHTML = `<span style="color: var(--danger);">خطأ</span>`;
                 footerSummaryEl.style.display = 'block';
             }
        }

        async function fetchAndDisplayOutstandingDebts() {
            if (!db || !totalDebtsAmountSpan || !debtsSummaryDiv) return;
            totalDebtsAmountSpan.innerHTML = `<span style="opacity:0.6;">جلب...</span>`;
            const q = query(collection(db, 'sales'), where('paymentStatus', '==', 'debt'));
            try {
                 const snap = await getDocs(q);
                 let total = 0;
                 snap.forEach(doc => total += parseFloat(doc.data().totalSaleAmount || 0));
                 if (total > 0) {
                     totalDebtsAmountSpan.innerHTML = `${formatCurrency(total)}`;
                     debtsSummaryDiv.style.display = 'block';
                 } else {
                     debtsSummaryDiv.style.display = 'none';
                 }
             } catch (e) {
                 console.error("Error fetching debts:", e);
                 totalDebtsAmountSpan.innerHTML = `<span style="color: var(--danger);">خطأ</span>`;
                 debtsSummaryDiv.style.display = 'block';
             }
        }

        // --- Initialization ---
        async function initializeAppAndFirestore() {
            console.log("Initializing Sales & Inventory PWA v10.10...");
            updateMainViewStatus("🔄 تهيئة النظام...");
            listPlaceholderEl.textContent = "جارٍ تحميل المنتجات..."; listPlaceholderEl.style.display = 'block';
            connectionStatusDotEl.className = 'connection-status-dot connecting'; updateConnectionStatusUI(navigator.onLine);

            if ('serviceWorker' in navigator) {
                 window.addEventListener('load', () => {
                     navigator.serviceWorker.register('./service-worker.js')
                        .then(reg => console.log('✅ Service Worker Registered:', reg.scope))
                        .catch(err => console.error('❌ Service Worker Registration Failed:', err));
                });
            } else {
                console.warn('Service workers are not supported in this browser.');
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                try { await enableIndexedDbPersistence(db); console.log("Offline persistence enabled."); }
                catch (err) { console.warn("Persistence Error:", err.code, err.message); if (err.code === 'failed-precondition') { showNotification("⚠️ التخزين المحلي معطل (ربما بسبب فتح علامات تبويب متعددة).", false, 'warning', 8000); } else if (err.code !== 'unimplemented') { showNotification("⚠️ خطأ في تفعيل التخزين المحلي للعمل دون اتصال.", true); } }

                const isDarkMode = localStorage.getItem('darkMode') === 'true';
                if (isDarkMode) document.body.classList.add('dark-mode');
                applyCurrentTheme();

                updateMainViewStatus("🔄 جلب بيانات المنتجات...");

                if (db && !unsubscribeItems) {
                    const itemsCollection = collection(db, 'clothes');
                    const q = query(itemsCollection, orderBy('name', 'asc'));

                    unsubscribeItems = onSnapshot(q, (snapshot) => {
                        latestSnapshotMetadata = snapshot.metadata;
                        updateConnectionStatusUI(navigator.onLine);
                        let productInfoChanged = false;
                        let itemsAddedOrRemoved = false;

                        if (snapshot.empty && firstLoadComplete) {
                             itemsMap.clear();
                             itemsListEl.innerHTML = '';
                             listPlaceholderEl.textContent = "➕ لا توجد منتجات. انقر (+) للإضافة.";
                             listPlaceholderEl.style.display = 'block';
                             populateProductSelectsInModals(); // Update dropdowns
                             itemsAddedOrRemoved = true;
                        } else {
                            snapshot.docChanges().forEach((change) => {
                                const docData = change.doc.data({ serverTimestamps: "estimate" });
                                const itemData = { id: change.doc.id, ...docData };

                                if (change.type === "added") { itemsMap.set(itemData.id, itemData); renderItemCard(itemData); productInfoChanged = true; itemsAddedOrRemoved = true; }
                                 else if (change.type === "modified") { const oldData = itemsMap.get(itemData.id); itemsMap.set(itemData.id, itemData); renderItemCard(itemData); if (oldData && (oldData.price !== itemData.price || oldData.name !== itemData.name || oldData.partnerCost !== itemData.partnerCost)) { productInfoChanged = true; } if (currentViewItemId === itemData.id && !currentEditItemId) { showItemDetails(itemData.id); } }
                                 else if (change.type === "removed") { const removedId = change.doc.id; itemsMap.delete(removedId); removeItemCard(removedId); productInfoChanged = true; itemsAddedOrRemoved = true; if (currentViewItemId === removedId) { currentViewItemId = null; updateMainViewStatus("🗑️ تم حذف المنتج."); } if (currentEditItemId === removedId) { currentEditItemId = null; updateMainViewStatus("🗑️ تم حذف المنتج."); } }
                            });
                        }

                        if (productInfoChanged) { populateProductSelectsInModals(); }
                        if (itemsAddedOrRemoved && itemsMap.size === 0 && firstLoadComplete) { updateMainViewStatus("➕ لا توجد منتجات."); }

                        if (!firstLoadComplete) {
                            firstLoadComplete = true; console.log("Initial product data sync complete.");
                            if (listPlaceholderEl) listPlaceholderEl.style.display = itemsMap.size > 0 ? 'none' : 'block';
                            if (itemsMap.size === 0 && listPlaceholderEl) { listPlaceholderEl.textContent = "➕ لا توجد منتجات. انقر (+) للإضافة."; }
                            if (!currentViewItemId && !currentEditItemId) { updateMainViewStatus(itemsMap.size > 0 ? "👈 اختر منتجاً من القائمة لعرض التفاصيل." : "➕ لا توجد منتجات، انقر (+) للإضافة."); }
                            fetchAllPaidSalesSummary(); fetchAndDisplayOutstandingDebts();
                            if (!professionalTipInterval) { showProfessionalTip(); professionalTipInterval = setInterval(showProfessionalTip, 3 * 60 * 1000); }
                             populateProductSelectsInModals(); // Populate product selects on first load
                        }
                    }, (error) => {
                        console.error("❌ Items Listener error:", error); showNotification("خطأ: فشل استقبال تحديثات المنتجات.", true); updateMainViewStatus(`فشل الاتصال بقاعدة بيانات المنتجات: ${error.message}.`, true); updateConnectionStatusUI(false); firstLoadComplete = true; if (listPlaceholderEl) { listPlaceholderEl.textContent = "❌ خطأ في تحميل المنتجات"; listPlaceholderEl.style.display = 'block'; }
                    });
                } else { throw new Error("Database not initialized or listener already exists."); }

                 window.toggleDarkMode = toggleDarkMode; window.showAddForm = showAddForm; window.hideAddForm = hideAddForm; window.addItem = addItem; window.showItemDetails = showItemDetails; window.showEditForm = showEditForm; window.cancelEdit = cancelEdit; window.updateItem = updateItem; window.showConfirmModal = showConfirmModal; window.hideConfirmModal = hideConfirmModal; window.deleteItem = deleteItem; window.showLogSaleModal = showLogSaleModal; window.hideLogSaleModal = hideLogSaleModal; window.addSaleItemEntry = addSaleItemEntry; window.removeSaleItem = removeSaleItem; window.handlePartnerSelectionChange = handlePartnerSelectionChange; window.handleProductSelectionChange = handleProductSelectionChange; window.getSelectedPartner = getSelectedPartner; window.saveSales = saveSales; window.showEditSaleModal = showEditSaleModal; window.hideEditSaleModal = hideEditSaleModal; window.updateSaleEntry = updateSaleEntry; window.updateEditSaleTotal = updateEditSaleTotal; window.showSalesLogModal = showSalesLogModal; window.hideSalesLogModal = hideSalesLogModal; window.confirmDeleteSalesLogEntry = confirmDeleteSalesLogEntry; window.deleteSalesLogEntry = deleteSalesLogEntry; window.confirmClearSalesLog = confirmClearSalesLog; window.executeClearSalesLog = executeClearSalesLog; window.showSalesReportModal = showSalesReportModal; window.hideSalesReportModal = hideSalesReportModal; window.generateSalesReport = generateSalesReport; window.exportSalesToCSV = exportSalesToCSV; window.generateInventoryHTMLReport = generateInventoryHTMLReport; window.generateBuyerReport = generateBuyerReport; window.backupData = backupData; window.triggerRestore = triggerRestore;

                console.log("✅ Application initialized successfully (v10.10).");

            } catch (initError) {
                console.error("❌ Initialization Failed:", initError); updateMainViewStatus(`فشل تهيئة التطبيق بشكل كامل: ${initError.message}.`, true); if (listPlaceholderEl) { listPlaceholderEl.textContent = "❌ فشل التهيئة"; listPlaceholderEl.style.display = 'block'; } if (connectionStatusDotEl) { connectionStatusDotEl.className = 'connection-status-dot disconnected'; connectionStatusDotEl.title = `فشل التهيئة: ${initError.message}`; } document.querySelectorAll('.control-panel button').forEach(btn => btn.disabled = true);
            }
        }

        // --- Global Event Listeners ---
        document.addEventListener('DOMContentLoaded', initializeAppAndFirestore);
        window.addEventListener('online', () => updateConnectionStatusUI(true));
        window.addEventListener('offline', () => updateConnectionStatusUI(false));
        window.addEventListener('beforeunload', () => {
             if (unsubscribeItems) { console.log("Detaching Firestore listener."); unsubscribeItems(); }
             if (professionalTipInterval) clearInterval(professionalTipInterval);
             if (toastTimer) clearTimeout(toastTimer);
        });

    </script>
</body>
</html>
