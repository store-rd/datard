<!DOCTYPE html>
<html lang="ar" class="no-js" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نظام إدارة المبيعات والمخزون الإحترافي v10.2</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Changa:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
         :root {
             /* Palette */
             --primary: #D32F2F; --secondary: #FFA000; --accent: #1976D2; --info: #388E3C; --info-hover: #2E7D32; --danger: #D32F2F; --danger-hover: #C62828; --dark: #263238; --light: #ECEFF1; --grey-light: #FAFAFA; --grey-medium: #CFD8DC; --grey-dark: #78909C; --offline-indicator: #FFA000; --timestamp-color: #90A4AE;
            /* Shadows */
             --shadow-sm: 0 2px 5px rgba(0, 0, 0, 0.07); --shadow-md: 0 6px 12px rgba(0, 0, 0, 0.1); --shadow-lg: 0 12px 25px rgba(0, 0, 0, 0.12); --shadow-inset: inset 0 1px 3px rgba(0,0,0,0.08);
            /* Dark Shadows */
             --shadow-dark-sm: 0 2px 5px rgba(0, 0, 0, 0.25); --shadow-dark-md: 0 6px 12px rgba(0, 0, 0, 0.3); --shadow-dark-lg: 0 12px 25px rgba(0, 0, 0, 0.35); --shadow-dark-inset: inset 0 1px 3px rgba(0,0,0,0.3);
            /* Font */
             --font-primary: 'Tajawal', 'Changa', sans-serif;
            /* Transitions */
             --transition-speed: 0.25s; --transition-ease: cubic-bezier(0.25, 0.8, 0.25, 1);
            /* Borders */
             --border-radius-sm: 6px; --border-radius-md: 10px; --border-radius-lg: 16px;
             /* Debt color */
             --debt-color: #c0392b;
             --debt-color-dark: #e74c3c;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-primary); background: linear-gradient(145deg, #f9fafb, #eef2f7); color: #334155; display: flex; height: 100vh; overflow: hidden; transition: background var(--transition-speed) var(--transition-ease), color var(--transition-speed) var(--transition-ease); font-size: 16px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; perspective: 1200px; }
        body.dark-mode { background: linear-gradient(145deg, #303d4a, #1d252d); color: var(--light); --shadow-sm: var(--shadow-dark-sm); --shadow-md: var(--shadow-dark-md); --shadow-lg: var(--shadow-dark-lg); --shadow-inset: var(--shadow-dark-inset); --grey-light: #455A64; --grey-medium: #546E7A; --grey-dark: #78909C; --light: #CFD8DC; --dark: #37474F; --timestamp-color: #90A4AE; --debt-color: var(--debt-color-dark); }
        .offline-banner { position: fixed; top: 0; left: 0; right: 0; background-color: var(--offline-indicator); color: white; text-align: center; padding: 6px 10px; font-size: 0.9em; z-index: 2001; display: none; box-shadow: 0 3px 6px rgba(0,0,0,0.2); font-weight: 700; animation: slideDown 0.4s ease-out; }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .offline-banner.show { display: block; }
        .sidebar { width: 360px; min-width: 320px; background: #ffffff; height: 100%; display: flex; flex-direction: column; border-left: 1px solid var(--grey-medium); box-shadow: -5px 0 20px rgba(0,0,0,0.1); z-index: 10; transition: all var(--transition-speed) var(--transition-ease); }
        .dark-mode .sidebar { background: #263238; border-left-color: #37474F; box-shadow: -5px 0 20px rgba(0,0,0,0.2); }
        .sidebar-header { padding: 20px 25px; border-bottom: 1px solid var(--grey-medium); font-size: 1.4em; font-weight: 700; color: var(--dark); flex-shrink: 0; position: relative; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(255,255,255,0)); }
         .dark-mode .sidebar-header { border-bottom-color: #37474F; color: var(--light); background: linear-gradient(to bottom, rgba(255,255,255,0.05), rgba(255,255,255,0)); }
          .connection-status-dot { width: 12px; height: 12px; border-radius: 50%; background-color: var(--connecting-indicator); display: inline-block; transition: background-color 0.5s, box-shadow 0.3s; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.1); } .connection-status-dot.connecting { background-color: var(--connecting-indicator); animation: pulse 1.5s infinite ease-in-out; } .connection-status-dot.connected { background-color: var(--info); border-color: var(--info-hover); box-shadow: 0 0 6px rgba(76, 175, 80, 0.7); animation: none; } .connection-status-dot.syncing { background-color: var(--offline-indicator); border-color: #d35400; box-shadow: 0 0 6px rgba(243, 156, 18, 0.7); animation: pulse 1s infinite ease-in-out; } .connection-status-dot.disconnected { background-color: var(--danger); border-color: var(--danger-hover); box-shadow: 0 0 6px rgba(231, 76, 60, 0.7); animation: none; } .dark-mode .connection-status-dot { border-color: rgba(255,255,255,0.2); } @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        #items-list { flex-grow: 1; overflow-y: auto; padding: 15px 20px; }
          #items-list .empty-list-placeholder { text-align: center; padding: 40px 20px; opacity: 0.6; color: var(--grey-dark); font-size: 1.1em; }
          .dark-mode #items-list .empty-list-placeholder { color: var(--grey-dark); }
        .item-card { padding: 15px; margin-bottom: 15px; background: #ffffff; border: 1px solid var(--grey-medium); border-radius: var(--border-radius-md); cursor: pointer; transition: all var(--transition-speed) var(--transition-ease); display: flex; align-items: center; gap: 15px; position: relative; border-left: 6px solid transparent; box-shadow: var(--shadow-sm); transform: translateZ(0); }
        .item-card.has-pending-writes { border-left-color: var(--offline-indicator); }
        .dark-mode .item-card { background: #37474F; border-color: #455A64; }
        .item-card:hover { transform: scale(1.03) translateZ(10px); box-shadow: var(--shadow-md); z-index: 10; }
        .item-card.selected { background: linear-gradient(135deg, var(--accent), #5dade2); color: white; border-color: var(--accent); box-shadow: 0 5px 15px rgba(30, 136, 229, 0.4); transform: scale(1.02) translateZ(5px); border-left-color: var(--accent); }
           .item-card.selected.has-pending-writes { border-left-color: var(--secondary); }
        .dark-mode .item-card.selected { background: linear-gradient(135deg, var(--primary), #f0625b); color: white; border-color: var(--primary); box-shadow: 0 5px 15px rgba(229, 57, 53, 0.4); border-left-color: var(--primary); }
           .dark-mode .item-card.selected.has-pending-writes { border-left-color: var(--secondary); }
        .item-icon { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 3px solid white; box-shadow: var(--shadow-sm); padding: 2px; background-color: var(--grey-light); transition: transform var(--transition-speed) var(--transition-ease); }
        .item-card:hover .item-icon { transform: scale(1.1); }
        .dark-mode .item-icon { border-color: var(--grey-dark); background-color: #455A64; }
        .item-card.selected .item-icon { border-color: rgba(255, 255, 255, 0.8); background-color: transparent; }
        .item-details { flex-grow: 1; overflow: hidden; }
        .item-details h4 { margin: 0 0 5px 0; font-size: 1.2em; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-details p { margin: 0; font-size: 0.95em; opacity: 0.9; white-space: nowrap; color: var(--dark); font-weight: 400; }
        .dark-mode .item-details p { color: var(--light); opacity: 0.85; }
        .item-card.selected h4, .item-card.selected p { color: white; opacity: 1; }
        .item-actions { display: flex; gap: 8px; flex-shrink: 0; align-items: center; }
        .item-actions button { background: transparent; border: 1px solid var(--grey-medium); color: var(--grey-dark); cursor: pointer; padding: 0; font-size: 1.1em; border-radius: 50%; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; transition: all var(--transition-speed) var(--transition-ease); box-shadow: var(--shadow-sm); }
        .dark-mode .item-actions button { border-color: var(--grey-dark); color: var(--grey-dark); }
        .item-card.selected .item-actions button { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); color: white; }
        .item-actions button:hover { transform: scale(1.1); box-shadow: var(--shadow-md); }
        .item-actions .edit-btn:hover { background-color: var(--info); color: white; border-color: transparent; }
        .item-actions .delete-btn:hover { background-color: var(--danger); color: white; border-color: transparent; }
        .sidebar-footer { padding: 20px; border-top: 1px solid var(--grey-medium); flex-shrink: 0; background: #F5F7FA; }
        .dark-mode .sidebar-footer { border-top-color: #37474F; background: #2a353c; }
        /* Footer Summary */
        #footer-summary { text-align: center; margin-bottom: 10px; font-weight: bold; font-size: 1.05em; color: var(--dark); }
        .dark-mode #footer-summary { color: var(--light); }
        #daily-sales-summary { color: var(--info); font-weight: 700; font-size: 1.1em; }
        .dark-mode #daily-sales-summary { color: var(--accent); }
        /* Debts Summary Style */
        #debts-summary { text-align: center; margin-bottom: 15px; font-weight: bold; font-size: 1.05em; color: var(--dark); display: none; }
        .dark-mode #debts-summary { color: var(--light); }
        #total-debts-amount { color: var(--debt-color); font-weight: 700; font-size: 1.1em; }

        .report-btn { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 12px 15px; background-color: var(--dark); color: white; border: none; border-radius: var(--border-radius-md); cursor: pointer; font-family: var(--font-primary); font-size: 1.05em; transition: all var(--transition-speed) var(--transition-ease); font-weight: 700; box-shadow: var(--shadow-sm); }
        .report-btn:hover { background-color: #455A64; transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .dark-mode .report-btn { background-color: var(--grey-dark); color: var(--dark); }
        .dark-mode .report-btn:hover { background-color: #607D8B; }
        .report-btn .icon, .report-btn i { margin-left: 5px; }

        #detail-view-container { flex-grow: 1; height: 100%; padding: 40px; overflow-y: auto; position: relative; display: flex; align-items:center; justify-content: center; background-color: #ffffff; }
        .dark-mode #detail-view-container { background-color: #303d4a; }
        .detail-placeholder, .detail-error { text-align: center; padding: 30px; font-size: 1.25em; font-weight: 700; opacity: 0.7; }
        .detail-placeholder { color: var(--grey-dark); }
        .dark-mode .detail-placeholder { color: #90A4AE; }
        .detail-error { color: var(--danger); background-color: rgba(229, 57, 53, 0.08); border: 1px solid rgba(229, 57, 53, 0.3); border-radius: var(--border-radius-md); }
        .dark-mode .detail-error { background-color: rgba(229, 57, 53, 0.15); }
        .detail-error strong { display: block; margin-bottom: 8px; }
        .detail-content, .edit-form-container { background: #ffffff; padding: 35px 40px; border-radius: var(--border-radius-lg); border: 1px solid var(--grey-medium); box-shadow: var(--shadow-lg); width: 100%; max-width: 580px; animation: fadeIn 0.5s var(--transition-ease); transform: translateZ(0); }
        .dark-mode .detail-content, .dark-mode .edit-form-container { background: #2C3E50; border-color: #455A64; box-shadow: var(--shadow-lg); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px) translateZ(0); } to { opacity: 1; transform: translateY(0) translateZ(0); } }
        .detail-content h2, .edit-form-container h3 { margin-top: 0; margin-bottom: 30px; color: var(--primary); text-align: center; font-weight: 700; font-size: 1.8em; }
        .dark-mode .detail-content h2, .dark-mode .edit-form-container h3 { color: var(--secondary); }
        .detail-content p { margin-bottom: 18px; font-size: 1.1em; line-height: 1.8; }
        .detail-content p strong { color: var(--dark); font-weight: 700; margin-left: 8px; }
        .dark-mode .detail-content p strong { color: var(--light); }
        .detail-content .timestamp { font-size: 0.9em; color: var(--timestamp-color); text-align: center; margin-top: 30px; border-top: 1px dashed var(--grey-dark); padding-top: 20px; line-height: 1.7; }
        .dark-mode .detail-content .timestamp { border-top-color: #455A64; }
        .detail-content .history-section { font-size: 0.9em; color: var(--timestamp-color); text-align: right; margin-top: 30px; border-top: 1px dashed var(--grey-dark); padding-top: 20px; line-height: 1.7; max-height: 220px; overflow-y: auto; background: rgba(0,0,0,0.02); padding: 15px; border-radius: var(--border-radius-md); }
        .dark-mode .detail-content .history-section { border-top-color: #455A64; background: rgba(255,255,255,0.04);}
        .history-section h4 { margin-bottom: 12px; color: var(--dark); font-size: 1.05em; text-align: center; font-weight: 700; }
        .dark-mode .history-section h4 { color: var(--light); }
        .history-section ul { list-style: none; padding: 0; margin: 0; }
        .history-section li { margin-bottom: 14px; padding-bottom: 12px; border-bottom: 1px solid rgba(0,0,0,0.06); }
        .dark-mode .history-section li { border-bottom-color: rgba(255,255,255,0.08); }
        .history-section li:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0;}
        .history-section .history-timestamp { font-weight: 700; color: var(--accent); display: block; margin-bottom: 6px; font-size: 0.95em; }
        .dark-mode .history-section .history-timestamp { color: var(--secondary); }
        .history-section .change-detail { display: block; font-size: 1em; color: var(--dark); }
        .dark-mode .history-section .change-detail { color: var(--light); }
        .history-section del { opacity: 0.7; text-decoration: line-through; color: var(--danger); background-color: rgba(229, 57, 53, 0.05); padding: 0 2px; border-radius: 3px;}
        .dark-mode .history-section del { color: #ff8a80; background-color: rgba(255, 138, 128, 0.1); }
        .detail-content img.detail-icon { display: block; width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 30px auto; border: 5px solid white; box-shadow: var(--shadow-lg); background-color: var(--grey-light); object-fit: cover; }
        .dark-mode .detail-content img.detail-icon { border-color: var(--grey-dark); background-color: #546E7A; }

        /* Form Input Styling */
        .edit-form-container label, .modal-content label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 1em; color: #455A64; }
        .dark-mode .edit-form-container label, .dark-mode .modal-content label { color: #B0BEC5; }
        .edit-form-container input[type="text"], .edit-form-container input[type="number"], .edit-form-container input[type="url"],
        .modal-content input[type="text"], .modal-content input[type="number"], .modal-content input[type="url"], .modal-content select, .modal-content input[type="date"] {
             width: 100%; padding: 15px; margin-bottom: 20px; border: 1px solid var(--grey-medium); border-radius: var(--border-radius-md); font-family: var(--font-primary); font-size: 1em; transition: border-color var(--transition-speed) var(--transition-ease), box-shadow var(--transition-speed) var(--transition-ease); box-shadow: var(--shadow-inset); background-color: #FFFFFF;
        }
        .edit-form-container input:focus, .modal-content input:focus, .modal-content select:focus, .modal-content input[type="date"]:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.2), var(--shadow-inset); outline: none; }
        .dark-mode .edit-form-container input[type="text"], .dark-mode .edit-form-container input[type="number"], .dark-mode .edit-form-container input[type="url"],
        .dark-mode .modal-content input[type="text"], .dark-mode .modal-content input[type="number"], .dark-mode .modal-content input[type="url"], .dark-mode .modal-content select, .dark-mode .modal-content input[type="date"] { background-color: #455A64; border-color: #546E7A; color: var(--light); box-shadow: var(--shadow-dark-inset); }
        .dark-mode .edit-form-container input:focus, .dark-mode .modal-content input:focus, .dark-mode .modal-content select:focus, .dark-mode .modal-content input[type="date"]:focus { border-color: var(--secondary); box-shadow: 0 0 0 3px rgba(255, 179, 0, 0.2), var(--shadow-dark-inset); }
        /* Readonly input style */
        .modal-content input:read-only, .modal-content input:disabled { background-color: #eeeeee !important; cursor: not-allowed; opacity: 0.7; }
        .dark-mode .modal-content input:read-only, .dark-mode .modal-content input:disabled { background-color: #546e7a !important; }

        /* Payment Status Radio Button Styling */
        .payment-status-group { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; justify-content: center; padding: 10px; background-color: rgba(0,0,0,0.02); border-radius: var(--border-radius-md); }
        .dark-mode .payment-status-group { background-color: rgba(255,255,255,0.05); }
        .payment-status-group label { margin-bottom: 0; display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 600; padding: 8px 12px; border-radius: var(--border-radius-sm); transition: background-color 0.2s ease; }
        .payment-status-group input[type="radio"] { appearance: none; -webkit-appearance: none; margin: 0; width: 18px; height: 18px; border: 2px solid var(--grey-dark); border-radius: 50%; display: grid; place-content: center; transition: border-color 0.2s ease; }
        .dark-mode .payment-status-group input[type="radio"] { border-color: var(--grey-medium); }
        .payment-status-group input[type="radio"]::before { content: ""; width: 10px; height: 10px; border-radius: 50%; background-color: var(--accent); transform: scale(0); transition: transform 0.2s ease-in-out; }
        .dark-mode .payment-status-group input[type="radio"]::before { background-color: var(--secondary); }
        .payment-status-group input[type="radio"]:checked { border-color: var(--accent); }
        .dark-mode .payment-status-group input[type="radio"]:checked { border-color: var(--secondary); }
        .payment-status-group input[type="radio"]:checked::before { transform: scale(1); }
        .payment-status-group label:hover { background-color: rgba(0,0,0,0.05); }
        .dark-mode .payment-status-group label:hover { background-color: rgba(255,255,255,0.1); }

        /* Button Styling */
        .form-buttons { display: flex; gap: 15px; margin-top: 30px; }
        .form-buttons button, .modal-footer button {
             flex-grow: 1; padding: 15px; border: none; border-radius: var(--border-radius-md); cursor: pointer; font-family: var(--font-primary); font-weight: 700; font-size: 1.1em; transition: all var(--transition-speed) var(--transition-ease); display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: var(--shadow-sm);
        }
        .form-buttons button:hover:not(:disabled), .modal-footer button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .form-buttons button:active:not(:disabled), .modal-footer button:active:not(:disabled) { transform: translateY(-1px); box-shadow: var(--shadow-sm); }
        .form-buttons button:disabled, .modal-footer button:disabled { opacity: 0.6; cursor: not-allowed; background: var(--grey-medium) !important; color: var(--grey-dark) !important; box-shadow: none !important; transform: none !important; text-shadow: none !important; }
        .dark-mode .form-buttons button:disabled, .dark-mode .modal-footer button:disabled { background: var(--grey-dark) !important; color: var(--grey-medium) !important; }
        .form-buttons .btn-save, .modal-footer .btn-save {
             background: linear-gradient(135deg, var(--info), var(--info-hover)); color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .form-buttons .btn-save:hover:not(:disabled), .modal-footer .btn-save:hover:not(:disabled) { background: linear-gradient(135deg, var(--info-hover), var(--info)); }
        .form-buttons .btn-cancel, .modal-footer .btn-cancel {
             background: linear-gradient(135deg, #B0BEC5, #90A4AE); color: #37474F; }
        .form-buttons .btn-cancel:hover:not(:disabled), .modal-footer .btn-cancel:hover:not(:disabled) { background: linear-gradient(135deg, #90A4AE, #78909C); }

        /* Dark Mode Button Styles */
        .dark-mode .form-buttons .btn-save, .dark-mode .modal-footer .btn-save { background: linear-gradient(135deg, var(--accent), #4fa8e1); }
        .dark-mode .form-buttons .btn-save:hover:not(:disabled), .dark-mode .modal-footer .btn-save:hover:not(:disabled) { background: linear-gradient(135deg, #4fa8e1, var(--accent)); }
        .dark-mode .form-buttons .btn-cancel, .dark-mode .modal-footer .btn-cancel { background: linear-gradient(135deg, #546E7A, #455A64); color: var(--light); }
        .dark-mode .form-buttons .btn-cancel:hover:not(:disabled), .dark-mode .modal-footer .btn-cancel:hover:not(:disabled) { background: linear-gradient(135deg, #455A64, #37474F); }

        /* Modal Styling */
        .modal { position: fixed; inset: 0; background: rgba(38, 50, 56, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.4s var(--transition-ease), visibility 0s linear 0.4s; backdrop-filter: blur(8px); overflow-y: auto; padding: 20px 0; }
        .modal.show { opacity: 1; visibility: visible; transition-delay: 0s; }
        .modal-content { background: #ffffff; padding: 40px; border-radius: var(--border-radius-lg); width: 90%; max-width: 550px; box-shadow: var(--shadow-lg); position: relative; transform: scale(0.9) translateY(20px); transition: transform 0.4s var(--transition-ease); margin: auto; }
        .modal.show .modal-content { transform: scale(1) translateY(0); }
        .dark-mode .modal-content { background: #37474F; color: var(--light); box-shadow: var(--shadow-lg); }
        .modal-content h3 { margin-top: 0; margin-bottom: 30px; text-align: center; color: var(--primary); font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1.6em; }
        .dark-mode .modal-content h3 { color: var(--secondary); }
        .close-btn { position: absolute; top: 15px; left: 20px; background: none; border: none; font-size: 2.5em; color: var(--grey-dark); cursor: pointer; line-height: 1; padding: 5px; transition: color var(--transition-speed) var(--transition-ease), transform var(--transition-speed) var(--transition-ease); z-index: 10; }
        .close-btn:hover { color: var(--danger); transform: rotate(90deg) scale(1.15); }
        .dark-mode .close-btn { color: #78909C; }
        .dark-mode .close-btn:hover { color: var(--primary); }
        #confirmMessage { font-size: 1.15em; line-height: 1.7; }

        /* Log Sale & Edit Sale Modal Specific Styles */
        #logSaleModal .modal-content, #editSaleModal .modal-content { max-width: 680px; }
        #logSaleModal .sale-item-entry, #editSaleModal .sale-item-entry { display: grid; grid-template-columns: 1fr auto auto auto; gap: 10px; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed var(--grey-medium); }
        .dark-mode #logSaleModal .sale-item-entry, .dark-mode #editSaleModal .sale-item-entry { border-bottom-color: var(--grey-dark); }
        #logSaleModal .sale-item-entry label, #editSaleModal .sale-item-entry label { display: none; }
        #logSaleModal .sale-item-entry select, #logSaleModal .sale-item-entry input,
        #editSaleModal .sale-item-entry select, #editSaleModal .sale-item-entry input { margin-bottom: 0; font-size: 0.95em; }
        /* Grid layout for logSaleModal */
        #logSaleModal .sale-item-entry .sale-product-select { grid-column: 1 / span 4; }
        #logSaleModal .sale-item-entry .sale-price-input { grid-column: 1 / span 1; width: auto; }
        #logSaleModal .sale-item-entry .sale-quantity-input { grid-column: 2 / span 1; width: 90px; text-align: center; }
        #logSaleModal .sale-item-entry .remove-sale-item-btn { grid-column: 4 / span 1; background: transparent; border: none; color: var(--danger); font-size: 1.4em; cursor: pointer; padding: 0 5px; transition: color 0.2s; justify-self: end; }
        #logSaleModal .sale-item-entry .remove-sale-item-btn:hover { color: var(--danger-hover); }
        /* Grid layout for editSaleModal */
        #editSaleModal .sale-item-entry { grid-template-columns: 1fr auto auto; }
        #editSaleModal .sale-item-entry input[type="text"] { grid-column: 1 / span 3; }
        #editSaleModal .sale-item-entry #editSalePrice { grid-column: 1 / span 1; width: auto; }
        #editSaleModal .sale-item-entry #editSaleQuantity { grid-column: 2 / span 1; width: 90px; text-align: center; }

        #add-sale-item-btn { display: block; width: auto; margin: 15px auto 20px auto; padding: 10px 20px; background-color: var(--accent); color: white; border: none; border-radius: var(--border-radius-md); cursor: pointer; font-weight: bold; box-shadow: var(--shadow-sm); transition: all var(--transition-speed) var(--transition-ease); }
        #add-sale-item-btn:hover { background-color: #1565C0; box-shadow: var(--shadow-md); transform: translateY(-2px);}
        .dark-mode #add-sale-item-btn { background-color: var(--secondary); color: var(--dark); }
        .dark-mode #add-sale-item-btn:hover { background-color: #FF8F00; }

           /* Sales Report & Log Modal Styles */
        #salesReportModal .modal-content, #salesLogModal .modal-content { max-width: 950px; }
        .report-controls { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--grey-medium); align-items: flex-end; }
        .dark-mode .report-controls { border-bottom-color: var(--grey-dark); }
        .report-controls > div { display: flex; flex-direction: column; flex-grow: 1; min-width: 120px; }
        .report-controls label { margin-bottom: 5px; font-size: 0.9em; font-weight: 600; }
        .report-controls input[type="date"], .report-controls select { width: 100%; margin-bottom: 0; padding: 10px 12px; font-size: 0.95em; }
        .report-controls button { padding: 10px 15px; font-size: 0.95em; margin-top: auto; flex-grow: 0 !important; width: 100%; }

        #salesReportArea, #salesLogArea { margin-top: 20px; max-height: 60vh; overflow-y: auto; }
        #salesReportArea h4, #salesLogArea h4 { margin-bottom: 15px; text-align: center; color: var(--primary); font-size: 1.3em; }
        .dark-mode #salesReportArea h4, .dark-mode #salesLogArea h4 { color: var(--secondary); }
        #salesReportArea table, #salesLogTable { width: 100%; border-collapse: collapse; font-size: 0.9em; table-layout: auto; }
        #salesReportArea th, #salesReportArea td, #salesLogTable th, #salesLogTable td { border: 1px solid var(--grey-medium); padding: 10px 12px; text-align: right; vertical-align: middle; white-space: nowrap; }
        #salesLogTable td:nth-child(2), #salesLogTable td:nth-child(3),
        #salesReportArea td:nth-child(2), #salesReportArea td:nth-child(3) { white-space: normal; min-width: 120px; }
        #salesReportArea th, #salesLogTable th { background-color: var(--grey-light); font-weight: 700; position: sticky; top: 0; z-index: 1;}
        #salesReportArea td.number-cell, #salesLogTable td.number-cell { text-align: left; font-feature-settings: "tnum"; font-weight: 600; }
        .dark-mode #salesReportArea th, .dark-mode #salesLogTable th { background-color: var(--grey-dark); }
        .dark-mode #salesReportArea th, .dark-mode #salesReportArea td, .dark-mode #salesLogTable th, .dark-mode #salesLogTable td { border-color: var(--grey-medium); }
        #salesReportArea .report-summary p { font-size: 1.1em; font-weight: bold; margin-bottom: 10px; padding: 5px; border-bottom: 1px solid var(--grey-medium); }
        .dark-mode #salesReportArea .report-summary p { border-bottom-color: var(--grey-dark); }
        #salesReportArea .report-summary span { color: var(--info); font-size: 1.05em; }
        .dark-mode #salesReportArea .report-summary span { color: var(--accent); }

           /* Sales Log Table Specific */
           #salesLogTable .sale-status { font-weight: bold; text-align: center; }
           #salesLogTable .sale-status-paid { color: var(--info); }
           #salesLogTable .sale-status-debt { color: var(--debt-color); }
           #salesLogTable .log-actions { text-align: center; white-space: nowrap; }
           #salesLogTable .log-actions button { background: transparent; border: none; cursor: pointer; padding: 0 5px; font-size: 1.1em; opacity: 0.7; transition: opacity 0.2s, color 0.2s; margin: 0 3px; vertical-align: middle; }
           #salesLogTable .log-actions .edit-sale-log-entry { color: var(--accent); }
           #salesLogTable .log-actions .delete-sale-log-entry { color: var(--danger); }
           #salesLogTable .log-actions button:hover { opacity: 1; }
           #salesLogTable .log-actions .edit-sale-log-entry:hover { color: var(--info); }
           #salesLogTable .log-actions .delete-sale-log-entry:hover { color: var(--danger-hover); }

           #salesLogModal .modal-footer { margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--grey-medium); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
           .dark-mode #salesLogModal .modal-footer { border-top-color: var(--grey-dark); }
           #salesLogModal #clear-log-btn { background: linear-gradient(135deg, var(--danger), var(--danger-hover)); color: white; flex-grow: 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); font-size: 1em; padding: 12px 18px; }
           #salesLogModal #clear-log-btn:hover:not(:disabled) { background: linear-gradient(135deg, var(--danger-hover), var(--danger)); transform: translateY(-3px); box-shadow: var(--shadow-md); }
           #salesLogModal #clear-log-btn:active:not(:disabled) { transform: translateY(-1px); box-shadow: var(--shadow-sm); }
           .dark-mode #salesLogModal #clear-log-btn { background: linear-gradient(135deg, #e57373, var(--danger)); }
           .dark-mode #salesLogModal #clear-log-btn:hover:not(:disabled) { background: linear-gradient(135deg, var(--danger), #e57373); }
           #salesLogModal .modal-footer .btn-cancel { flex-grow: 0; font-size: 1em; padding: 12px 18px; }

        /* Toast Styles */
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #263238; color: white; padding: 14px 25px; border-radius: var(--border-radius-md); z-index: 2000; font-size: 1em; box-shadow: var(--shadow-md); opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0s linear 0.4s, bottom 0.4s ease; font-weight: 700; } #toast.show { opacity: 1; visibility: visible; bottom: 30px; transition: opacity 0.4s ease, visibility 0s linear 0s, bottom 0.4s ease; } #toast.error { background-color: var(--danger); } #toast.warning { background-color: var(--offline-indicator); color: #212121; } #toast.success { background-color: var(--info); } .dark-mode #toast { background: #CFD8DC; color: #263238; } .dark-mode #toast.error { background-color: var(--danger-hover); color: white; } .dark-mode #toast.warning { background-color: var(--secondary); color: #424242; } .dark-mode #toast.success { background-color: var(--info-hover); color: white;}

        /* Control Panel Styles */
        .control-panel { position: fixed; bottom: 30px; left: 30px; display: flex; flex-direction: column; gap: 18px; z-index: 100; }
        .btn-magic { background: linear-gradient(145deg, var(--accent), #5dade2); border: none; width: 60px; height: 60px; border-radius: 50%; color: white; font-size: 1.8em; cursor: pointer; transition: all var(--transition-speed) var(--transition-ease); box-shadow: var(--shadow-md); display: flex; justify-content: center; align-items: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
           .btn-magic i { line-height: 1; }
        .btn-magic:hover { background: linear-gradient(145deg, #5dade2, var(--accent)); transform: translateY(-4px) scale(1.08); box-shadow: var(--shadow-lg); }
        .btn-magic:active { transform: translateY(-1px) scale(1.02); }
        .dark-mode .btn-magic { background: linear-gradient(145deg, var(--secondary), #ffca28); color: #3a3a3a; box-shadow: var(--shadow-md); text-shadow: none; }
        .dark-mode .btn-magic:hover { background: linear-gradient(145deg, #ffca28, var(--secondary)); }

        /* Responsive Design */
        @media (max-width: 768px) {
             body { flex-direction: column; overflow-y: auto; height: auto; font-size: 15px; perspective: none; }
             #detail-view-container { order: 1; height: auto; min-height: 40vh; padding: 25px 15px; }
             .detail-content, .edit-form-container { padding: 25px; max-width: none; }
             .sidebar { order: 2; width: 100%; height: auto; min-height: 55vh; border-left: none; border-top: 1px solid var(--grey-medium); box-shadow: none; }
             .dark-mode .sidebar { border-top-color: #37474F; }
             #items-list { max-height: none; padding: 10px; }
             .sidebar-header { padding: 18px 15px; font-size: 1.25em; }
             .sidebar-footer { padding: 18px 15px; }
             .control-panel { bottom: 20px; left: auto; right: 20px; transform: none; flex-direction: row; gap: 10px; background: transparent; box-shadow: none; width: calc(100% - 40px); justify-content: space-around; }
             .btn-magic { width: 48px; height: 48px; font-size: 1.4em; box-shadow: var(--shadow-md); flex-shrink: 1; }
               .dark-mode .btn-magic { box-shadow: var(--shadow-dark-md); }
             #toast { bottom: 85px; width: calc(100% - 30px); left: 15px; transform: none; text-align: center; }
             .modal-content { width: 95%; padding: 30px 25px; max-width: 95%; }
             .form-buttons { flex-direction: column; gap: 15px;}
               .detail-content .history-section { max-height: 180px; }
               /* Mobile grid layout */
               #logSaleModal .sale-item-entry, #editSaleModal .sale-item-entry { grid-template-columns: 1fr auto; row-gap: 8px; column-gap: 10px; }
               #logSaleModal .sale-item-entry .sale-product-select { grid-column: 1 / span 2; }
               #logSaleModal .sale-item-entry .sale-price-input { grid-column: 1 / span 1; width: auto; }
               #logSaleModal .sale-item-entry .sale-quantity-input { grid-column: 2 / span 1; width: auto; text-align: center; }
               #logSaleModal .sale-item-entry .remove-sale-item-btn { grid-column: 1 / span 2; justify-self: center; margin-top: 5px; }
               #editSaleModal .sale-item-entry { grid-template-columns: 1fr auto; }
               #editSaleModal .sale-item-entry input[type="text"] { grid-column: 1 / span 2; }
               #editSaleModal .sale-item-entry #editSalePrice { grid-column: 1 / span 1; width: auto; }
               #editSaleModal .sale-item-entry #editSaleQuantity { grid-column: 2 / span 1; width: auto; }

               #salesReportModal .report-controls, #salesLogModal .report-controls { flex-direction: column; gap: 10px; }
               #salesReportModal .report-controls > div, #salesLogModal .report-controls > div { width: 100%;}
               #salesReportModal .report-controls button { width: 100%; margin-top: 5px; }
               #salesReportArea, #salesLogArea { font-size: 0.85em; }
               #salesReportArea th, #salesReportArea td, #salesLogTable th, #salesLogTable td { padding: 6px 8px; white-space: normal; }
               #salesLogModal .modal-footer { justify-content: space-around; }
        }

    </style>
</head>
<body>

    <div id="offlineBanner" class="offline-banner">أنت غير متصل حالياً. قد تكون بعض البيانات غير محدثة.</div>
    <div id="detail-view-container">
        <div class="detail-placeholder" id="main-placeholder">🔄 تهيئة النظام...</div>
    </div>
    <div class="sidebar">
        <div class="sidebar-header">
             <span><i class="fas fa-store"></i>V10.2 المنتجات والمبيعات</span>
             <span id="connectionStatus" class="connection-status-dot connecting" title="حالة الاتصال"></span>
        </div>
        <div id="items-list">
             <div class="empty-list-placeholder" id="list-placeholder" style="display: none;">جارٍ تحميل المنتجات...</div>
        </div>
        <div class="sidebar-footer">
             <div id="footer-summary">
                  مبيعات(المدفوعة): <span id="daily-sales-summary">جار التحميل...</span>
             </div>
             <div id="debts-summary">
                  الديون المطلوبة: <span id="total-debts-amount">جار التحميل...</span>
             </div>
             <button class="report-btn" onclick="window.generateInventoryReport()" title="تنزيل تقرير المنتجات الحالية"><i class="fas fa-boxes"></i> تقرير المنتجات</button>
        </div>
    </div>
    <div id="addFormModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="window.hideAddForm()" title="إغلاق">&times;</button>
            <h3><i class="fas fa-box-open"></i> إضافة منتج</h3>
            <label for="itemName">اسم المنتج:</label>
            <input type="text" id="itemName" placeholder="مثال: قميص..." required>
            <label for="itemPrice">سعر البيع (د.ع):</label>
            <input type="number" id="itemPrice" placeholder="مثال: 25000" required min="0" step="any">
            <label for="itemIconUrl">رابط الأيقونة (اختياري):</label>
            <input type="url" id="itemIconUrl" placeholder="اتركه فارغاً للأيقونة التلقائية">
            <div class="form-buttons">
                <button id="addItemBtn" class="btn-save" onclick="window.addItem()"><i class="fas fa-plus"></i> إضافة المنتج</button>
                <button class="btn-cancel" onclick="window.hideAddForm()">إلغاء</button>
            </div>
        </div>
    </div>
    <div id="logSaleModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="window.hideLogSaleModal()" title="إغلاق">&times;</button>
            <h3><i class="fas fa-cash-register"></i> تسجيل مبيعات</h3>
            <label for="saleDate"><i class="fas fa-calendar-alt"></i> تاريخ البيع:</label>
            <input type="date" id="saleDate" required>
            <label for="saleBuyerName"><i class="fas fa-user"></i> اسم المشتري:</label>
            <input type="text" id="saleBuyerName" placeholder="اسم العميل (اختياري)">
            <label><i class="fas fa-money-bill-wave"></i> حالة الدفع:</label>
            <div class="payment-status-group">
                <label><input type="radio" id="saleStatusPaid" name="salePaymentStatus" value="paid" checked><span>تم الدفع</span></label>
                <label><input type="radio" id="saleStatusDebt" name="salePaymentStatus" value="debt"><span>دين</span></label>
            </div>
            <hr style="margin: 20px 0; border: none; border-top: 1px dashed var(--grey-medium);">
            <label><i class="fas fa-shopping-cart"></i> البنود المباعة:</label>
            <div id="sale-items-list">
                <div class="sale-item-entry">
                    <select class="sale-product-select" required onchange="window.handleProductSelectionChange(this)"><option value="" disabled selected>-- اختر المنتج --</option></select>
                    <input type="number" class="sale-price-input" placeholder="سعر البيع" min="0" step="any" required>
                    <input type="number" class="sale-quantity-input" placeholder="الكمية" min="1" required>
                    <button type="button" class="remove-sale-item-btn" title="إزالة" onclick="window.removeSaleItem(this)">&times;</button>
                </div>
            </div>
            <button type="button" id="add-sale-item-btn" onclick="window.addSaleItemEntry()"><i class="fas fa-plus"></i> إضافة بند آخر</button>
            <div class="form-buttons">
                <button id="saveSaleBtn" class="btn-save" onclick="window.saveSales()"><i class="fas fa-save"></i> حفظ المبيعات</button>
                <button class="btn-cancel" onclick="window.hideLogSaleModal()">إلغاء</button>
            </div>
        </div>
    </div>
    <div id="editSaleModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="window.hideEditSaleModal()" title="إغلاق">&times;</button>
            <h3><i class="fas fa-edit"></i> تعديل عملية بيع</h3>
            <input type="hidden" id="editSaleId">
            <label for="editSaleDate"><i class="fas fa-calendar-alt"></i> تاريخ البيع:</label>
            <input type="date" id="editSaleDate" required>
            <label for="editSaleBuyerName"><i class="fas fa-user"></i> اسم المشتري:</label>
            <input type="text" id="editSaleBuyerName" placeholder="اسم العميل (اختياري)">
            <label><i class="fas fa-money-bill-wave"></i> حالة الدفع:</label>
            <div class="payment-status-group">
                <label><input type="radio" id="editSaleStatusPaid" name="editSalePaymentStatus" value="paid"><span>تم الدفع</span></label>
                <label><input type="radio" id="editSaleStatusDebt" name="editSalePaymentStatus" value="debt"><span>دين</span></label>
            </div>
            <hr style="margin: 20px 0; border: none; border-top: 1px dashed var(--grey-medium);">
            <label><i class="fas fa-box"></i> تفاصيل المنتج:</label>
            <div class="sale-item-entry">
                 <input type="text" id="editSaleProductName" readonly disabled>
                 <input type="number" id="editSalePrice" placeholder="سعر البيع" min="0" step="any" required>
                 <input type="number" id="editSaleQuantity" placeholder="الكمية" min="1" required>
           </div>
            <div class="form-buttons">
                 <button id="updateSaleBtn" class="btn-save" onclick="window.updateSaleEntry()"><i class="fas fa-save"></i> حفظ التعديلات</button>
                 <button class="btn-cancel" onclick="window.hideEditSaleModal()">إلغاء</button>
            </div>
        </div>
    </div>
    <div id="salesReportModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="window.hideSalesReportModal()" title="إغلاق">&times;</button>
            <h3><i class="fas fa-chart-line"></i> تقارير المبيعات</h3>
            <div class="report-controls">
                <div> <label for="reportStartDate">من:</label> <input type="date" id="reportStartDate" required> </div>
                <div> <label for="reportEndDate">إلى:</label> <input type="date" id="reportEndDate" required> </div>
                <div> <label for="reportPaymentStatusFilter">حالة الدفع:</label>
                    <select id="reportPaymentStatusFilter">
                        <option value="all">الكل</option>
                        <option value="paid">مدفوع فقط</option>
                        <option value="debt">دين فقط</option>
                    </select>
                </div>
                <div> <label>&nbsp;</label> <button class="btn-save" onclick="window.generateSalesReport('summary')"><i class="fas fa-calculator"></i> ملخص</button> </div>
                <div> <label>&nbsp;</label> <button class="btn-save" onclick="window.generateSalesReport('bestSellerQty')"><i class="fas fa-star"></i> الأكثر (كمية)</button> </div>
                <div> <label>&nbsp;</label> <button class="btn-save" onclick="window.generateSalesReport('bestSellerValue')"><i class="fas fa-dollar-sign"></i> الأكثر (قيمة)</button> </div>
                <div> <label>&nbsp;</label> <button class="btn-save" onclick="window.exportSalesToCSV()"><i class="fas fa-file-csv"></i> تصدير CSV</button> </div>
            </div>
            <div id="salesReportArea">
                <p class="detail-placeholder">اختر فترة زمنية ونوع التقرير.</p>
            </div>
        </div>
    </div>
    <div id="salesLogModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="window.hideSalesLogModal()" title="إغلاق">&times;</button>
            <h3><i class="fas fa-history"></i> سجل المبيعات</h3>
            <div id="salesLogArea">
                <p class="detail-placeholder">جارٍ تحميل السجل...</p>
                <table id="salesLogTable" style="display: none;">
                    <thead><tr><th>التاريخ والوقت</th><th>اسم المشتري</th><th>اسم المنتج</th><th>الكمية</th><th>سعر الوحدة</th><th>الإجمالي</th><th>الحالة</th><th>إجراء</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button id="clear-log-btn" onclick="window.confirmClearSalesLog()"><i class="fas fa-exclamation-triangle"></i> مسح كل السجل</button>
                <button class="btn-cancel" onclick="window.hideSalesLogModal()">إغلاق</button>
            </div>
        </div>
    </div>
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="window.hideConfirmModal()" title="إغلاق">&times;</button>
            <h3 id="confirmTitle"><i class="fas fa-exclamation-triangle"></i> تأكيد الإجراء</h3>
            <p id="confirmMessage" style="text-align: center; margin-bottom: 25px; font-size: 1.1em;">هل أنت متأكد؟</p>
            <div class="form-buttons">
                <button id="confirmActionBtn" class="btn-save"><i class="fas fa-check"></i> نعم، تأكيد</button>
                <button class="btn-cancel" onclick="window.hideConfirmModal()">إلغاء</button>
            </div>
        </div>
    </div>
    <div id="toast"></div>
    <div class="control-panel">
        <button class="btn-magic" onclick="window.toggleDarkMode()" title="تبديل الوضع"><i class="fas fa-lightbulb"></i></button>
        <button class="btn-magic" onclick="window.showAddForm()" title="إضافة منتج"><i class="fas fa-plus"></i></button>
        <button class="btn-magic" onclick="window.showLogSaleModal()" title="تسجيل مبيعات"><i class="fas fa-cash-register"></i></button>
        <button class="btn-magic" onclick="window.showSalesLogModal()" title="عرض سجل المبيعات"><i class="fas fa-history"></i></button>
        <button class="btn-magic" onclick="window.showSalesReportModal()" title="تقارير المبيعات"><i class="fas fa-chart-line"></i></button>
    </div>


    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import {
             getFirestore, enableIndexedDbPersistence, collection, query, orderBy, onSnapshot,
             getDocs, limit, where, addDoc, updateDoc, deleteDoc, doc,
             serverTimestamp, Timestamp, getDoc, writeBatch, runTransaction
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

        // --- Firebase Configuration ---
         const firebaseConfig = { /* --- PASTE YOUR CONFIG HERE --- */
             apiKey: "AIzaSyABUQJfis7wbSn508w1RuGCd6ZsoxMoEEAAIzaSyABUQJfis7wbSn508w1RuGCd6ZsoxMoEEA", // Replace with your actual config
             authDomain: "storedatabase-642e0.firebaseapp.com",
             projectId: "storedatabase-642e0",
             storageBucket: "storedatabase-642e0.appspot.com",
             messagingSenderId: "806751758744",
             appId: "1:806751758744:web:079104a8fe4e73cdc023ed",
             measurementId: "G-778H49MMJK"
        };

        // --- Global Variables & State ---
        let app; let db;
        let unsubscribeItems = null;
        let itemsMap = new Map();
        let currentEditItemId = null; let currentViewItemId = null;
        let isDefinitelyOffline = !navigator.onLine;
        let latestSnapshotMetadata = { fromCache: true, hasPendingWrites: false };
        let firstLoadComplete = false;
        const defaultIcon = 'https://img.icons8.com/fluency/48/000000/hanger.png';
        const HISTORY_LIMIT = 15;
        const SALES_LOG_LIMIT = 150;
        const CLEAR_LOG_PASSWORD = "0750";

        // --- Keyword to Icon Mapping ---
        const keywordIconMap = { /* ... your existing mapping ... */
            'قميص': 'https://img.icons8.com/fluency/48/000000/shirt.png','تيشيرت': 'https://img.icons8.com/fluency/48/000000/t-shirt.png','تي شيرت': 'https://img.icons8.com/fluency/48/000000/t-shirt.png','بولو': 'https://img.icons8.com/fluency/48/000000/polo-shirt.png','بنطلون': 'https://img.icons8.com/fluency/48/000000/pantaloon.png','جينز': 'https://img.icons8.com/fluency/48/000000/jeans.png','سروال': 'https://img.icons8.com/fluency/48/000000/pantaloon.png','شورت': 'https://img.icons8.com/fluency/48/000000/shorts.png','برمودا': 'https://img.icons8.com/fluency/48/000000/bermuda-shorts.png','فستان': 'https://img.icons8.com/fluency/48/000000/dress.png','تنورة': 'https://img.icons8.com/fluency/48/000000/skirt.png','جيبة': 'https://img.icons8.com/fluency/48/000000/skirt.png','جاكيت': 'https://img.icons8.com/fluency/48/000000/jacket.png','سترة': 'https://img.icons8.com/fluency/48/000000/vest.png','معطف': 'https://img.icons8.com/fluency/48/000000/coat.png','بليزر': 'https://img.icons8.com/fluency/48/000000/blazer.png','هودي': 'https://img.icons8.com/fluency/48/000000/hoodie.png','كنزة': 'https://img.icons8.com/fluency/48/000000/sweater.png','بلوفر': 'https://img.icons8.com/fluency/48/000000/sweater.png','حذاء': 'https://img.icons8.com/fluency/48/000000/trainers.png','احذية': 'https://img.icons8.com/fluency/48/000000/trainers.png','رياضي': 'https://img.icons8.com/fluency/48/000000/sneakers.png','جزمة': 'https://img.icons8.com/fluency/48/000000/boot.png','كعب': 'https://img.icons8.com/fluency/48/000000/high-heels.png','صندل': 'https://img.icons8.com/fluency/48/000000/sandal.png','شبشب': 'https://img.icons8.com/fluency/48/000000/slippers.png','ملابس داخلية': 'https://img.icons8.com/fluency/48/000000/underwear.png','داخلي': 'https://img.icons8.com/fluency/48/000000/underwear.png','بدي': 'https://img.icons8.com/fluency/48/000000/bodysuit.png','بيجامة': 'https://img.icons8.com/fluency/48/000000/pajamas.png','قبعة': 'https://img.icons8.com/fluency/48/000000/baseball-cap.png','طاقية': 'https://img.icons8.com/fluency/48/000000/winter-hat.png','كاب': 'https://img.icons8.com/fluency/48/000000/baseball-cap.png','وشاح': 'https://img.icons8.com/fluency/48/000000/scarf.png','شال': 'https://img.icons8.com/fluency/48/000000/scarf.png','قفاز': 'https://img.icons8.com/fluency/48/000000/gloves.png','كفوف': 'https://img.icons8.com/fluency/48/000000/gloves.png','حزام': 'https://img.icons8.com/fluency/48/000000/belt.png','ربطة': 'https://img.icons8.com/fluency/48/000000/tie.png','حقيبة': 'https://img.icons8.com/fluency/48/000000/handbag.png','شنطة': 'https://img.icons8.com/fluency/48/000000/school-bag.png'
        };

        // --- DOM Elements ---
        const itemsListEl = document.getElementById('items-list');
        const listPlaceholderEl = document.getElementById('list-placeholder');
        const detailViewContainerEl = document.getElementById('detail-view-container');
        const mainPlaceholderEl = document.getElementById('main-placeholder');
        const footerSummaryEl = document.getElementById('footer-summary');
        const dailySalesSummarySpan = document.getElementById('daily-sales-summary');
        const debtsSummaryDiv = document.getElementById('debts-summary');
        const totalDebtsAmountSpan = document.getElementById('total-debts-amount');
        const addFormModalEl = document.getElementById('addFormModal');
        const logSaleModalEl = document.getElementById('logSaleModal');
        const editSaleModalEl = document.getElementById('editSaleModal');
        const salesReportModalEl = document.getElementById('salesReportModal');
        const salesLogModalEl = document.getElementById('salesLogModal');
        const confirmModalEl = document.getElementById('confirmModal');
        const confirmMessageEl = document.getElementById('confirmMessage');
        const confirmTitleEl = document.getElementById('confirmTitle');
        const confirmActionBtnEl = document.getElementById('confirmActionBtn');
        const toastEl = document.getElementById('toast');
        const offlineBannerEl = document.getElementById('offlineBanner');
        const connectionStatusDotEl = document.getElementById('connectionStatus');
        const addFormButton = addFormModalEl?.querySelector('#addItemBtn');
        const saleItemsListContainer = document.getElementById('sale-items-list');
        const salesReportArea = document.getElementById('salesReportArea');
        const salesLogTableBody = salesLogModalEl?.querySelector('#salesLogTable tbody');
        const clearLogBtn = document.getElementById('clear-log-btn');
        const salesLogCloseBtn = salesLogModalEl?.querySelector('.modal-footer .btn-cancel');
        const salesLogModalCloseIconBtn = salesLogModalEl?.querySelector('.close-btn');
        const updateSaleBtn = document.getElementById('updateSaleBtn');

        // --- Helper Functions ---
        function formatCurrency(amount) {
            const num = parseFloat(amount);
            if (isNaN(num)) { return 'غير محدد'; }
            return num.toLocaleString('ar-IQ', { style: 'currency', currency: 'IQD', minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }
        function formatFirestoreTimestamp(timestamp, includeTime = true) {
             if (!timestamp) return '-'; try { let date; if (timestamp.toDate && typeof timestamp.toDate === 'function') { date = timestamp.toDate(); } else if (timestamp instanceof Date) { date = timestamp; } else { date = new Date(timestamp); } if (isNaN(date.getTime())) return 'تاريخ غير صالح'; const options = { day: '2-digit', month: '2-digit', year: 'numeric' }; if (includeTime) { options.hour = '2-digit'; options.minute = '2-digit'; options.hour12 = true; } return date.toLocaleString('ar-IQ', options); } catch(e) { console.warn("Timestamp formatting error:", e, "Input:", timestamp); return 'تاريخ غير صالح'; }
        }
        function getIconForName(name) { /* Unchanged */
             if (!name) return defaultIcon; const lowerCaseName = name.toLowerCase(); const keywords = Object.keys(keywordIconMap).sort((a, b) => b.length - a.length); for (const keyword of keywords) { if (lowerCaseName.includes(keyword.toLowerCase())) { return keywordIconMap[keyword]; } } return defaultIcon;
         }
        function updateConnectionStatusUI(online) { /* Unchanged */
              isDefinitelyOffline = !online; offlineBannerEl.classList.toggle('show', !online); connectionStatusDotEl.className = 'connection-status-dot'; if (!online) { connectionStatusDotEl.classList.add('disconnected'); connectionStatusDotEl.title = 'غير متصل'; } else { if (latestSnapshotMetadata.hasPendingWrites) { connectionStatusDotEl.classList.add('syncing'); connectionStatusDotEl.title = 'متصل (مزامنة...)'; } else { connectionStatusDotEl.classList.add('connected'); connectionStatusDotEl.title = 'متصل'; } }
         }
        function updateMainViewStatus(message, isError = false) { /* Unchanged */
              if (!detailViewContainerEl) return; if (isError) { detailViewContainerEl.innerHTML = `<div class="detail-error"><strong>❌ خطأ:</strong> ${message}</div>`; } else { if (!currentViewItemId && !currentEditItemId) { detailViewContainerEl.innerHTML = `<div class="detail-placeholder">${message}</div>`; } }
         }
        function generateUniqueId() { /* Unchanged */ return Date.now().toString(36) + Math.random().toString(36).substring(2); }

        // --- Core Functions (Product/Inventory Side) ---
        function renderItemCard(itemData) { /* Unchanged */
             const existingCard = itemsListEl?.querySelector(`.item-card[data-id="${itemData.id}"]`);
             const displayIcon = itemData.icon || getIconForName(itemData.name) || defaultIcon;
             const cardHTML = ` <img class="item-icon" src="${displayIcon}" alt="${itemData.name}" loading="lazy" onerror="this.onerror=null; this.src='${defaultIcon}'"> <div class="item-details"> <h4>${itemData.name}</h4> <p>السعر: ${formatCurrency(itemData.price)}</p> </div> <div class="item-actions"> <button class="edit-btn" onclick="event.stopPropagation(); window.showEditForm('${itemData.id}')" title="تعديل"><i class="fas fa-edit"></i></button> <button class="delete-btn" onclick="event.stopPropagation(); window.showConfirmModal('${itemData.id}', 'product')" title="حذف المنتج"><i class="fas fa-trash-alt"></i></button> </div> `;
             if (existingCard) { existingCard.innerHTML = cardHTML; existingCard.classList.toggle('selected', itemData.id === currentViewItemId || itemData.id === currentEditItemId); existingCard.classList.toggle('has-pending-writes', latestSnapshotMetadata.hasPendingWrites && !latestSnapshotMetadata.fromCache); }
             else if (itemsListEl) { const card = document.createElement('div'); card.className = 'item-card'; card.setAttribute('data-id', itemData.id); card.innerHTML = cardHTML; card.classList.toggle('selected', itemData.id === currentViewItemId || itemData.id === currentEditItemId); card.classList.toggle('has-pending-writes', latestSnapshotMetadata.hasPendingWrites && !latestSnapshotMetadata.fromCache); card.addEventListener('click', () => showItemDetails(itemData.id)); let inserted = false; const cards = itemsListEl.querySelectorAll('.item-card'); const newItemNameLower = itemData.name.toLowerCase(); for (let i = 0; i < cards.length; i++) { const currentCardId = cards[i].getAttribute('data-id'); const currentCardData = itemsMap.get(currentCardId); const currentCardNameLower = currentCardData?.name?.toLowerCase() ?? ''; if (newItemNameLower.localeCompare(currentCardNameLower, 'ar') < 0) { itemsListEl.insertBefore(card, cards[i]); inserted = true; break; } } if (!inserted) { itemsListEl.appendChild(card); } }
             if (listPlaceholderEl) { listPlaceholderEl.style.display = itemsMap.size > 0 ? 'none' : (firstLoadComplete ? 'block' : 'none'); if (firstLoadComplete && itemsMap.size === 0) { listPlaceholderEl.textContent = "➕ لا توجد منتجات. انقر على زر (+) للإضافة."; } }
        }
        function removeItemCard(itemId) { /* Unchanged */
             const cardToRemove = itemsListEl?.querySelector(`.item-card[data-id="${itemId}"]`); if (cardToRemove) { cardToRemove.remove(); }
             if (listPlaceholderEl) { listPlaceholderEl.style.display = itemsMap.size > 0 ? 'none' : 'block'; if (itemsMap.size === 0) listPlaceholderEl.textContent = "➕ لا توجد منتجات. انقر على زر (+) للإضافة."; }
        }
        async function showItemDetails(itemId) { /* Improved history display */
             if (!db) { showNotification("الخدمة غير جاهزة.", true); return; }
             const item = itemsMap.get(itemId); if (!item) { updateMainViewStatus(`لم يتم العثور على المنتج (ID: ${itemId}).`, true); currentViewItemId = null; return; } if (currentViewItemId === itemId && !currentEditItemId) { return; }
             currentEditItemId = null; currentViewItemId = itemId; itemsListEl?.querySelectorAll('.item-card').forEach(card => { card.classList.toggle('selected', card.getAttribute('data-id') === itemId); });
             const createdAtFormatted = formatFirestoreTimestamp(item.createdAt); const updatedAtFormatted = formatFirestoreTimestamp(item.updatedAt); const displayIcon = item.icon || getIconForName(item.name) || defaultIcon;
             const historyCollectionRef = collection(db, 'clothes', itemId, 'history'); const qHistory = query(historyCollectionRef, orderBy('timestamp', 'desc'), limit(HISTORY_LIMIT)); let historyHtml = '';
             try {
                  const historySnapshot = await getDocs(qHistory);
                  if (historySnapshot.empty) { historyHtml = '<li class="no-history"><em>لا يوجد سجل تعديلات لهذا المنتج.</em></li>'; }
                  else { historySnapshot.docs.forEach(doc => { const d = doc.data(); const ts = formatFirestoreTimestamp(d.timestamp); let c = []; if (d.changes?.name) c.push(`<span class="change-detail">الاسم: <del>${d.changes.name.old}</del> ← ${d.changes.name.new}</span>`); if (d.changes?.price !== undefined) c.push(`<span class="change-detail">السعر: <del>${formatCurrency(d.changes.price.old ?? 0)}</del> ← ${formatCurrency(d.changes.price.new ?? 0)}</span>`); if (d.changes?.icon) c.push(`<span class="change-detail">تحديث رابط الأيقونة.</span>`); if (c.length > 0) { historyHtml += `<li><span class="history-timestamp">${ts}</span>${c.join('')}</li>`; } else { historyHtml += `<li><span class="history-timestamp">${ts}</span><span class="change-detail"><em>تحديث.</em></span></li>`; } }); if (historySnapshot.docs.length >= HISTORY_LIMIT) { historyHtml += `<li class="no-history"><em>(أحدث ${HISTORY_LIMIT})</em></li>`; } }
             } catch (error) { console.error("History fetch error:", error); historyHtml = '<li class="no-history" style="color: var(--danger);"><em>خطأ جلب السجل.</em></li>'; }
             if (detailViewContainerEl) { detailViewContainerEl.innerHTML = ` <div class="detail-content"> <img src="${displayIcon}" alt="${item.name}" class="detail-icon" onerror="this.onerror=null; this.src='${defaultIcon}'"> <h2>${item.name}</h2> <p><strong>سعر البيع:</strong> <span style="font-weight:700;">${formatCurrency(item.price)}</span></p> <div class="history-section"><h4>سجل تعديلات المنتج</h4><ul>${historyHtml}</ul></div> <div class="timestamp">أنشئ: ${createdAtFormatted} | تعدل: ${updatedAtFormatted || '-'}</div> <div class="form-buttons"><button class="btn-save" onclick="window.showEditForm('${item.id}')"><i class="fas fa-edit"></i> تعديل المنتج</button></div> <p style="font-size:0.8em;opacity:0.6;text-align:center;margin-top:15px;">ID: ${item.id}</p> </div>`; }
         }
        function showEditForm(itemId) { /* Unchanged */
             const item = itemsMap.get(itemId); if (!item) { showNotification("المنتج غير موجود للتعديل.", true); return; }
             currentViewItemId = null; currentEditItemId = itemId;
             itemsListEl?.querySelectorAll('.item-card').forEach(card => card.classList.toggle('selected', card.getAttribute('data-id') === itemId));
             const currentIcon = item.icon || '';
             if (detailViewContainerEl) { detailViewContainerEl.innerHTML = ` <div class="edit-form-container"> <h3><i class="fas fa-edit"></i> تعديل المنتج</h3> <input type="hidden" id="editItemId" value="${item.id}"> <label for="editItemName">الاسم:</label> <input type="text" id="editItemName" value="${item.name}" required> <label for="editItemPrice">سعر البيع:</label> <input type="number" id="editItemPrice" value="${item.price}" required min="0" step="any"> <label for="editItemIcon">رابط الأيقونة:</label> <input type="url" id="editItemIcon" value="${currentIcon}" placeholder="اتركه فارغاً للأيقونة الافتراضية"> <div class="form-buttons"> <button id="updateItemBtn" class="btn-save" onclick="window.updateItem()"><i class="fas fa-save"></i> حفظ</button> <button class="btn-cancel" onclick="window.cancelEdit()">إلغاء</button> </div> </div>`; }
         }
        function cancelEdit() { /* Unchanged */
             const previousEditId = currentEditItemId; currentEditItemId = null; const card = itemsListEl?.querySelector(`.item-card[data-id="${previousEditId}"]`); if (card) card.classList.remove('selected'); const itemExists = itemsMap.has(previousEditId); if (previousEditId && itemExists) { showItemDetails(previousEditId); } else { updateMainViewStatus("تم إلغاء التعديل."); currentViewItemId = null; }
         }

        // --- Product/Inventory Firestore Operations ---
        async function addItem() { /* Unchanged */
             if (!db || !addFormButton || !addFormModalEl) { showNotification('الخدمة غير جاهزة أو النموذج غير موجود.', true); return; }
             const nameInput = addFormModalEl.querySelector('#itemName'); const priceInput = addFormModalEl.querySelector('#itemPrice'); const iconUrlInput = addFormModalEl.querySelector('#itemIconUrl');
             const name = nameInput.value.trim(); const price = parseFloat(priceInput.value); const iconUrl = iconUrlInput.value.trim();
             if (!name || isNaN(price) || price < 0) { showNotification('يرجى إدخال الاسم والسعر بشكل صحيح!', true); return; }
             addFormButton.disabled = true; addFormButton.innerHTML = '<span class="icon"><i class="fas fa-spinner fa-spin"></i></span> جارٍ الإضافة...';
             let finalIconUrl = iconUrl ? iconUrl : getIconForName(name); finalIconUrl = finalIconUrl || defaultIcon;
             const newItemData = { name, price, icon: finalIconUrl, createdAt: serverTimestamp(), updatedAt: null };
             try { await addDoc(collection(db, 'clothes'), newItemData); showNotification('✅ تم إضافة المنتج!', false, 'success'); hideAddForm(); nameInput.value = ''; priceInput.value = ''; iconUrlInput.value = ''; }
             catch (error) { showNotification(`خطأ الإضافة: ${error.message}`, true); console.error("Add item error: ", error); }
             finally { if (addFormButton) { addFormButton.disabled = false; addFormButton.innerHTML = '<i class="fas fa-plus"></i> إضافة المنتج'; }}
          }
        async function updateItem() { /* Unchanged */
             if (!db || !detailViewContainerEl) { showNotification('الخدمة غير جاهزة.', true); return; }
             const updateButton = detailViewContainerEl.querySelector('#updateItemBtn'); const itemIdInput = detailViewContainerEl.querySelector('#editItemId'); const nameInput = detailViewContainerEl.querySelector('#editItemName'); const priceInput = detailViewContainerEl.querySelector('#editItemPrice'); const iconInput = detailViewContainerEl.querySelector('#editItemIcon');
             if (!updateButton || !itemIdInput || !nameInput || !priceInput || !iconInput) { showNotification('خطأ: لم يتم العثور على حقول النموذج.', true); return; }
             if (updateButton) { updateButton.disabled = true; updateButton.innerHTML = '<span class="icon"><i class="fas fa-spinner fa-spin"></i></span> جارٍ الحفظ...'; }
             const itemId = itemIdInput.value; const name = nameInput.value.trim(); const price = parseFloat(priceInput.value); let newIconUrl = iconInput.value.trim();
             if (!itemId || !name || isNaN(price) || price < 0) { showNotification('يرجى ملء الاسم والسعر بشكل صحيح!', true); if(updateButton) { updateButton.disabled = false; updateButton.innerHTML = '<i class="fas fa-save"></i> حفظ';} return; }
             const itemRef = doc(db, 'clothes', itemId); const historyRef = collection(db, 'clothes', itemId, 'history'); let iconChanged = false;
             try { const currentDocSnap = await getDoc(itemRef); if (!currentDocSnap.exists()) { throw new Error("المستند غير موجود!"); } const currentData = currentDocSnap.data(); const currentIcon = currentData.icon || defaultIcon; if (newIconUrl === '') { const autoIcon = getIconForName(name); if (currentIcon !== autoIcon && currentIcon !== defaultIcon) { newIconUrl = autoIcon; } else { newIconUrl = currentIcon; } } newIconUrl = newIconUrl || defaultIcon; iconChanged = newIconUrl !== currentIcon; const updatedData = { name, price, icon: newIconUrl, updatedAt: serverTimestamp() }; const logEntry = { timestamp: serverTimestamp(), changes: {} }; let hasChanges = false; if (currentData.name !== name) { logEntry.changes.name = { old: currentData.name, new: name }; hasChanges = true; } if (Math.abs((currentData.price || 0) - price) > 0.001) { logEntry.changes.price = { old: currentData.price, new: price }; hasChanges = true; } if (iconChanged) { logEntry.changes.icon = { old: currentData.icon, new: newIconUrl }; hasChanges = true; } if (hasChanges) { const batch = writeBatch(db); batch.update(itemRef, updatedData); batch.set(doc(historyRef), logEntry); await batch.commit(); showNotification('✅ تم التحديث بنجاح!', false, 'success'); } else { showNotification('لم يتم العثور على تغييرات للحفظ.', false, 'info'); } currentEditItemId = null; await showItemDetails(itemId); }
             catch (error) { showNotification(`خطأ التحديث: ${error.message}`, true); console.error("Update item error: ", error); }
             finally { if(updateButton) { updateButton.disabled = false; updateButton.innerHTML = '<i class="fas fa-save"></i> حفظ'; } }
          }
        function showConfirmModal(id, type = 'product') { /* Unchanged */
             if (!id && type !== 'clearSales') return;
             if (!confirmModalEl || !confirmTitleEl || !confirmMessageEl || !confirmActionBtnEl) { console.error("Confirm modal elements not found"); return; }
             let message = "هل أنت متأكد من الحذف؟"; let title = "<i class='fas fa-trash-alt'></i> تأكيد الحذف"; let action = () => {}; let confirmButtonText = '<i class="fas fa-check"></i> نعم، تأكيد'; let confirmButtonClass = 'btn-save'; let confirmButtonBg = 'var(--danger)';
             if (type === 'product') { const item = itemsMap.get(id); if (!item) { showNotification('المنتج غير موجود للحذف!', true); return; } const safeItemName = item.name.replace(/</g, "&lt;").replace(/>/g, "&gt;"); message = `متأكد من حذف المنتج: <strong style="color: var(--danger);">${safeItemName}</strong>؟<br><small>(لن يؤثر على المبيعات المسجلة)</small>`; action = () => deleteItem(id); }
             else if (type === 'saleEntry') { title = "<i class='fas fa-eraser'></i> تأكيد حذف السجل"; message = `هل أنت متأكد من حذف سجل البيع المحدد؟`; action = () => deleteSalesLogEntry(id); }
             else if (type === 'clearSales') { title = "<i class='fas fa-exclamation-triangle'></i> تأكيد مسح السجل"; message = `تحذير! سيتم حذف **جميع** سجلات المبيعات نهائياً.<br>لا يمكن التراجع عن هذا الإجراء. هل أنت متأكد تمامًا؟`; action = () => executeClearSalesLog(); }
             else { console.error("Unknown confirmation type:", type); return; }
             confirmTitleEl.innerHTML = title; confirmMessageEl.innerHTML = message; confirmActionBtnEl.onclick = action; confirmActionBtnEl.className = confirmButtonClass; confirmActionBtnEl.style.background = confirmButtonBg; confirmActionBtnEl.innerHTML = confirmButtonText; confirmModalEl.classList.add('show');
         }
        function hideConfirmModal() { /* Unchanged */ confirmModalEl?.classList.remove('show'); }
        async function deleteItem(itemId) { /* Unchanged */
             if (!db) { showNotification('الخدمة غير جاهزة.', true); return; } hideConfirmModal(); if (!itemId) return; showNotification(`⏳ جارٍ حذف المنتج...`, false, 'info');
             try { const historyCollectionRef = collection(db, 'clothes', itemId, 'history'); const historySnapshot = await getDocs(query(historyCollectionRef, limit(500))); if (!historySnapshot.empty) { const historyDeleteBatch = writeBatch(db); historySnapshot.docs.forEach(doc => historyDeleteBatch.delete(doc.ref)); await historyDeleteBatch.commit(); } await deleteDoc(doc(db, 'clothes', itemId)); showNotification('✅ تم حذف المنتج بنجاح.', false, 'success'); }
             catch (error) { showNotification(`خطأ الحذف: ${error.message}`, true); console.error("Delete item error: ", error); updateMainViewStatus(`فشل حذف المنتج: ${error.message}`, true); }
          }

        function generateInventoryReport() { /* Unchanged */
             if (itemsMap.size === 0) { showNotification("لا توجد منتجات حالياً لإنشاء تقرير.", true, 'warning'); return; } let reportContent = `تقرير المنتجات الحالية\nتاريخ: ${new Date().toLocaleString('ar-IQ')}\n================\n\n`; let index = 0; const sortedItems = Array.from(itemsMap.values()).sort((a, b) => a.name.localeCompare(b.name, 'ar')); sortedItems.forEach((item) => { index++; reportContent += `${index}. ${item.name} (ID: ${item.id})\n   سعر البيع: ${formatCurrency(item.price)}\n   أنشئ: ${formatFirestoreTimestamp(item.createdAt)} | آخر تعديل: ${formatFirestoreTimestamp(item.updatedAt)}\n----------------\n`; }); reportContent += `\nإجمالي عدد أنواع المنتجات: ${itemsMap.size}\n`; try { const blob = new Blob([`\uFEFF${reportContent}`], { type: 'text/plain;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `Products_List_${new Date().toISOString().slice(0,10)}.txt`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showNotification("✅ تم إنشاء تقرير المنتجات.", false, 'success'); } catch (e) { showNotification("فشل إنشاء التقرير.", true); console.error("Report error:", e); alert("فشل التنزيل. المحتوى:\n\n" + reportContent); }
         }
        function toggleDarkMode() { /* Unchanged */
              const isDarkMode = document.body.classList.toggle('dark-mode'); localStorage.setItem('darkMode', isDarkMode ? 'true' : 'false'); const themeButton = document.querySelector('.control-panel button[onclick*="toggleDarkMode"]'); if(themeButton) { themeButton.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; themeButton.title = isDarkMode ? 'الوضع الفاتح' : 'الوضع الداكن'; }
         }
        function showAddForm() { /* Unchanged */
             if (!addFormModalEl) return; addFormModalEl.classList.add('show'); const nameInput = addFormModalEl.querySelector('#itemName'); const priceInput = addFormModalEl.querySelector('#itemPrice'); const iconUrlInput = addFormModalEl.querySelector('#itemIconUrl'); if (nameInput) nameInput.value = ''; if (priceInput) priceInput.value = ''; if (iconUrlInput) iconUrlInput.value = ''; if (addFormButton) { addFormButton.disabled = false; addFormButton.innerHTML = '<i class="fas fa-plus"></i> إضافة المنتج'; }
         }
        function hideAddForm() { /* Unchanged */ addFormModalEl?.classList.remove('show'); }
        function showNotification(message, isError = false, type = 'normal') { /* Unchanged */
             if (!toastEl) return; toastEl.textContent = message; toastEl.className = 'toast'; if (isError) toastEl.classList.add('error'); else if (type === 'warning') toastEl.classList.add('warning'); else if (type === 'success') toastEl.classList.add('success'); else if (type === 'info') {} toastEl.classList.add('show'); setTimeout(() => { toastEl.classList.remove('show'); }, 3500);
         }

        // --- Sales Logging & Reporting Functions ---
        function populateProductSelect(selectElement) { /* Unchanged */
             if (!selectElement) return; const currentValue = selectElement.value; selectElement.innerHTML = '<option value="" disabled selected>-- اختر المنتج --</option>'; const sortedItems = Array.from(itemsMap.values()).sort((a, b) => a.name.localeCompare(b.name, 'ar')); sortedItems.forEach(item => { const option = document.createElement('option'); option.value = item.id; option.textContent = `${item.name}`; option.dataset.price = item.price; if (item.id === currentValue) { option.selected = true; } selectElement.appendChild(option); }); if (currentValue) { handleProductSelectionChange(selectElement); }
         }
        function handleProductSelectionChange(selectElement) { /* Unchanged */
             const selectedOption = selectElement?.options[selectElement.selectedIndex]; const entryDiv = selectElement?.closest('.sale-item-entry'); const priceInput = entryDiv?.querySelector('.sale-price-input'); if (selectedOption && priceInput && selectedOption.dataset.price) { priceInput.value = selectedOption.dataset.price; priceInput.placeholder = `السعر: ${selectedOption.dataset.price}`; } else if (priceInput) { priceInput.value = ''; priceInput.placeholder = 'سعر البيع'; }
         }
        function showLogSaleModal() { /* Unchanged */
             if (!logSaleModalEl || !saleItemsListContainer) return; logSaleModalEl.classList.add('show'); const dateInput = logSaleModalEl.querySelector('#saleDate'); const buyerNameInput = logSaleModalEl.querySelector('#saleBuyerName'); const paidRadio = logSaleModalEl.querySelector('#saleStatusPaid'); if (dateInput) dateInput.valueAsDate = new Date(); if (buyerNameInput) buyerNameInput.value = ''; if (paidRadio) paidRadio.checked = true; saleItemsListContainer.innerHTML = ` <div class="sale-item-entry"> <select class="sale-product-select" required onchange="window.handleProductSelectionChange(this)"> <option value="" disabled selected>-- اختر المنتج --</option> </select> <input type="number" class="sale-price-input" placeholder="سعر البيع" min="0" step="any" required> <input type="number" class="sale-quantity-input" placeholder="الكمية" min="1" required> <button type="button" class="remove-sale-item-btn" title="إزالة" onclick="window.removeSaleItem(this)">&times;</button> </div>`; const firstSelect = saleItemsListContainer.querySelector('.sale-product-select'); if (firstSelect) populateProductSelect(firstSelect); const saveButton = logSaleModalEl.querySelector('#saveSaleBtn'); if (saveButton) { saveButton.disabled = false; saveButton.innerHTML = '<i class="fas fa-save"></i> حفظ المبيعات'; }
         }
        function addSaleItemEntry() { /* Unchanged */
             if (!saleItemsListContainer) return; const template = saleItemsListContainer.querySelector('.sale-item-entry'); if (template) { const newEntry = template.cloneNode(true); const productSelect = newEntry.querySelector('.sale-product-select'); const quantityInput = newEntry.querySelector('.sale-quantity-input'); const priceInput = newEntry.querySelector('.sale-price-input'); if (productSelect) productSelect.value = ''; if (quantityInput) quantityInput.value = ''; if (priceInput) { priceInput.value = ''; priceInput.placeholder = 'سعر البيع'; } if (productSelect) populateProductSelect(productSelect); saleItemsListContainer.appendChild(newEntry); }
         }
        function removeSaleItem(button) { /* Unchanged */
             const entry = button?.closest('.sale-item-entry'); if (entry && saleItemsListContainer && saleItemsListContainer.querySelectorAll('.sale-item-entry').length > 1) { entry.remove(); } else { showNotification('يجب أن يكون هناك بند واحد على الأقل.', true, 'warning'); }
         }
        function hideLogSaleModal() { /* Unchanged */ if(logSaleModalEl) {logSaleModalEl.classList.remove('show'); if(saleItemsListContainer) saleItemsListContainer.innerHTML = '';} }

        async function saveSales() { /* Unchanged */
             if (!db || !logSaleModalEl || !saleItemsListContainer) { showNotification("الخدمة غير جاهزة.", true); return; }
             const saleDateInput = logSaleModalEl.querySelector('#saleDate'); const buyerNameInput = logSaleModalEl.querySelector('#saleBuyerName'); const paymentStatusInput = logSaleModalEl.querySelector('input[name="salePaymentStatus"]:checked'); const saleEntries = saleItemsListContainer.querySelectorAll('.sale-item-entry'); const saveButton = logSaleModalEl.querySelector('#saveSaleBtn');
             if (!saveButton || !saleDateInput || !buyerNameInput || !paymentStatusInput) { showNotification("خطأ: عناصر النموذج مفقودة.", true); return; }
             saveButton.disabled = true; saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جارٍ الحفظ...';
             const saleDate = saleDateInput.valueAsDate; const buyerName = buyerNameInput.value.trim(); const paymentStatus = paymentStatusInput.value;
             if (!saleDate) { showNotification('يرجى تحديد تاريخ البيع!', true, 'warning'); saveButton.disabled = false; saveButton.innerHTML = '<i class="fas fa-save"></i> حفظ المبيعات'; return; }
             const now = new Date(); const saleTimestamp = new Date(saleDate.getFullYear(), saleDate.getMonth(), saleDate.getDate(), now.getHours(), now.getMinutes(), now.getSeconds());
             const batch = writeBatch(db); const salesToLog = []; let isValid = true;
             saleEntries.forEach(entry => { const productSelect = entry.querySelector('.sale-product-select'); const quantityInput = entry.querySelector('.sale-quantity-input'); const priceInput = entry.querySelector('.sale-price-input'); if (!productSelect || !quantityInput || !priceInput) { isValid = false; return; } const productId = productSelect.value; const quantitySold = parseInt(quantityInput.value); const pricePerUnitAtSale = parseFloat(priceInput.value); let entryValid = true; entry.style.border = 'none'; productSelect.style.borderColor = ''; quantityInput.style.borderColor = ''; priceInput.style.borderColor = ''; if (!productId) { entryValid = false; productSelect.style.borderColor = 'var(--danger)';} if (isNaN(quantitySold) || quantitySold <= 0) { entryValid = false; quantityInput.style.borderColor = 'var(--danger)';} if (isNaN(pricePerUnitAtSale) || pricePerUnitAtSale < 0) { entryValid = false; priceInput.style.borderColor = 'var(--danger)';} if (!entryValid) { isValid = false; entry.style.border = '1px solid var(--danger)'; } else { const productData = itemsMap.get(productId); if (productData) { salesToLog.push({ productId, productName: productData.name, quantitySold, pricePerUnitAtSale, totalSaleAmount: quantitySold * pricePerUnitAtSale, saleTimestamp: Timestamp.fromDate(saleTimestamp), buyerName: buyerName || null, paymentStatus }); } else { isValid = false; entry.style.border = '1px solid var(--danger)'; productSelect.style.borderColor = 'var(--danger)'; console.error(`Product data not found for ID: ${productId}`); } } });
             if (!isValid || salesToLog.length === 0) { showNotification('يرجى مراجعة بنود البيع والتأكد من صحة البيانات.', true); saveButton.disabled = false; saveButton.innerHTML = '<i class="fas fa-save"></i> حفظ المبيعات'; return; }
             try { salesToLog.forEach(saleData => { batch.set(doc(collection(db, 'sales')), saleData); }); await batch.commit(); showNotification(`✅ تم تسجيل ${salesToLog.length} ${salesToLog.length === 1 ? 'عملية بيع' : 'عمليات بيع'}!`, false, 'success'); hideLogSaleModal(); fetchAndDisplayDailySalesSummary(); fetchAndDisplayOutstandingDebts(); }
             catch (error) { showNotification(`خطأ حفظ المبيعات: ${error.message}`, true); console.error("Error saving sales: ", error); }
             finally { saveButton.disabled = false; saveButton.innerHTML = '<i class="fas fa-save"></i> حفظ المبيعات'; }
          }

        // --- Sales Reporting Functions ---
        function showSalesReportModal() { /* Unchanged */
             if (!salesReportModalEl) return; salesReportModalEl.classList.add('show'); const today = new Date(); const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1); const startDateInput = salesReportModalEl.querySelector('#reportStartDate'); const endDateInput = salesReportModalEl.querySelector('#reportEndDate'); const filterSelect = salesReportModalEl.querySelector('#reportPaymentStatusFilter'); if (startDateInput) startDateInput.valueAsDate = startOfMonth; if (endDateInput) endDateInput.valueAsDate = today; if (filterSelect) filterSelect.value = 'all'; if (salesReportArea) salesReportArea.innerHTML = '<p class="detail-placeholder">اختر فترة زمنية ونوع التقرير.</p>';
         }
        function hideSalesReportModal() { /* Unchanged */ salesReportModalEl?.classList.remove('show'); }
        async function generateSalesReport(reportType) { /* Unchanged */
             if (!db || !salesReportModalEl || !salesReportArea) { showNotification("الخدمة غير جاهزة.", true); return; }
             const startDateInput = salesReportModalEl.querySelector('#reportStartDate'); const endDateInput = salesReportModalEl.querySelector('#reportEndDate'); const paymentStatusFilterInput = salesReportModalEl.querySelector('#reportPaymentStatusFilter');
             if (!startDateInput || !endDateInput || !paymentStatusFilterInput) { showNotification("خطأ: عناصر التحكم بالتقرير مفقودة.", true); return; }
             const paymentStatusFilter = paymentStatusFilterInput.value; const startDate = startDateInput.valueAsDate; const endDate = endDateInput.valueAsDate; if (!startDate || !endDate || endDate < startDate) { showNotification('يرجى تحديد فترة صحيحة.', true, 'warning'); return; } const endOfDay = new Date(endDate); endOfDay.setHours(23, 59, 59, 999); salesReportArea.innerHTML = '<p class="detail-placeholder"><i class="fas fa-spinner fa-spin"></i> جارٍ تحميل التقرير...</p>';
             try { const salesRef = collection(db, 'sales'); let conditions = [ where('saleTimestamp', '>=', Timestamp.fromDate(startDate)), where('saleTimestamp', '<=', Timestamp.fromDate(endOfDay)) ]; if (paymentStatusFilter !== 'all') { conditions.push(where('paymentStatus', '==', paymentStatusFilter)); } conditions.push(orderBy('saleTimestamp', 'desc')); const q = query(salesRef, ...conditions); const salesSnapshot = await getDocs(q); if (salesSnapshot.empty) { salesReportArea.innerHTML = `<p class="detail-placeholder">لا توجد مبيعات تطابق الفلترة في هذه الفترة.</p>`; return; } let reportHtml = ''; const salesData = salesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()})); const dateRangeText = `${startDate.toLocaleDateString('ar-IQ')} - ${endDate.toLocaleDateString('ar-IQ')}`; const statusText = paymentStatusFilter === 'paid' ? ' (مدفوع فقط)' : paymentStatusFilter === 'debt' ? ' (دين فقط)' : ''; if (reportType === 'summary') { let totalValue = 0; let totalQuantity = 0; salesData.forEach(sale => { totalValue += sale.totalSaleAmount || 0; totalQuantity += sale.quantitySold || 0; }); reportHtml = `<h4>ملخص المبيعات${statusText}<br><small>(${dateRangeText})</small></h4> <div class="report-summary"> <p>إجمالي قيمة المبيعات: <span>${formatCurrency(totalValue)}</span></p> <p>إجمالي الكمية المباعة: <span>${totalQuantity.toLocaleString('ar-IQ')}</span> قطعة</p> </div> <br><h4>تفاصيل المبيعات:</h4> <table><thead><tr><th>التاريخ</th><th>المشتري</th><th>المنتج</th><th>الكمية</th><th>سعر الوحدة</th><th>الإجمالي</th><th>الحالة</th></tr></thead><tbody> ${salesData.map(s => `<tr><td>${formatFirestoreTimestamp(s.saleTimestamp)}</td><td>${s.buyerName || '-'}</td><td>${s.productName || '?'}</td><td class="number-cell">${s.quantitySold.toLocaleString('ar-IQ')}</td><td class="number-cell">${formatCurrency(s.pricePerUnitAtSale)}</td><td class="number-cell">${formatCurrency(s.totalSaleAmount)}</td><td class="sale-status ${s.paymentStatus === 'paid' ? 'sale-status-paid' : 'sale-status-debt'}">${s.paymentStatus === 'paid' ? 'مدفوع' : 'دين'}</td></tr>`).join('')} </tbody></table>`; }
             else if (reportType === 'bestSellerQty' || reportType === 'bestSellerValue') { const productSales = {}; salesData.forEach(sale => { if (!productSales[sale.productId]) productSales[sale.productId] = { name: sale.productName, qty: 0, value: 0 }; productSales[sale.productId].qty += sale.quantitySold || 0; productSales[sale.productId].value += sale.totalSaleAmount || 0; }); const sortedProducts = Object.values(productSales).sort((a, b) => (reportType === 'bestSellerQty' ? b.qty - a.qty : b.value - a.value)); reportHtml = `<h4>الأكثر مبيعاً ${reportType === 'bestSellerQty' ? '(حسب الكمية)' : '(حسب القيمة)'}${statusText}<br><small>(${dateRangeText})</small></h4> <table><thead><tr><th>المنتج</th><th>الكمية المباعة</th><th>إجمالي قيمة المبيعات</th></tr></thead><tbody> ${sortedProducts.map(p => `<tr><td>${p.name || '?'}</td><td class="number-cell">${p.qty.toLocaleString('ar-IQ')}</td><td class="number-cell">${formatCurrency(p.value)}</td></tr>`).join('')} </tbody></table>`; }
             else { reportHtml = '<p class="detail-placeholder">نوع التقرير غير معروف.</p>'; } salesReportArea.innerHTML = reportHtml; }
             catch (error) { console.error("Error generating sales report:", error); salesReportArea.innerHTML = `<p class="detail-error">خطأ إنشاء التقرير: ${error.message}</p>`; }
          }
        function exportSalesToCSV() { /* Unchanged */
             if (!db || !salesReportModalEl) { showNotification("الخدمة غير جاهزة.", true); return; }
             const startDateInput = salesReportModalEl.querySelector('#reportStartDate'); const endDateInput = salesReportModalEl.querySelector('#reportEndDate'); const paymentStatusFilterInput = salesReportModalEl.querySelector('#reportPaymentStatusFilter');
             if (!startDateInput || !endDateInput || !paymentStatusFilterInput) { showNotification("خطأ: عناصر التحكم بالتقرير مفقودة.", true); return; }
             const paymentStatusFilter = paymentStatusFilterInput.value; const startDate = startDateInput.valueAsDate; const endDate = endDateInput.valueAsDate; if (!startDate || !endDate || endDate < startDate) { showNotification('يرجى تحديد فترة صحيحة للتصدير.', true, 'warning'); return; } const endOfDay = new Date(endDate); endOfDay.setHours(23, 59, 59, 999); showNotification('⏳ تحضير التصدير...', false, 'info'); const salesRef = collection(db, 'sales'); let conditions = [ where('saleTimestamp', '>=', Timestamp.fromDate(startDate)), where('saleTimestamp', '<=', Timestamp.fromDate(endOfDay)) ]; if (paymentStatusFilter !== 'all') { conditions.push(where('paymentStatus', '==', paymentStatusFilter)); } conditions.push(orderBy('saleTimestamp', 'desc')); const q = query(salesRef, ...conditions);
             getDocs(q).then(salesSnapshot => { if (salesSnapshot.empty) { showNotification('لا توجد بيانات للتصدير تطابق الفلترة.', false, 'warning'); return; } let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; csvContent += "التاريخ,الوقت,اسم المشتري,معرف المنتج,اسم المنتج,الكمية,سعر الوحدة,الإجمالي,حالة الدفع\r\n"; salesSnapshot.docs.forEach(doc => { const sale = doc.data(); const saleDate = sale.saleTimestamp?.toDate ? sale.saleTimestamp.toDate() : new Date(); const dateStr = saleDate.toLocaleDateString('ar-IQ', { year: 'numeric', month: '2-digit', day: '2-digit' }); const timeStr = saleDate.toLocaleTimeString('ar-IQ', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }); const buyerName = `"${(sale.buyerName || '').replace(/"/g, '""')}"`; const productName = `"${(sale.productName || '').replace(/"/g, '""')}"`; const statusStr = sale.paymentStatus === 'paid' ? 'مدفوع' : 'دين'; const row = [ dateStr, timeStr, buyerName, sale.productId || '', productName, sale.quantitySold || 0, sale.pricePerUnitAtSale || 0, sale.totalSaleAmount || 0, statusStr ].join(','); csvContent += row + "\r\n"; }); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); const dateString = `${startDate.toISOString().slice(0,10)}_to_${endDate.toISOString().slice(0,10)}`; link.setAttribute("download", `sales_report_${dateString}_${paymentStatusFilter}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); showNotification('✅ تم تحضير ملف CSV.', false, 'success'); }).catch(error => { console.error("Error exporting sales:", error); showNotification(`خطأ في التصدير: ${error.message}`, true); });
         }

        // --- Sales Log Modal Functions ---
        function showSalesLogModal() { /* Unchanged */
             if (!salesLogModalEl) return; salesLogModalEl.classList.add('show'); loadSalesLog(); if (clearLogBtn) clearLogBtn.disabled = false; if (salesLogCloseBtn) salesLogCloseBtn.disabled = false; if (salesLogModalCloseIconBtn) salesLogModalCloseIconBtn.disabled = false;
         }
        function hideSalesLogModal() { /* Unchanged */
             if (salesLogModalEl) { salesLogModalEl.classList.remove('show'); if (salesLogTableBody) salesLogTableBody.innerHTML = ''; }
         }
        async function loadSalesLog() { /* Unchanged */
             if (!db || !salesLogTableBody) { console.warn("Sales log table body not found or DB not ready."); if (salesLogTableBody) { salesLogTableBody.innerHTML = '<tr><td colspan="8" class="detail-placeholder">لا توجد عمليات بيع مسجلة بعد.</td></tr>'; if (salesLogTableBody.parentElement) salesLogTableBody.parentElement.style.display = 'table'; } return; }
             salesLogTableBody.innerHTML = '<tr><td colspan="8" class="detail-placeholder"><i class="fas fa-spinner fa-spin"></i> جارٍ تحميل السجل...</td></tr>'; if (salesLogTableBody.parentElement) salesLogTableBody.parentElement.style.display = 'table';
             try { const salesRef = collection(db, 'sales'); const q = query(salesRef, orderBy('saleTimestamp', 'desc'), limit(SALES_LOG_LIMIT)); const salesSnapshot = await getDocs(q); if (salesSnapshot.empty) { salesLogTableBody.innerHTML = '<tr><td colspan="8" class="detail-placeholder">لا توجد عمليات بيع مسجلة بعد.</td></tr>'; return; } let logHtml = ''; salesSnapshot.docs.forEach(doc => { const sale = { id: doc.id, ...doc.data() }; const statusClass = sale.paymentStatus === 'paid' ? 'sale-status-paid' : 'sale-status-debt'; const statusText = sale.paymentStatus === 'paid' ? 'مدفوع' : 'دين'; logHtml += ` <tr data-sale-id="${sale.id}"> <td>${formatFirestoreTimestamp(sale.saleTimestamp)}</td> <td>${sale.buyerName || '-'}</td> <td>${sale.productName || 'غير معروف'}</td> <td class="number-cell">${sale.quantitySold?.toLocaleString('ar-IQ') ?? 0}</td> <td class="number-cell">${formatCurrency(sale.pricePerUnitAtSale || 0)}</td> <td class="number-cell">${formatCurrency(sale.totalSaleAmount || 0)}</td> <td class="sale-status ${statusClass}">${statusText}</td> <td class="log-actions"> <button class="edit-sale-log-entry" onclick="window.showEditSaleModal('${sale.id}')" title="تعديل السجل"><i class="fas fa-edit"></i></button> <button class="delete-sale-log-entry" onclick="window.confirmDeleteSalesLogEntry('${sale.id}', this)" title="حذف هذا السجل"><i class="fas fa-times-circle"></i></button> </td> </tr>`; }); salesLogTableBody.innerHTML = logHtml; if (salesSnapshot.docs.length >= SALES_LOG_LIMIT) { salesLogTableBody.insertAdjacentHTML('beforeend', `<tr><td colspan="8" style="text-align: center; font-size: 0.9em; opacity: 0.7;">(عرض أحدث ${SALES_LOG_LIMIT} سجل)</td></tr>`); } }
             catch (error) { console.error("Error loading sales log:", error); salesLogTableBody.innerHTML = `<tr><td colspan="8" class="detail-error">حدث خطأ أثناء تحميل السجل: ${error.message}</td></tr>`; }
          }

        // --- Functions to Edit Sales Log Entries ---
        async function showEditSaleModal(saleId) { /* Unchanged */
            if (!db || !saleId || !editSaleModalEl) return; const saleRef = doc(db, 'sales', saleId); const dateInput = editSaleModalEl.querySelector('#editSaleDate'); const buyerNameInput = editSaleModalEl.querySelector('#editSaleBuyerName'); const productNameInput = editSaleModalEl.querySelector('#editSaleProductName'); const quantityInput = editSaleModalEl.querySelector('#editSaleQuantity'); const priceInput = editSaleModalEl.querySelector('#editSalePrice'); const paidRadio = editSaleModalEl.querySelector('#editSaleStatusPaid'); const debtRadio = editSaleModalEl.querySelector('#editSaleStatusDebt'); const idInput = editSaleModalEl.querySelector('#editSaleId');
            if (!dateInput || !buyerNameInput || !productNameInput || !quantityInput || !priceInput || !paidRadio || !debtRadio || !idInput || !updateSaleBtn) { showNotification("خطأ: عناصر نافذة التعديل غير موجودة.", true); return; }
            try { const docSnap = await getDoc(saleRef); if (!docSnap.exists()) { showNotification("لم يتم العثور على سجل البيع هذا!", true); return; } const saleData = docSnap.data(); idInput.value = saleId; dateInput.valueAsDate = saleData.saleTimestamp?.toDate ? saleData.saleTimestamp.toDate() : null; buyerNameInput.value = saleData.buyerName || ''; productNameInput.value = saleData.productName || 'غير معروف'; quantityInput.value = saleData.quantitySold || 1; priceInput.value = saleData.pricePerUnitAtSale || 0; if (saleData.paymentStatus === 'paid') { paidRadio.checked = true; } else { debtRadio.checked = true; } updateSaleBtn.disabled = false; editSaleModalEl.classList.add('show'); }
            catch (error) { console.error("Error fetching sale data for edit:", error); showNotification("خطأ في جلب بيانات البيع للتعديل.", true); }
        }
        function hideEditSaleModal() { /* Unchanged */
            if (!editSaleModalEl) return; editSaleModalEl.classList.remove('show'); const idInput = editSaleModalEl.querySelector('#editSaleId'); const dateInput = editSaleModalEl.querySelector('#editSaleDate'); const buyerNameInput = editSaleModalEl.querySelector('#editSaleBuyerName'); const productNameInput = editSaleModalEl.querySelector('#editSaleProductName'); const quantityInput = editSaleModalEl.querySelector('#editSaleQuantity'); const priceInput = editSaleModalEl.querySelector('#editSalePrice'); const paidRadio = editSaleModalEl.querySelector('#editSaleStatusPaid'); const debtRadio = editSaleModalEl.querySelector('#editSaleStatusDebt'); if(idInput) idInput.value = ''; if(dateInput) dateInput.value = ''; if(buyerNameInput) buyerNameInput.value = ''; if(productNameInput) productNameInput.value = ''; if(quantityInput) quantityInput.value = ''; if(priceInput) priceInput.value = ''; if(paidRadio) paidRadio.checked = false; if(debtRadio) debtRadio.checked = false;
        }
        async function updateSaleEntry() { /* Added validation for quantity/price */
            if (!db || !editSaleModalEl || !updateSaleBtn) { showNotification("الخدمة غير جاهزة.", true); return; }
            const saleIdInput = editSaleModalEl.querySelector('#editSaleId'); const saleDateInput = editSaleModalEl.querySelector('#editSaleDate'); const buyerNameInput = editSaleModalEl.querySelector('#editSaleBuyerName'); const quantityInput = editSaleModalEl.querySelector('#editSaleQuantity'); const priceInput = editSaleModalEl.querySelector('#editSalePrice'); const paymentStatusInput = editSaleModalEl.querySelector('input[name="editSalePaymentStatus"]:checked');
            if (!saleIdInput || !saleDateInput || !buyerNameInput || !quantityInput || !priceInput || !paymentStatusInput) { showNotification("خطأ: حقول التعديل مفقودة.", true); return; }

            const saleId = saleIdInput.value; const saleDate = saleDateInput.valueAsDate; const buyerName = buyerNameInput.value.trim(); const quantity = parseInt(quantityInput.value); const price = parseFloat(priceInput.value); const paymentStatus = paymentStatusInput.value;

            // --- VALIDATION ADDED ---
            if (!saleId) { showNotification("خطأ: معرف السجل مفقود.", true); return; }
            if (!saleDate || isNaN(quantity) || quantity <= 0 || isNaN(price) || price < 0 || !paymentStatus) { showNotification("يرجى ملء جميع الحقول المطلوبة بشكل صحيح (الكمية والسعر يجب أن تكون أرقام صالحة).", true, 'warning'); return; }
            // --- END VALIDATION ---

            updateSaleBtn.disabled = true; updateSaleBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جارٍ الحفظ...';
            const saleRef = doc(db, 'sales', saleId);

            try { const originalDoc = await getDoc(saleRef); if (!originalDoc.exists()) throw new Error("Original sale not found"); const originalTimestamp = originalDoc.data().saleTimestamp?.toDate ? originalDoc.data().saleTimestamp.toDate() : new Date(); const newTimestamp = new Date( saleDate.getFullYear(), saleDate.getMonth(), saleDate.getDate(), originalTimestamp.getHours(), originalTimestamp.getMinutes(), originalTimestamp.getSeconds() );
                // Use validated quantity and price for calculation
                const calculatedTotal = quantity * price;
                const updatedData = { saleTimestamp: Timestamp.fromDate(newTimestamp), buyerName: buyerName || null, quantitySold: quantity, pricePerUnitAtSale: price, totalSaleAmount: calculatedTotal, paymentStatus: paymentStatus, };
                await updateDoc(saleRef, updatedData);
                showNotification("✅ تم تحديث سجل البيع بنجاح!", false, 'success'); hideEditSaleModal(); loadSalesLog(); fetchAndDisplayDailySalesSummary(); fetchAndDisplayOutstandingDebts();
            } catch (error) { console.error("Error updating sale entry:", error); showNotification(`❌ فشل تحديث السجل: ${error.message}`, true);
            } finally { if(updateSaleBtn) { updateSaleBtn.disabled = false; updateSaleBtn.innerHTML = '<i class="fas fa-save"></i> حفظ التعديلات'; } }
        }

        // --- Functions to Delete Sales Log Entries ---
        function confirmDeleteSalesLogEntry(saleId, buttonElement) { /* Unchanged */
             if (!saleId || !buttonElement) return; showConfirmModal(saleId, 'saleEntry');
         }
        async function deleteSalesLogEntry(saleId) { /* Unchanged */
             if (!db || !saleId) return; hideConfirmModal(); showNotification('⏳ جارٍ حذف السجل...', false, 'info'); const buttonToDelete = salesLogTableBody?.querySelector(`tr[data-sale-id="${saleId}"] .delete-sale-log-entry`); if (buttonToDelete) buttonToDelete.disabled = true;
             try { await deleteDoc(doc(db, 'sales', saleId)); showNotification('✅ تم حذف سجل البيع.', false, 'success'); const rowToRemove = salesLogTableBody?.querySelector(`tr[data-sale-id="${saleId}"]`); if (rowToRemove) { rowToRemove.style.transition = 'opacity 0.3s ease-out'; rowToRemove.style.opacity = '0'; setTimeout(() => { rowToRemove.remove(); if (salesLogTableBody && salesLogTableBody.rows.length === 0) { loadSalesLog(); } }, 300); } else { loadSalesLog(); } fetchAndDisplayDailySalesSummary(); fetchAndDisplayOutstandingDebts(); }
             catch (error) { console.error(`Error deleting sale log entry ${saleId}:`, error); showNotification(`❌ فشل حذف السجل: ${error.message}`, true); if (buttonToDelete) buttonToDelete.disabled = false; }
          }

        // --- Functions to Clear Entire Sales Log ---
        function confirmClearSalesLog() { /* Unchanged */
             if (!clearLogBtn || clearLogBtn.disabled) return; const password = prompt(`للتأكيد، الرجاء إدخال كلمة السر (${CLEAR_LOG_PASSWORD}) لمسح السجل بالكامل:`); if (password === null) return; if (password !== CLEAR_LOG_PASSWORD) { showNotification("كلمة السر غير صحيحة!", true); return; } showConfirmModal(null, 'clearSales');
         }
        async function executeClearSalesLog() { /* Unchanged */
              if (!db) { showNotification("الخدمة غير جاهزة.", true); return; } hideConfirmModal(); if (clearLogBtn) clearLogBtn.disabled = true; if (salesLogCloseBtn) salesLogCloseBtn.disabled = true; if (salesLogModalCloseIconBtn) salesLogModalCloseIconBtn.disabled = true; showNotification("⏳⏳ جارٍ مسح جميع سجلات المبيعات...", false, 'warning'); const MAX_WRITES_PER_BATCH = 450; const salesRef = collection(db, 'sales'); let deleteCounter = 0;
              try { const querySnapshot = await getDocs(query(salesRef, limit(10000))); if (querySnapshot.empty) { showNotification("السجل فارغ بالفعل.", false, 'info'); loadSalesLog(); return; } let batch = writeBatch(db); let batchCount = 0; const totalDocs = querySnapshot.size; for (let i = 0; i < totalDocs; i++) { const docSnap = querySnapshot.docs[i]; batch.delete(docSnap.ref); batchCount++; deleteCounter++; if (batchCount >= MAX_WRITES_PER_BATCH || i === totalDocs - 1) { showNotification(`⏳ جارٍ مسح الدفعة ${Math.ceil(deleteCounter / MAX_WRITES_PER_BATCH)} من ${Math.ceil(totalDocs / MAX_WRITES_PER_BATCH)}...`, false, 'info'); await batch.commit(); batch = writeBatch(db); batchCount = 0; } } showNotification(`✅ تم مسح جميع سجلات المبيعات (${deleteCounter} سجلات).`, false, 'success'); loadSalesLog(); fetchAndDisplayDailySalesSummary(); fetchAndDisplayOutstandingDebts(); }
              catch (error) { console.error("Error clearing sales log:", error); showNotification(`❌ فشل مسح السجل: ${error.message}`, true); }
              finally { if (clearLogBtn) clearLogBtn.disabled = false; if (salesLogCloseBtn) salesLogCloseBtn.disabled = false; if (salesLogModalCloseIconBtn) salesLogModalCloseIconBtn.disabled = false; }
         }


        // --- Summary Functions (Daily Sales & Debts) ---
        async function fetchAndDisplayDailySalesSummary() { /* Made more robust */
              if (!db || !dailySalesSummarySpan || !footerSummaryEl) {
                  console.warn("Daily summary elements or DB not ready.");
                  if (dailySalesSummarySpan) dailySalesSummarySpan.innerHTML = `<span style="color: var(--danger);">خطأ</span>`;
                  if (footerSummaryEl) footerSummaryEl.style.display = 'block';
                  return;
              }
              dailySalesSummarySpan.innerHTML = `<span style="opacity:0.6;">جار التحميل...</span>`;
              const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
              const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999);
              const salesRef = collection(db, 'sales');
              const q = query(salesRef, where('saleTimestamp', '>=', Timestamp.fromDate(todayStart)), where('saleTimestamp', '<=', Timestamp.fromDate(todayEnd)), where('paymentStatus', '==', 'paid'));
              try {
                   const snapshot = await getDocs(q); let dailyTotal = 0;
                   snapshot.forEach(doc => {
                       // --- ROBUSTNESS CHECK ---
                       const amount = parseFloat(doc.data().totalSaleAmount); // Attempt to parse
                       if (!isNaN(amount)) { // Only add if it's a valid number
                           dailyTotal += amount;
                       } else {
                           console.warn(`Invalid totalSaleAmount found in daily summary for doc ${doc.id}:`, doc.data().totalSaleAmount);
                       }
                       // --- END ROBUSTNESS CHECK ---
                   });
                   dailySalesSummarySpan.innerHTML = `${formatCurrency(dailyTotal)}`;
                   footerSummaryEl.style.display = 'block';
              } catch (error) {
                  console.error("Error fetching daily summary:", error);
                  dailySalesSummarySpan.innerHTML = `<span style="color: var(--danger);">خطأ</span>`; // Show error in span
                  footerSummaryEl.style.display = 'block'; // Ensure parent is visible
              }
           }
        async function fetchAndDisplayOutstandingDebts() { /* Made more robust */
            if (!db || !totalDebtsAmountSpan || !debtsSummaryDiv) {
                console.warn("Debts summary elements or DB not ready.");
                if (totalDebtsAmountSpan) totalDebtsAmountSpan.innerHTML = `<span style="color: var(--danger);">خطأ</span>`;
                if (debtsSummaryDiv) debtsSummaryDiv.style.display = 'block';
                return;
            }
            totalDebtsAmountSpan.innerHTML = `<span style="opacity:0.6;">جار التحميل...</span>`;
            const salesRef = collection(db, 'sales');
            const q = query(salesRef, where('paymentStatus', '==', 'debt'));
            try {
                const snapshot = await getDocs(q); let totalDebt = 0;
                snapshot.forEach(doc => {
                    // --- ROBUSTNESS CHECK ---
                    const amount = parseFloat(doc.data().totalSaleAmount);
                    if (!isNaN(amount)) {
                        totalDebt += amount;
                    } else {
                        console.warn(`Invalid totalSaleAmount found in debts summary for doc ${doc.id}:`, doc.data().totalSaleAmount);
                    }
                    // --- END ROBUSTNESS CHECK ---
                });
                if (totalDebt > 0) {
                    totalDebtsAmountSpan.innerHTML = `${formatCurrency(totalDebt)}`;
                    debtsSummaryDiv.style.display = 'block';
                } else { debtsSummaryDiv.style.display = 'none'; }
            } catch (error) {
                console.error("Error fetching outstanding debts:", error);
                totalDebtsAmountSpan.innerHTML = `<span style="color: var(--danger);">خطأ</span>`;
                debtsSummaryDiv.style.display = 'block';
            }
        }


        // --- Initialization ---
        async function initializeAppAndFirestore() { /* Unchanged */
             console.log("Initializing app (v10.2)..."); updateMainViewStatus("🔄 تهيئة..."); listPlaceholderEl.textContent = "جارٍ التحميل..."; listPlaceholderEl.style.display = 'block'; connectionStatusDotEl.className = 'connection-status-dot connecting'; updateConnectionStatusUI(navigator.onLine);
             try { app = initializeApp(firebaseConfig); db = getFirestore(app); try { await enableIndexedDbPersistence(db); console.log("Persistence OK."); } catch (err) { if (err.code === 'failed-precondition') { console.warn("Persistence failed (multi-tabs?)."); showNotification("⚠️ لم يتم تمكين التخزين المحلي.", false, 'warning'); } else if (err.code === 'unimplemented') { console.warn("Persistence not supported."); showNotification("⚠️ التخزين المحلي غير مدعوم.", false, 'warning'); } else { console.error("Persistence error:", err); showNotification("⚠️ خطأ في التخزين المحلي.", true); } } const isDarkMode = localStorage.getItem('darkMode') === 'true'; if (isDarkMode) document.body.classList.add('dark-mode'); const themeButton = document.querySelector('.control-panel button[onclick*="toggleDarkMode"]'); if(themeButton) { themeButton.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; themeButton.title = isDarkMode ? 'الوضع الفاتح' : 'الوضع الداكن'; } updateMainViewStatus("🔄 جلب بيانات المنتجات...");
                  if (db && !unsubscribeItems) { const itemsCollection = collection(db, 'clothes'); const q = query(itemsCollection, orderBy('name', 'asc')); unsubscribeItems = onSnapshot(q, (snapshot) => { latestSnapshotMetadata = snapshot.metadata; updateConnectionStatusUI(navigator.onLine); let needsDetailsRefresh = false; let refreshId = null; snapshot.docChanges().forEach((change) => { const docData = change.doc.data({ serverTimestamps: "estimate" }); const itemData = { id: change.doc.id, ...docData }; if (change.type === "added" || change.type === "modified") { itemsMap.set(itemData.id, itemData); renderItemCard(itemData); if ((currentViewItemId === itemData.id || currentEditItemId === itemData.id) && change.type === "modified") { needsDetailsRefresh = true; refreshId = itemData.id; } } if (change.type === "removed") { const removedItemId = change.doc.id; itemsMap.delete(removedItemId); removeItemCard(removedItemId); if (currentViewItemId === removedItemId) { currentViewItemId = null; updateMainViewStatus("🗑️ تم حذف المنتج المعروض."); } if (currentEditItemId === removedItemId) { currentEditItemId = null; updateMainViewStatus("🗑️ تم حذف المنتج قيد التعديل."); } } }); if (needsDetailsRefresh && refreshId && !currentEditItemId) { showItemDetails(refreshId); } if (!firstLoadComplete) { firstLoadComplete = true; console.log("Initial item sync complete."); if (listPlaceholderEl) listPlaceholderEl.style.display = itemsMap.size > 0 ? 'none' : 'block'; if (itemsMap.size === 0 && listPlaceholderEl) listPlaceholderEl.textContent = "➕ لا توجد منتجات. انقر على زر (+) للإضافة."; if (!currentViewItemId && !currentEditItemId) updateMainViewStatus(itemsMap.size > 0 ? "👈 اختر منتجاً لعرض التفاصيل أو التعديل." : "➕ لا توجد منتجات حالياً. ابدأ بإضافة منتج جديد."); fetchAndDisplayDailySalesSummary(); fetchAndDisplayOutstandingDebts(); } }, (error) => { console.error("❌ Items Listener error:", error); showNotification("خطأ استقبال تحديثات المنتجات.", true); updateMainViewStatus(`فشل الاتصال بقاعدة البيانات: ${error.message}.`, true); updateConnectionStatusUI(false); firstLoadComplete = true; if(listPlaceholderEl) { listPlaceholderEl.textContent = "❌ خطأ تحميل القائمة"; listPlaceholderEl.style.display = 'block'; }}); }
                   else { throw new Error("DB not available or listener already attached."); }
                   window.addEventListener('online', () => updateConnectionStatusUI(true)); window.addEventListener('offline', () => updateConnectionStatusUI(false));
                   // Expose functions
                   window.addItem = addItem; window.updateItem = updateItem; window.deleteItem = deleteItem; window.showItemDetails = showItemDetails; window.showEditForm = showEditForm; window.cancelEdit = cancelEdit; window.showConfirmModal = showConfirmModal; window.hideConfirmModal = hideConfirmModal; window.generateInventoryReport = generateInventoryReport; window.toggleDarkMode = toggleDarkMode; window.showAddForm = showAddForm; window.hideAddForm = hideAddForm; window.showLogSaleModal = showLogSaleModal; window.hideLogSaleModal = hideLogSaleModal; window.addSaleItemEntry = addSaleItemEntry; window.removeSaleItem = removeSaleItem; window.saveSales = saveSales; window.showSalesReportModal = showSalesReportModal; window.hideSalesReportModal = hideSalesReportModal; window.generateSalesReport = generateSalesReport; window.exportSalesToCSV = exportSalesToCSV; window.showSalesLogModal = showSalesLogModal; window.hideSalesLogModal = hideSalesLogModal; window.confirmDeleteSalesLogEntry = confirmDeleteSalesLogEntry; window.deleteSalesLogEntry = deleteSalesLogEntry; window.confirmClearSalesLog = confirmClearSalesLog; window.executeClearSalesLog = executeClearSalesLog; window.handleProductSelectionChange = handleProductSelectionChange; window.showEditSaleModal = showEditSaleModal; window.hideEditSaleModal = hideEditSaleModal; window.updateSaleEntry = updateSaleEntry;
                   console.log("✅ Init success.");
             } catch (initError) { console.error("❌ Init Failed:", initError); updateMainViewStatus(`فشل التهيئة الأساسية: ${initError.message}. يرجى تحديث الصفحة.`, true); if(listPlaceholderEl) {listPlaceholderEl.textContent = "❌ فشل التهيئة"; listPlaceholderEl.style.display = 'block';} if(connectionStatusDotEl) { connectionStatusDotEl.className = 'connection-status-dot disconnected'; connectionStatusDotEl.title = `فشل: ${initError.message}`; }}
          }

        // Start the App
        document.addEventListener('DOMContentLoaded', initializeAppAndFirestore);
        // Cleanup listener
        window.addEventListener('beforeunload', () => { if (unsubscribeItems) { unsubscribeItems(); } });

    </script>

</body>
</html>
